# مخططات تدفقات إنشاء المتاجر في نظام بثواني

## نظرة عامة على عمليات إنشاء المتاجر في النظام

نظام بثواني يدعم طريقتين رئيسيتين لإنشاء المتاجر:

1. **إنشاء متجر بواسطة الأدمن** - إنشاء متجر من لوحة إدارة المشرفين
2. **إنشاء متجر بواسطة المسوق الميداني** - إنشاء متجر سريع من خلال تطبيق المسوق

كل طريقة لها متطلبات وتدفقات مختلفة، وتتطلب موافقات إدارية في بعض الحالات.

---

## 1. تدفق إنشاء متجر بواسطة الأدمن (Admin Store Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء متجر من لوحة الإدارة] --> B[التحقق من صلاحيات المشرف]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]
    B -->|لديه صلاحية| D[إدخال بيانات المتجر الأساسية]

    D --> E[إدخال موقع المتجر]
    E --> F[اختيار الفئة والتصنيف]
    F --> G[إعداد جدول العمل]

    G --> H[إعداد استراتيجية التسعير]
    H --> I[تحميل الصور والشعار]
    I --> J[التحقق من صحة جميع البيانات]

    J -->|صالحة| K[التحقق من عدم تكرار المتجر]
    J -->|غير صالحة| L[خطأ في البيانات]

    K -->|متاح| M[إنشاء سجل المتجر في قاعدة البيانات]
    K -->|مكرر| N[خطأ - المتجر موجود]

    M --> O[ربط المتجر بحسابات GL المالية]
    O --> P{التحقق من نجاح الربط}

    P -->|ناجح| Q[تعيين حالة المتجر كـ "نشط"]
    P -->|فاشل| R[خطأ في إنشاء الحسابات المالية]

    Q --> S[إرسال إشعار للإدارة بالمتجر الجديد]

    L --> T[تصحيح البيانات]
    N --> U[تغيير بيانات المتجر]
    R --> V[إعادة محاولة إنشاء الحسابات]

    T --> J
    U --> K
    V --> O

    style A fill:#e1f5fe
    style S fill:#c8e6c9
    style C fill:#ffcdd2
    style L fill:#ffcdd2
    style N fill:#ffcdd2
    style R fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant DS as خدمة المتاجر
    participant AS as خدمة المحاسبة
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء متجر جديد"
    AD->>A: طلب البيانات الأساسية (الاسم، العنوان، الفئة)

    A->>AD: إدخال بيانات المتجر الأساسية
    AD->>A: طلب موقع المتجر (خط العرض وخط الطول)

    A->>AD: إدخال إحداثيات الموقع
    AD->>A: طلب اختيار الفئة والتصنيف

    A->>AD: اختيار الفئة والتصنيف
    AD->>A: طلب إعداد جدول العمل

    A->>AD: إعداد أوقات العمل والإجازات
    AD->>A: طلب إعداد استراتيجية التسعير

    A->>AD: إعداد استراتيجية التسعير والعمولة
    AD->>A: طلب تحميل الصور والشعار

    A->>AD: تحميل الصور والشعار
    AD->>B: إرسال طلب إنشاء المتجر

    B->>B: التحقق من صلاحيات المشرف
    Note over B: التأكد من أن المشرف لديه صلاحية إنشاء متاجر

    alt لديه صلاحية الإنشاء
        B->>B: التحقق من صحة البيانات المدخلة
        Note over B: التحقق من الحقول المطلوبة والتنسيق

        B->>DB: البحث عن متجر مكرر بنفس البيانات
        DB-->>B: نتيجة البحث

        alt جميع البيانات صالحة وغير مكررة
            B->>DB: إنشاء سجل المتجر الجديد
            DB-->>B: معرف المتجر الجديد

            B->>AS: إنشاء حسابات GL للمتجر (حساب الدائن)
            AS-->>B: تأكيد إنشاء الحسابات

            B->>DB: ربط حسابات GL بسجل المتجر
            B->>DB: تعيين حالة المتجر كـ "نشط"

            B->>NS: إرسال إشعار للإدارة بالمتجر الجديد
            B-->>AD: تأكيد إنشاء المتجر مع البيانات الكاملة

            AD-->>A: عرض رسالة نجاح مع بيانات المتجر الجديد
        else خطأ في البيانات أو تكرار
            B-->>AD: رسالة خطأ مع التفاصيل
            AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else ليس لديه صلاحية الإنشاء
        B-->>AD: رسالة خطأ - غير مصرح لإنشاء متاجر
        AD-->>A: عرض رسالة عدم الصلاحية
    end
```

---

## 2. تدفق إنشاء متجر بواسطة المسوق الميداني (Marketer Store Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء متجر من تطبيق المسوق] --> B[التحقق من هوية المسوق]
    B -->|غير مصدق| C[خطأ - المسوق غير مصدق]

    B -->|مصدق| D[إدخال بيانات المتجر الأساسية]
    D --> E[إدخال موقع المتجر بدقة عالية]

    E --> F[اختيار الفئة والتصنيف]
    F --> G[إدخال بيانات التاجر المالك]

    G --> H[إعداد كلمة مرور مؤقتة للتاجر]
    H --> I[التحقق من صحة جميع البيانات]

    I -->|صالحة| J[التحقق من عدم تكرار البيانات]
    I -->|غير صالحة| K[خطأ في البيانات]

    J -->|متاحة| L[بدء معاملة قاعدة البيانات]
    J -->|مستخدمة| M[خطأ - البيانات مستخدمة]

    L --> N[إنشاء سجل المتجر]
    N --> O[إنشاء سجل التاجر المرتبط]

    O --> P{التحقق من نجاح الإنشاء}
    P -->|ناجح| Q[تعيين حالة المتجر كـ "نشط مغلق"]
    P -->|فاشل| R[خطأ في إنشاء السجلات]

    Q --> S[تعيين حالة التاجر كـ "غير مفعل"]
    S --> T[إرسال إشعار للتاجر بالتفعيل]

    T --> U[إنهاء معاملة قاعدة البيانات]

    K --> V[تصحيح البيانات]
    M --> W[تغيير البيانات]
    R --> X[إعادة المحاولة]

    V --> I
    W --> J
    X --> L

    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style C fill:#ffcdd2
    style K fill:#ffcdd2
    style M fill:#ffcdd2
    style R fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant M as المسوق الميداني
    participant MA as تطبيق المسوق
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant MS as خدمة المسوقين
    participant VS as خدمة المتاجر
    participant VenS as خدمة التجار
    participant NS as خدمة الإشعارات

    M->>MA: فتح تطبيق المسوق واختيار "إنشاء متجر جديد"
    MA->>B: طلب التحقق من هوية المسوق
    B->>MS: التحقق من حالة المسوق وصلاحيته لإنشاء متاجر
    MS-->>B: تأكيد صلاحية المسوق

    alt المسوق مصدق ولديه صلاحية
        MA->>M: طلب البيانات الأساسية للمتجر
        M->>MA: إدخال اسم المتجر والعنوان

        MA->>M: طلب موقع المتجر بدقة عالية
        M->>MA: إدخال إحداثيات الموقع بدقة عالية

        MA->>M: طلب اختيار الفئة والتصنيف
        M->>MA: اختيار الفئة والتصنيف

        MA->>M: طلب بيانات التاجر المالك
        M->>MA: إدخال بيانات التاجر (الاسم، الهاتف، البريد، كلمة المرور المؤقتة)

        MA->>B: إرسال طلب إنشاء المتجر والتاجر

        B->>B: التحقق من صحة جميع البيانات المدخلة
        B->>DB: البحث عن تكرار في البيانات (الهاتف، البريد، الموقع)

        alt جميع البيانات صالحة وغير مكررة
            B->>DB: بدء معاملة قاعدة البيانات

            B->>VS: إنشاء سجل المتجر الجديد
            DB-->>VS: معرف المتجر الجديد

            B->>VenS: إنشاء سجل التاجر المرتبط بالمتجر
            DB-->>VenS: معرف التاجر الجديد

            B->>DB: ربط التاجر بالمتجر
            B->>DB: تعيين حالة المتجر كـ "نشط مغلق" (يحتاج تفعيل)
            B->>DB: تعيين حالة التاجر كـ "غير مفعل" (يحتاج موافقة)

            B->>NS: إرسال إشعار للتاجر بإنشاء الحساب
            B->>NS: إرسال إشعار للإدارة لمراجعة الطلب

            B->>DB: إنهاء معاملة قاعدة البيانات بنجاح
            B-->>MA: تأكيد إنشاء المتجر والتاجر مع بيانات الدخول

            MA-->>M: عرض رسالة نجاح مع تعليمات للتاجر
        else خطأ في البيانات أو تكرار
            B-->>MA: رسالة خطأ مع التفاصيل
            MA-->>M: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else المسوق غير مصدق أو ليس لديه صلاحية
        B-->>MA: رسالة خطأ - المسوق غير مصدق أو ليس لديه صلاحية
        MA-->>M: عرض رسالة عدم الصلاحية
    end
```

---

## 3. تدفق تفعيل متجر تم إنشاؤه بواسطة المسوق (Store Activation Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[مراجعة طلب المتجر الجديد] --> B[التحقق من بيانات المتجر]
    B --> C[التحقق من بيانات التاجر]

    C --> D{التحقق من صحة الموقع}
    D -->|صالح| E[التحقق من الفئة والتصنيف]
    D -->|غير صالح| F[خطأ - موقع غير صالح]

    E -->|صالح| G[مراجعة الصور والشعار]
    E -->|غير صالح| H[خطأ - فئة غير صالحة]

    G -->|مقبولة| I[التحقق من عدم تكرار المتجر]
    G -->|غير مقبولة| J[خطأ - صور غير مناسبة]

    I -->|متاح| K[تفعيل المتجر وجعله متاحاً]
    I -->|مكرر| L[خطأ - المتجر موجود]

    K --> M[تفعيل حساب التاجر]
    M --> N[إرسال إشعار للتاجر بالتفعيل]

    N --> O[إرسال إشعار للمسوق بالموافقة]

    F --> P[رفض الطلب وإشعار المسوق]
    H --> Q[رفض الطلب وإشعار المسوق]
    J --> R[رفض الطلب وإشعار المسوق]
    L --> S[رفض الطلب وإشعار المسوق]

    P --> T[نهاية]
    Q --> T
    R --> T
    S --> T

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style F fill:#ffcdd2
    style H fill:#ffcdd2
    style J fill:#ffcdd2
    style L fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant VS as خدمة المتاجر
    participant VenS as خدمة التجار
    participant MS as خدمة المسوقين
    participant NS as خدمة الإشعارات

    A->>AD: فتح قسم مراجعة المتاجر الجديدة
    AD->>B: طلب قائمة المتاجر في انتظار الموافقة

    B->>DB: جلب المتاجر بحالة "نشط مغلق"
    DB-->>B: قائمة المتاجر في انتظار الموافقة

    B-->>AD: عرض قائمة المتاجر للمراجعة
    A->>AD: اختيار متجر للمراجعة

    AD->>B: طلب تفاصيل المتجر والتاجر المرتبط
    B->>DB: جلب تفاصيل المتجر الكاملة
    B->>DB: جلب تفاصيل التاجر المرتبط

    B-->>AD: عرض تفاصيل المتجر والتاجر للمراجعة

    A->>AD: مراجعة بيانات المتجر (الموقع، الفئة، الصور)
    Note over A: التحقق من دقة الموقع والصور المناسبة

    A->>AD: مراجعة بيانات التاجر (الهوية، الاتصال)
    Note over A: التحقق من صحة بيانات التاجر

    alt الموافقة على الطلب
        A->>AD: تأكيد الموافقة على المتجر والتاجر
        AD->>B: إرسال طلب تفعيل المتجر والتاجر

        B->>DB: تحديث حالة المتجر إلى "نشط مفتوح"
        B->>DB: تحديث حالة التاجر إلى "نشط"

        B->>VS: تفعيل المتجر وجعله متاحاً للعملاء
        B->>VenS: تفعيل حساب التاجر وإرسال بيانات الدخول

        B->>NS: إرسال إشعار للتاجر بتفعيل الحساب والمتجر
        B->>NS: إرسال إشعار للمسوق بالموافقة على طلبه

        B-->>AD: تأكيد تفعيل المتجر والتاجر بنجاح
        AD-->>A: عرض رسالة نجاح التفعيل

    else رفض الطلب
        A->>AD: رفض الطلب مع سبب الرفض
        AD->>B: إرسال طلب رفض المتجر

        B->>DB: تحديث حالة المتجر إلى "مرفوض"
        B->>DB: تحديث حالة التاجر إلى "مرفوض"

        B->>NS: إرسال إشعار للمسوق برفض الطلب مع السبب
        B-->>AD: تأكيد رفض الطلب

        AD-->>A: عرض رسالة تأكيد الرفض
    end
```

---

## مقارنة بين طرق إنشاء المتاجر

| الطريقة | المسؤول عن الإنشاء | الحالة الافتراضية | متطلبات خاصة | آلية الموافقة |
|---------|-------------------|-------------------|---------------|----------------|
| **الأدمن** | مشرف النظام | نشط فوري | صلاحيات إدارية، بيانات كاملة | موافقة تلقائية |
| **المسوق الميداني** | مسوق ميداني مصدق | نشط مغلق (يحتاج تفعيل) | مصادقة المسوق، موقع دقيق، تاجر مرتبط | مراجعة إدارية مطلوبة |

---

## البيانات المطلوبة لإنشاء متجر

### البيانات الأساسية (مشتركة)
- **اسم المتجر** (مطلوب، فريد)
- **العنوان الكامل** (مطلوب)
- **إحداثيات الموقع** (خط العرض وخط الطول - مطلوب)
- **الفئة والتصنيف** (مطلوب)
- **معدل العمولة** (اختياري، افتراضي 0%)

### البيانات التشغيلية
- **جدول العمل** (أوقات العمل والإجازات)
- **استراتيجية التسعير** (طريقة حساب الأسعار)
- **الصور والشعار** (مطلوب للأدمن، اختياري للمسوق)
- **العلامات (Tags)** (اختياري)

### البيانات الإضافية للمسوقين
- **مفتاح عدم التكرار** (Idempotency Key) لمنع التكرار
- **بيانات التاجر المرتبط** (الاسم، الهاتف، البريد، كلمة المرور المؤقتة)
- **هوية المسوق المُنشئ**

---

## آليات الحماية والتحقق

### 1. التحقق من التكرار
- منع إنشاء متاجر بنفس الاسم أو في نفس الموقع
- فحص قاعدة البيانات قبل الإنشاء
- استخدام معاملات قاعدة البيانات لضمان التسلسل

### 2. التحقق من صحة البيانات
- التحقق من تنسيق إحداثيات الموقع
- التحقق من صحة الفئة والتصنيف
- التحقق من قوة كلمات المرور للتجار

### 3. نظام الصلاحيات
- التحقق من صلاحيات المُنشئ
- تسجيل عمليات الإنشاء في سجل التدقيق
- ربط كل متجر بالمُنشئ الخاص به

### 4. إدارة المعاملات
- استخدام معاملات قاعدة البيانات لضمان الاتساق
- إلغاء العملية إذا فشل أي جزء منها
- ضمان عدم ترك بيانات غير مكتملة

### 5. إشعارات النظام
- إرسال إشعارات للأطراف المعنية
- إشعار التاجر بإنشاء الحساب
- إشعار الإدارة بطلبات الموافقة

---

## قواعد البيانات المستخدمة

- **المتاجر**: جدول `deliverystores` في MongoDB
- **التجار**: جدول `vendors` في MongoDB
- **المسوقين**: جدول `marketers` في MongoDB
- **الفئات**: جدول `deliverycategories` في MongoDB
- **الحسابات المالية**: جداول الحسابات في نظام المحاسبة

---

## حالات المتجر الممكنة

| الحالة | الوصف | متاح للعملاء | يحتاج موافقة |
|---------|--------|----------------|----------------|
| **نشط مفتوح** | متجر مفعل ويعمل بشكل طبيعي | ✅ متاح | ❌ لا يحتاج |
| **نشط مغلق** | متجر مفعل لكن مغلق مؤقتاً | ❌ غير متاح | ❌ لا يحتاج |
| **غير نشط** | متجر معطل من قبل الإدارة | ❌ غير متاح | ❌ لا يحتاج |
| **في انتظار الموافقة** | متجر جديد في انتظار مراجعة الإدارة | ❌ غير متاح | ✅ يحتاج موافقة |

هذه المخططات تغطي جميع جوانب عمليات إنشاء المتاجر في نظام بثواني بالتفصيل الكامل.
