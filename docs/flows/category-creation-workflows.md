# مخططات تدفقات إنشاء الفئات في نظام بثواني

## نظرة عامة على عمليات إنشاء الفئات في النظام

نظام بثواني يدعم نوعين رئيسيين من الفئات:

1. **فئات التاجر (Merchant Categories)** - تستخدم في نظام إدارة المنتجات للتجار
2. **فئات التوصيل (Delivery Categories)** - تستخدم في نظام التوصيل والمتاجر

كل نظام له آليات مختلفة لإنشاء وإدارة الفئات مع التركيز على التنظيم والترتيب.

---

## 1. تدفق إنشاء فئة تاجر (Merchant Category Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء فئة تاجر] --> B[التحقق من صلاحيات المشرف]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]

    B -->|لديه صلاحية| D[إدخال بيانات الفئة الأساسية]
    D --> E[إدخال اسم الفئة والوصف]

    E --> F[اختيار نوع الاستخدام]
    F --> G[تحميل صورة الفئة]

    G --> H[التحقق من صحة البيانات]
    H -->|صالحة| I[التحقق من عدم تكرار الـ Slug]

    I -->|متاح| J[إنشاء سجل الفئة في قاعدة البيانات]
    I -->|مكرر| K[خطأ - Slug مستخدم]

    J --> L[تعيين ترتيب تلقائي للفئة]
    L --> M[إرسال إشعار للنظام بالفئة الجديدة]

    C --> N[نهاية]
    K --> O[تغيير الـ Slug]
    O --> I

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style C fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant CS as خدمة الفئات
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء فئة تاجر جديدة"
    AD->>A: طلب بيانات الفئة الأساسية

    A->>AD: إدخال اسم الفئة والوصف
    AD->>A: طلب اختيار نوع الاستخدام (grocery/retail/restaurant)

    A->>AD: اختيار نوع الاستخدام
    AD->>A: طلب تحميل صورة الفئة

    A->>AD: تحميل صورة الفئة
    AD->>B: إرسال طلب إنشاء الفئة

    B->>B: التحقق من صلاحيات المشرف
    Note over B: التأكد من أن المشرف لديه صلاحية إنشاء فئات

    alt لديه صلاحية الإنشاء
        B->>B: التحقق من صحة البيانات المدخلة
        Note over B: التحقق من الحقول المطلوبة ونوع البيانات

        B->>DB: البحث عن Slug مكرر في نفس نوع الاستخدام
        DB-->>B: نتيجة البحث

        alt الـ Slug متاح
            B->>DB: إنشاء سجل الفئة الجديدة
            DB-->>B: معرف الفئة الجديدة

            B->>CS: تعيين ترتيب تلقائي للفئة
            Note over CS: حساب الترتيب بناءً على الفئات الموجودة

            B->>NS: إرسال إشعار للنظام بالفئة الجديدة
            B-->>AD: تأكيد إنشاء الفئة مع البيانات الكاملة

            AD-->>A: عرض رسالة نجاح مع بيانات الفئة الجديدة
        else الـ Slug مستخدم مسبقاً
            B-->>AD: رسالة خطأ - الـ Slug مستخدم مسبقاً
            AD-->>A: عرض رسالة الخطأ وطلب تغيير الـ Slug
        end
    else ليس لديه صلاحية الإنشاء
        B-->>AD: رسالة خطأ - غير مصرح لإنشاء فئات
        AD-->>A: عرض رسالة عدم الصلاحية
    end
```

---

## 2. تدفق إنشاء فئة توصيل (Delivery Category Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء فئة توصيل] --> B[التحقق من صلاحيات المشرف]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]

    B -->|لديه صلاحية| D[إدخال بيانات الفئة الأساسية]
    D --> E[إدخال اسم الفئة والوصف]

    E --> F[اختيار نوع الاستخدام]
    F --> G[تحميل صورة الفئة]

    G --> H[تحديد الفئة الأم (اختياري)]
    H --> I[تحديد ترتيب العرض]

    I --> J[التحقق من صحة البيانات]
    J -->|صالحة| K[التحقق من عدم تكرار الفئة]

    K -->|متاحة| L[بدء معاملة قاعدة البيانات]
    K -->|مكررة| M[خطأ - الفئة موجودة]

    L --> N[إنشاء سجل الفئة]
    N --> O[تحديث ترتيب الفئات المتأثرة]

    O --> P{التحقق من نجاح العملية}
    P -->|ناجح| Q[تعيين حالة الفئة كـ "نشط"]
    P -->|فاشل| R[خطأ في إنشاء الفئة]

    Q --> S[إنهاء معاملة قاعدة البيانات]
    S --> T[إرسال إشعار للنظام بالفئة الجديدة]

    C --> U[نهاية]
    M --> V[تغيير بيانات الفئة]
    R --> W[إعادة المحاولة]

    V --> K
    W --> L

    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style C fill:#ffcdd2
    style M fill:#ffcdd2
    style R fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant CS as خدمة الفئات
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء فئة توصيل جديدة"
    AD->>A: طلب بيانات الفئة الأساسية

    A->>AD: إدخال اسم الفئة والوصف
    AD->>A: طلب اختيار نوع الاستخدام (grocery/retail/restaurant)

    A->>AD: اختيار نوع الاستخدام
    AD->>A: طلب تحميل صورة الفئة

    A->>AD: تحميل صورة الفئة
    AD->>A: طلب تحديد الفئة الأم (اختياري)

    A->>AD: تحديد الفئة الأم أو تركها فارغة
    AD->>A: طلب تحديد ترتيب العرض (اختياري)

    A->>AD: تحديد ترتيب العرض أو تركه تلقائياً
    AD->>B: إرسال طلب إنشاء الفئة

    B->>B: التحقق من صلاحيات المشرف
    Note over B: التأكد من أن المشرف لديه صلاحية إنشاء فئات

    alt لديه صلاحية الإنشاء
        B->>B: التحقق من صحة البيانات المدخلة
        Note over B: التحقق من الحقول المطلوبة ونوع البيانات

        B->>DB: البحث عن فئة مكررة بنفس البيانات
        DB-->>B: نتيجة البحث

        alt جميع البيانات صالحة وغير مكررة
            B->>DB: بدء معاملة قاعدة البيانات

            B->>CS: حساب الترتيب التلقائي إذا لم يحدد
            Note over CS: البحث عن آخر ترتيب في نفس المجموعة

            B->>DB: إنشاء سجل الفئة الجديدة
            DB-->>B: معرف الفئة الجديدة

            alt تم تحديد ترتيب مخصص
                B->>CS: تحديث ترتيب الفئات المتأثرة
                Note over CS: زيادة ترتيب الفئات ذات الترتيب الأعلى
                DB-->>CS: تأكيد تحديث الترتيب
            end

            B->>DB: تعيين حالة الفئة كـ "نشط"
            B->>DB: إنهاء معاملة قاعدة البيانات بنجاح

            B->>NS: إرسال إشعار للنظام بالفئة الجديدة
            B-->>AD: تأكيد إنشاء الفئة مع البيانات الكاملة

            AD-->>A: عرض رسالة نجاح مع بيانات الفئة الجديدة
        else خطأ في البيانات أو تكرار
            B-->>AD: رسالة خطأ مع التفاصيل
            AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else ليس لديه صلاحية الإنشاء
        B-->>AD: رسالة خطأ - غير مصرح لإنشاء فئات
        AD-->>A: عرض رسالة عدم الصلاحية
    end
```

---

## 3. تدفق إعادة ترتيب الفئات (Category Reordering Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إعادة ترتيب الفئات] --> B[التحقق من صلاحيات المشرف]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]

    B -->|لديه صلاحية| D[جلب قائمة الفئات الحالية]
    D --> E[تحديد الفئات لإعادة الترتيب]

    E --> F[تحديد الترتيب الجديد لكل فئة]
    F --> G[التحقق من صحة الترتيب الجديد]

    G -->|صالح| H[بدء معاملة قاعدة البيانات]
    G -->|غير صالح| I[خطأ في الترتيب]

    H --> J[تحديث ترتيب جميع الفئات المتأثرة]
    J --> K{التحقق من نجاح التحديث}

    K -->|ناجح| L[إنهاء معاملة قاعدة البيانات]
    K -->|فاشل| M[خطأ في تحديث الترتيب]

    L --> N[إرسال إشعار للنظام بالتغييرات]

    C --> O[نهاية]
    I --> P[تصحيح الترتيب]
    M --> Q[إعادة المحاولة]

    P --> G
    Q --> H

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style C fill:#ffcdd2
    style I fill:#ffcdd2
    style M fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant CS as خدمة الفئات
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إعادة ترتيب الفئات"
    AD->>A: طلب تحديد نوع الاستخدام والفئة الأم

    A->>AD: تحديد نوع الاستخدام والفئة الأم
    AD->>B: طلب جلب الفئات الحالية مرتبة حسب الترتيب

    B->>DB: جلب الفئات مرتبة حسب sortOrder ثم name
    DB-->>B: قائمة الفئات مع ترتيبها الحالي

    B-->>AD: عرض قائمة الفئات قابلة للسحب والإفلات
    A->>AD: ترتيب الفئات بالسحب والإفلات

    AD->>A: طلب تأكيد الترتيب الجديد
    A->>AD: تأكيد الترتيب الجديد

    AD->>B: إرسال قائمة الترتيب الجديد مع معرفات الفئات

    B->>B: التحقق من صلاحيات المشرف للتعديل
    Note over B: التأكد من أن المشرف لديه صلاحية تعديل الفئات

    alt لديه صلاحية التعديل
        B->>B: التحقق من صحة البيانات المرسلة
        Note over B: التأكد من أن جميع الفئات صالحة وغير مكررة

        B->>DB: بدء معاملة قاعدة البيانات للتحديث بالجملة

        B->>CS: إنشاء عمليات التحديث لكل فئة
        Note over CS: إنشاء bulkWrite operations لتحديث sortOrder

        B->>DB: تنفيذ عمليات التحديث بالجملة
        DB-->>B: نتيجة عمليات التحديث

        B->>DB: إنهاء معاملة قاعدة البيانات بنجاح
        B->>NS: إرسال إشعار للنظام بتغيير ترتيب الفئات

        B-->>AD: تأكيد نجاح إعادة الترتيب
        AD-->>A: عرض رسالة نجاح الترتيب الجديد

    else ليس لديه صلاحية التعديل
        B-->>AD: رسالة خطأ - غير مصرح لتعديل الفئات
        AD-->>A: عرض رسالة عدم الصلاحية

    end
```

---

## مقارنة بين أنواع الفئات في النظام

| نوع الفئة | الاستخدام | نظام الترتيب | الهيكل الهرمي | التحقق من التكرار |
|-----------|-----------|----------------|------------------|-------------------|
| **فئات التاجر** | تصنيف منتجات التجار | ترتيب يدوي | فئات رئيسية فقط | Slug فريد |
| **فئات التوصيل** | تصنيف متاجر التوصيل | ترتيب تلقائي + يدوي | فئات رئيسية وفرعية | اسم فريد ضمن نفس المستوى |

---

## البيانات المطلوبة لإنشاء فئة

### البيانات الأساسية (مشتركة)
- **اسم الفئة** (مطلوب، فريد)
- **نوع الاستخدام** (مطلوب: grocery/retail/restaurant)
- **صورة الفئة** (مطلوب للتوصيل، اختياري للتاجر)

### البيانات الإضافية لفئات التاجر
- **الوصف** (اختياري)
- **Slug** (فريد، يستخدم في الروابط)
- **الفئة الأم** (اختياري)

### البيانات الإضافية لفئات التوصيل
- **الوصف** (اختياري)
- **الفئة الأم** (اختياري - للفئات الفرعية)
- **ترتيب العرض** (اختياري - يتم حسابه تلقائياً)
- **حالة التفعيل** (افتراضي نشط)

---

## آليات الحماية والتحقق

### 1. التحقق من التكرار
- **فئات التاجر**: منع تكرار الـ Slug في نفس نوع الاستخدام
- **فئات التوصيل**: منع تكرار الاسم في نفس المستوى والنوع

### 2. التحقق من صحة البيانات
- التحقق من وجود الحقول المطلوبة
- التحقق من صحة نوع الاستخدام
- التحقق من صحة معرف الفئة الأم إذا وُجدت

### 3. نظام الترتيب الذكي
- **التعيين التلقائي**: حساب الترتيب التالي عند الإنشاء
- **التحديث التلقائي**: تحديث ترتيب الفئات المتأثرة عند الإدراج
- **السحب والإفلات**: إمكانية إعادة ترتيب يدوي بالسحب والإفلات

### 4. إدارة المعاملات
- استخدام معاملات قاعدة البيانات لضمان الاتساق
- إلغاء العملية إذا فشل أي جزء منها
- ضمان عدم ترك بيانات غير مكتملة

### 5. نظام الصلاحيات
- التحقق من صلاحيات المشرف قبل الإنشاء أو التعديل
- تسجيل عمليات الإنشاء والتعديل في سجل التدقيق
- ربط كل فئة بالمُنشئ أو المُعدل

---

## قواعد البيانات المستخدمة

- **فئات التاجر**: جدول `categorymacs` في MongoDB
- **فئات التوصيل**: جدول `deliverycategories` في MongoDB
- **الفئات الفرعية**: ربط ذاتي بـ `parent` في نفس الجدول

---

## حالات الفئة الممكنة

| الحالة | الوصف | متاح للاستخدام | يظهر في القوائم |
|---------|--------|------------------|-------------------|
| **نشط** | فئة مفعلة وتعمل بشكل طبيعي | ✅ متاح | ✅ يظهر |
| **غير نشط** | فئة معطلة مؤقتاً | ❌ غير متاح | ❌ لا يظهر |

---

## مميزات نظام الفئات

### 1. الهيكل الهرمي
- دعم الفئات الرئيسية والفرعية
- إمكانية تصنيف متعدد المستويات
- وراثة الخصائص من الفئة الأم

### 2. نظام الترتيب المتقدم
- ترتيب تلقائي عند الإنشاء
- إمكانية إعادة ترتيب يدوي
- حفظ الترتيب حسب نوع الاستخدام والمستوى

### 3. البحث والتصفية
- بحث بالاسم والوصف
- تصفية حسب نوع الاستخدام
- تصفية حسب الفئة الأم
- ترتيب حسب الترتيب أو الأبجدي

هذه المخططات تغطي جميع جوانب عمليات إنشاء الفئات في نظام بثواني بالتفصيل الكامل.
