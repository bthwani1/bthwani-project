# مخططات تدفقات إضافة المنتجات إلى السلة في نظام بثواني

## نظرة عامة على عمليات إضافة المنتجات إلى السلة في النظام

نظام بثواني يدعم عملية معقدة لإضافة المنتجات إلى السلة مع آليات متقدمة للتحقق من:

1. **صلاحية المتاجر** - التأكد من أن المتاجر متاحة وقريبة من بعضها البعض
2. **دمج العناصر** - إضافة كميات جديدة للعناصر الموجودة مسبقاً
3. **حساب الإجمالي** - تحديث إجمالي السلة تلقائياً
4. **التحقق من الأسعار** - التأكد من صحة الأسعار والكميات

---

## 1. تدفق إضافة منتج واحد إلى السلة (Single Product Addition)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إضافة منتج إلى السلة] --> B[التحقق من هوية المستخدم]
    B -->|غير مصدق| C[خطأ - يجب تسجيل الدخول]

    B -->|مصدق| D[التحقق من صحة بيانات المنتج]
    D -->|غير صالحة| E[خطأ - بيانات المنتج غير صالحة]

    D -->|صالحة| F[البحث عن السلة الحالية للمستخدم]
    F -->|موجودة| G[التحقق من متاجر السلة الحالية]

    G --> H[التحقق من قرب المتجر الجديد]
    H -->|بعيد جداً| I[خطأ - لا يمكن خلط متاجر بعيدة]

    H -->|قريب بما يكفي| J[البحث عن المنتج في السلة]
    J -->|موجود| K[زيادة الكمية الموجودة]

    J -->|غير موجود| L[إضافة المنتج كعنصر جديد]
    K --> M[إعادة حساب إجمالي السلة]

    L --> M
    M --> N[حفظ السلة المحدثة]

    F -->|غير موجودة| O[إنشاء سلة جديدة]
    O --> P[إضافة المنتج كعنصر أول]

    P --> Q[حساب إجمالي السلة الأولي]
    Q --> N

    C --> R[نهاية]
    E --> S[تصحيح بيانات المنتج]
    I --> T[إنشاء سلة جديدة أو اختيار متجر آخر]

    S --> D
    T --> F

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style I fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant US as خدمة المستخدمين
    participant CS as خدمة السلة
    participant DS as خدمة المتاجر
    participant PS as خدمة التسعير

    U->>CA: اختيار منتج وإضافة إلى السلة
    CA->>B: إرسال طلب إضافة منتج إلى السلة

    B->>B: استخراج معرف المستخدم من التوكن
    Note over B: الحصول على Firebase UID من التوكن

    B->>US: البحث عن المستخدم في قاعدة البيانات
    US->>DB: البحث عن المستخدم برقم Firebase UID
    DB-->>US: بيانات المستخدم أو عدم وجود

    alt المستخدم موجود
        B->>B: التحقق من صحة بيانات المنتج المرسلة
        Note over B: التحقق من وجود productId و store و price و quantity

        alt البيانات صالحة
            B->>CS: البحث عن السلة الحالية للمستخدم
            CS->>DB: البحث عن سلة المستخدم
            DB-->>CS: بيانات السلة أو عدم وجود

            alt السلة موجودة
                B->>DS: جلب بيانات المتاجر في السلة والمتجر الجديد
                DS->>DB: جلب مواقع المتاجر
                DB-->>DS: بيانات مواقع المتاجر

                B->>B: حساب المسافة بين المتاجر
                Note over B: حساب أقل مسافة بين المتجر الجديد والمتاجر الموجودة

                alt المسافة مقبولة (أقل من 3 كم)
                    B->>CS: البحث عن المنتج في السلة
                    CS->>DB: البحث عن نفس المنتج بنفس النوع في السلة
                    DB-->>CS: نتيجة البحث

                    alt المنتج موجود في السلة
                        B->>CS: زيادة كمية المنتج الموجود
                        CS->>DB: تحديث كمية المنتج في السلة
                        DB-->>CS: تأكيد التحديث

                        B->>PS: إعادة حساب إجمالي السلة
                        PS-->>B: الإجمالي الجديد

                        B->>DB: حفظ الإجمالي الجديد في السلة
                        DB-->>B: تأكيد الحفظ

                        B-->>CA: إرجاع السلة المحدثة
                        CA-->>U: عرض رسالة نجاح مع السلة المحدثة

                    else المنتج غير موجود في السلة
                        B->>CS: إضافة المنتج كعنصر جديد
                        CS->>DB: إضافة العنصر إلى السلة
                        DB-->>CS: تأكيد الإضافة

                        B->>PS: حساب إجمالي السلة الجديد
                        PS-->>B: الإجمالي الجديد

                        B->>DB: حفظ الإجمالي الجديد في السلة
                        DB-->>B: تأكيد الحفظ

                        B-->>CA: إرجاع السلة المحدثة
                        CA-->>U: عرض رسالة نجاح مع السلة المحدثة
                    end
                else المسافة غير مقبولة
                    B-->>CA: رسالة خطأ - المتجر بعيد جداً عن متاجر السلة
                    CA-->>U: عرض رسالة الخطأ مع خيارات بديلة
                end
            else السلة غير موجودة
                B->>CS: إنشاء سلة جديدة للمستخدم
                CS->>DB: إنشاء سجل سلة جديد
                DB-->>CS: معرف السلة الجديد

                B->>CS: إضافة المنتج كعنصر أول في السلة
                CS->>DB: إضافة العنصر إلى السلة الجديدة
                DB-->>CS: تأكيد الإضافة

                B->>PS: حساب إجمالي السلة الأولي
                PS-->>B: الإجمالي الأولي

                B->>DB: حفظ الإجمالي في السلة
                DB-->>B: تأكيد الحفظ

                B-->>CA: إرجاع السلة الجديدة
                CA-->>U: عرض رسالة نجاح مع السلة الجديدة
            end
        else البيانات غير صالحة
            B-->>CA: رسالة خطأ - بيانات المنتج غير صالحة
            CA-->>U: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else المستخدم غير موجود
        B-->>CA: رسالة خطأ - يجب تسجيل الدخول أولاً
        CA-->>U: عرض رسالة الخطأ وتوجيه لتسجيل الدخول
    end
```

---

## 2. تدفق إضافة عدة منتجات إلى السلة (Multiple Products Addition)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إضافة عدة منتجات إلى السلة] --> B[التحقق من هوية المستخدم]
    B -->|غير مصدق| C[خطأ - يجب تسجيل الدخول]

    B -->|مصدق| D[التحقق من صحة قائمة المنتجات]
    D -->|غير صالحة| E[خطأ - قائمة المنتجات غير صالحة]

    D -->|صالحة| F[استخراج معرفات المتاجر الفريدة]
    F --> G{التحقق من عدد المتاجر}

    G -->|أكثر من متجر واحد| H[خطأ - يجب نفس المتجر للطلب الواحد]
    G -->|متجر واحد فقط| I[البحث عن السلة الحالية]

    I -->|موجودة| J[التحقق من متاجر السلة الحالية]
    I -->|غير موجودة| K[إنشاء سلة جديدة]

    J --> L[التحقق من قرب المتجر الجديد]
    L -->|بعيد جداً| M[خطأ - لا يمكن خلط متاجر بعيدة]

    L -->|قريب بما يكفي| N[معالجة كل منتج في القائمة]
    N --> O{هل المنتج موجود في السلة؟}

    O -->|موجود| P[زيادة الكمية]
    O -->|غير موجود| Q[إضافة كعنصر جديد]

    P --> R[حساب إجمالي السلة]
    Q --> R
    R --> S{هل تم معالجة جميع المنتجات؟}

    S -->|لا| N
    S -->|نعم| T[حفظ السلة المحدثة]

    K --> U[إضافة جميع المنتجات كعناصر جديدة]
    U --> V[حساب إجمالي السلة الأولي]
    V --> T

    C --> W[نهاية]
    E --> X[تصحيح قائمة المنتجات]
    H --> Y[تقسيم الطلب أو اختيار متجر واحد]
    M --> Z[إنشاء سلة جديدة أو اختيار متجر آخر]

    X --> D
    Y --> F
    Z --> I

    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style H fill:#ffcdd2
    style M fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant US as خدمة المستخدمين
    participant CS as خدمة السلة
    participant DS as خدمة المتاجر
    participant PS as خدمة التسعير

    U->>CA: اختيار عدة منتجات وإضافة إلى السلة
    CA->>B: إرسال طلب إضافة قائمة منتجات إلى السلة

    B->>B: استخراج معرف المستخدم من التوكن
    Note over B: الحصول على Firebase UID من التوكن

    B->>US: البحث عن المستخدم في قاعدة البيانات
    US->>DB: البحث عن المستخدم برقم Firebase UID
    DB-->>US: بيانات المستخدم أو عدم وجود

    alt المستخدم موجود
        B->>B: التحقق من صحة قائمة المنتجات المرسلة
        Note over B: التحقق من أن القائمة مصفوفة وكل عنصر يحتوي على البيانات المطلوبة

        alt القائمة صالحة
            B->>B: استخراج معرفات المتاجر الفريدة من القائمة
            Note over B: تجميع معرفات المتاجر بدون تكرار

            alt هناك متجر واحد فقط
                B->>CS: البحث عن السلة الحالية للمستخدم
                CS->>DB: البحث عن سلة المستخدم
                DB-->>CS: بيانات السلة أو عدم وجود

                alt السلة موجودة
                    B->>DS: جلب بيانات المتاجر في السلة والمتجر الجديد
                    DS->>DB: جلب مواقع المتاجر
                    DB-->>DS: بيانات مواقع المتاجر

                    B->>B: حساب المسافة بين المتاجر
                    Note over B: حساب أقل مسافة بين المتجر الجديد والمتاجر الموجودة

                    alt المسافة مقبولة
                        B->>CS: معالجة كل منتج في القائمة على حدة
                        Note over B: حلقة لمعالجة كل منتج في القائمة

                        loop لكل منتج في القائمة
                            B->>CS: البحث عن المنتج في السلة
                            CS->>DB: البحث عن نفس المنتج بنفس النوع
                            DB-->>CS: نتيجة البحث

                            alt المنتج موجود في السلة
                                B->>CS: زيادة كمية المنتج الموجود
                                CS->>DB: تحديث كمية المنتج
                                DB-->>CS: تأكيد التحديث
                            else المنتج غير موجود
                                B->>CS: إضافة المنتج كعنصر جديد
                                CS->>DB: إضافة العنصر إلى السلة
                                DB-->>CS: تأكيد الإضافة
                            end
                        end

                        B->>PS: إعادة حساب إجمالي السلة
                        PS-->>B: الإجمالي الجديد

                        B->>DB: حفظ الإجمالي الجديد في السلة
                        DB-->>B: تأكيد الحفظ

                        B-->>CA: إرجاع السلة المحدثة
                        CA-->>U: عرض رسالة نجاح مع السلة المحدثة

                    else المسافة غير مقبولة
                        B-->>CA: رسالة خطأ - المتجر بعيد جداً
                        CA-->>U: عرض رسالة الخطأ مع خيارات بديلة
                    end
                else السلة غير موجودة
                    B->>CS: إنشاء سلة جديدة وإضافة جميع المنتجات
                    CS->>DB: إنشاء السلة وإضافة العناصر
                    DB-->>CS: تأكيد الإنشاء

                    B->>PS: حساب إجمالي السلة الأولي
                    PS-->>B: الإجمالي الأولي

                    B->>DB: حفظ الإجمالي في السلة
                    DB-->>B: تأكيد الحفظ

                    B-->>CA: إرجاع السلة الجديدة
                    CA-->>U: عرض رسالة نجاح مع السلة الجديدة
                end
            else هناك أكثر من متجر واحد
                B-->>CA: رسالة خطأ - يجب أن تكون جميع المنتجات من نفس المتجر
                CA-->>U: عرض رسالة الخطأ وطلب اختيار متجر واحد
            end
        else القائمة غير صالحة
            B-->>CA: رسالة خطأ - قائمة المنتجات غير صالحة
            CA-->>U: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else المستخدم غير موجود
        B-->>CA: رسالة خطأ - يجب تسجيل الدخول أولاً
        CA-->>U: عرض رسالة الخطأ وتوجيه لتسجيل الدخول
    end
```

---

## 3. تدفق تحديث كمية منتج في السلة (Cart Item Quantity Update)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تحديث كمية منتج في السلة] --> B[التحقق من هوية المستخدم]
    B -->|غير مصدق| C[خطأ - يجب تسجيل الدخول]

    B -->|مصدق| D[البحث عن السلة الحالية]
    D -->|غير موجودة| E[خطأ - السلة غير موجودة]

    D -->|موجودة| F[البحث عن المنتج في السلة]
    F -->|غير موجود| G[خطأ - المنتج غير موجود في السلة]

    F -->|موجود| H[التحقق من صحة الكمية الجديدة]
    H -->|غير صالحة| I[خطأ - الكمية غير صالحة]

    H -->|صالحة| J[تحديث كمية المنتج]
    J --> K[إعادة حساب إجمالي السلة]

    K --> L[حفظ السلة المحدثة]
    L --> M[إرسال إشعار للمستخدم بالتحديث]

    C --> N[نهاية]
    E --> O[إنشاء سلة جديدة أو التحقق من المعرف]
    G --> P[التحقق من معرف المنتج]
    I --> Q[تصحيح الكمية]

    O --> D
    P --> F
    Q --> H

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style G fill:#ffcdd2
    style I fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant US as خدمة المستخدمين
    participant CS as خدمة السلة
    participant PS as خدمة التسعير
    participant NS as خدمة الإشعارات

    U->>CA: تغيير كمية منتج في السلة
    CA->>B: إرسال طلب تحديث كمية منتج في السلة

    B->>B: استخراج معرف المستخدم من التوكن
    Note over B: الحصول على Firebase UID من التوكن

    B->>US: البحث عن المستخدم في قاعدة البيانات
    US->>DB: البحث عن المستخدم برقم Firebase UID
    DB-->>US: بيانات المستخدم أو عدم وجود

    alt المستخدم موجود
        B->>CS: البحث عن السلة الحالية للمستخدم
        CS->>DB: البحث عن سلة المستخدم
        DB-->>CS: بيانات السلة أو عدم وجود

        alt السلة موجودة
            B->>CS: البحث عن المنتج في السلة بالمعرف والنوع
            CS->>DB: البحث عن المنتج بنفس productId و productType
            DB-->>CS: نتيجة البحث

            alt المنتج موجود في السلة
                B->>B: التحقق من صحة الكمية الجديدة
                Note over B: التأكد من أن الكمية أكبر من صفر

                alt الكمية صالحة
                    B->>CS: تحديث كمية المنتج في السلة
                    CS->>DB: تحديث كمية المنتج
                    DB-->>CS: تأكيد التحديث

                    B->>PS: إعادة حساب إجمالي السلة
                    PS-->>B: الإجمالي الجديد

                    B->>DB: حفظ الإجمالي الجديد في السلة
                    DB-->>B: تأكيد الحفظ

                    B->>NS: إرسال إشعار للمستخدم بالتحديث
                    B-->>CA: إرجاع السلة المحدثة

                    CA-->>U: عرض رسالة نجاح مع السلة المحدثة

                else الكمية غير صالحة
                    B-->>CA: رسالة خطأ - الكمية يجب أن تكون أكبر من صفر
                    CA-->>U: عرض رسالة الخطأ وطلب تصحيح الكمية
                end
            else المنتج غير موجود في السلة
                B-->>CA: رسالة خطأ - المنتج غير موجود في السلة
                CA-->>U: عرض رسالة الخطأ وعرض محتويات السلة
            end
        else السلة غير موجودة
            B-->>CA: رسالة خطأ - السلة غير موجودة
            CA-->>U: عرض رسالة الخطأ واقتراح إنشاء سلة جديدة
        end
    else المستخدم غير موجود
        B-->>CA: رسالة خطأ - يجب تسجيل الدخول أولاً
        CA-->>U: عرض رسالة الخطأ وتوجيه لتسجيل الدخول
    end
```

---

## 4. تدفق حذف منتج من السلة (Cart Item Removal)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء حذف منتج من السلة] --> B[التحقق من هوية المستخدم]
    B -->|غير مصدق| C[خطأ - يجب تسجيل الدخول]

    B -->|مصدق| D[البحث عن السلة الحالية]
    D -->|غير موجودة| E[خطأ - السلة غير موجودة]

    D -->|موجودة| F[البحث عن المنتج في السلة]
    F -->|غير موجود| G[خطأ - المنتج غير موجود في السلة]

    F -->|موجود| H[حذف المنتج من السلة]
    H --> I[إعادة حساب إجمالي السلة]

    I --> J{هل السلة أصبحت فارغة؟}
    J -->|نعم| K[حذف السلة بالكامل]

    J -->|لا| L[حفظ السلة المحدثة]
    K --> M[حذف سجل السلة]

    L --> N[إرسال إشعار للمستخدم بالحذف]

    C --> O[نهاية]
    E --> P[إنشاء سلة جديدة أو التحقق من المعرف]
    G --> Q[التحقق من معرف المنتج]

    P --> D
    Q --> F

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style G fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant US as خدمة المستخدمين
    participant CS as خدمة السلة
    participant PS as خدمة التسعير
    participant NS as خدمة الإشعارات

    U->>CA: حذف منتج من السلة
    CA->>B: إرسال طلب حذف منتج من السلة

    B->>B: استخراج معرف المستخدم من التوكن
    Note over B: الحصول على Firebase UID من التوكن

    B->>US: البحث عن المستخدم في قاعدة البيانات
    US->>DB: البحث عن المستخدم برقم Firebase UID
    DB-->>US: بيانات المستخدم أو عدم وجود

    alt المستخدم موجود
        B->>CS: البحث عن السلة الحالية للمستخدم
        CS->>DB: البحث عن سلة المستخدم
        DB-->>CS: بيانات السلة أو عدم وجود

        alt السلة موجودة
            B->>CS: البحث عن المنتج في السلة بالمعرف والنوع
            CS->>DB: البحث عن المنتج بنفس productId و productType
            DB-->>CS: نتيجة البحث

            alt المنتج موجود في السلة
                B->>CS: حذف المنتج من السلة
                CS->>DB: حذف العنصر من السلة
                DB-->>CS: تأكيد الحذف

                B->>PS: إعادة حساب إجمالي السلة
                PS-->>B: الإجمالي الجديد

                B->>B: التحقق من وجود عناصر أخرى في السلة
                Note over B: فحص ما إذا كانت السلة أصبحت فارغة بعد الحذف

                alt السلة تحتوي على عناصر أخرى
                    B->>DB: حفظ الإجمالي الجديد في السلة
                    DB-->>B: تأكيد الحفظ

                    B->>NS: إرسال إشعار للمستخدم بالحذف
                    B-->>CA: إرجاع السلة المحدثة

                    CA-->>U: عرض رسالة نجاح مع السلة المحدثة

                else السلة أصبحت فارغة
                    B->>CS: حذف السلة بالكامل
                    CS->>DB: حذف سجل السلة من قاعدة البيانات
                    DB-->>CS: تأكيد الحذف

                    B->>NS: إرسال إشعار للمستخدم بحذف السلة
                    B-->>CA: إرجاع رسالة حذف السلة

                    CA-->>U: عرض رسالة نجاح حذف السلة بالكامل
                end
            else المنتج غير موجود في السلة
                B-->>CA: رسالة خطأ - المنتج غير موجود في السلة
                CA-->>U: عرض رسالة الخطأ وعرض محتويات السلة
            end
        else السلة غير موجودة
            B-->>CA: رسالة خطأ - السلة غير موجودة
            CA-->>U: عرض رسالة الخطأ واقتراح إنشاء سلة جديدة
        end
    else المستخدم غير موجود
        B-->>CA: رسالة خطأ - يجب تسجيل الدخول أولاً
        CA-->>U: عرض رسالة الخطأ وتوجيه لتسجيل الدخول
    end
```

---

## مقارنة بين عمليات السلة في النظام

| العملية | المدخلات المطلوبة | التحقق الرئيسي | التأثير على السلة | الاستجابة |
|---------|-------------------|----------------|-------------------|-----------|
| **إضافة منتج واحد** | productId, store, price, quantity | مسافة المتاجر، تكرار المنتج | إضافة أو تحديث كمية | السلة المحدثة |
| **إضافة عدة منتجات** | قائمة منتجات من نفس المتجر | نفس المتجر فقط، مسافة المتاجر | إضافة عدة عناصر | السلة المحدثة |
| **تحديث كمية** | productId, productType, quantity | وجود المنتج، كمية صالحة | تحديث كمية واحدة | السلة المحدثة |
| **حذف منتج** | productId, productType | وجود المنتج | حذف عنصر واحد | السلة المحدثة أو محذوفة |

---

## البيانات المطلوبة لإضافة منتج إلى السلة

### البيانات الأساسية (مشتركة)
- **معرف المنتج** (productId - مطلوب)
- **نوع المنتج** (productType - افتراضي deliveryProduct)
- **معرف المتجر** (store - مطلوب)
- **السعر** (price - مطلوب)
- **الكمية** (quantity - مطلوب، أدنى 1)

### البيانات الإضافية
- **اسم المنتج** (name - اختياري، للعرض)
- **صورة المنتج** (image - اختياري، للعرض)
- **ملاحظات** (note - اختياري، للسلة كاملة)

---

## آليات الحماية والتحقق

### 1. التحقق من الهوية والصلاحيات
- **المصادقة**: يجب أن يكون المستخدم مسجل دخوله
- **الترخيص**: يجب أن يكون لدى المستخدم صلاحية تعديل سلته

### 2. التحقق من صحة البيانات
- **المعرفات**: التحقق من صحة ObjectId للمنتج والمتجر
- **الأرقام**: التحقق من صحة السعر والكمية (أكبر من صفر)
- **القائمة**: التحقق من أن قائمة المنتجات مصفوفة صالحة

### 3. التحقق من قيود المتاجر
- **القرب**: لا يمكن خلط متاجر بعيدة عن بعضها (أكثر من 3 كم)
- **التوافق**: يجب أن تكون جميع المنتجات من نفس المتجر للطلب الواحد
- **التوفر**: التحقق من توفر المتجر والمنتج

### 4. منع التلاعب بالبيانات
- **الأسعار**: لا يمكن تعديل الأسعار من جانب العميل
- **الكميات**: تحديد حدود عليا للكميات لمنع الطلبات الكبيرة جداً
- **التكرار**: منع إضافة نفس المنتج عدة مرات (يتم دمج الكميات)

### 5. إدارة حالات الخطأ
- **السلة المفقودة**: إنشاء سلة جديدة تلقائياً
- **المنتج المفقود**: رسالة خطأ واضحة للمستخدم
- **البيانات غير الصالحة**: رسالة خطأ مع تفاصيل التصحيح المطلوب

---

## قواعد البيانات المستخدمة

- **السلة**: جدول `deliverycarts` في MongoDB
- **المستخدمون**: جدول `users` في MongoDB
- **المتاجر**: جدول `deliverystores` في MongoDB
- **المنتجات**: جداول `merchantproducts` و `deliveryproducts` في MongoDB

---

## حالات السلة الممكنة

| الحالة | الوصف | يمكن إضافة منتجات | يمكن إتمام الطلب |
|---------|--------|-------------------|------------------|
| **نشطة** | سلة مفتوحة للتعديل | ✅ يمكن الإضافة | ❌ لا يمكن الإتمام |
| **مكتملة** | سلة تم إتمام طلبها | ❌ لا يمكن الإضافة | ✅ تم الإتمام |

---

## مميزات نظام السلة المتقدمة

### 1. إدارة متعددة المتاجر
- دعم متاجر متعددة في نفس السلة (مع قيود القرب)
- حساب رسوم التوصيل منفصلة لكل متجر
- تجميع الطلبات حسب المتجر للتوصيل

### 2. نظام دمج العناصر الذكي
- دمج الكميات تلقائياً لنفس المنتج
- منع التكرار غير المقصود
- حساب الإجمالي بدقة عالية

### 3. حارس القرب الجغرافي
- حساب المسافات بين المتاجر تلقائياً
- منع خلط متاجر بعيدة عن بعضها
- تحسين تجربة التوصيل والتكلفة

### 4. حساب التسعير الديناميكي
- تطبيق العروض والخصومات على مستوى السلة
- حساب رسوم التوصيل حسب المسافة والمتجر
- تحديث الأسعار في الوقت الفعلي

### 5. إدارة حالات السلة
- تتبع حالة السلة (نشطة/مكتملة/ملغية)
- حفظ تاريخ التعديلات والتغييرات
- إشعارات للمستخدم بالتغييرات المهمة

هذه المخططات تغطي جميع جوانب عمليات إضافة المنتجات إلى السلة في نظام بثواني بالتفصيل الكامل.
