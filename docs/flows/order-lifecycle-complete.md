# دورة حياة الطلب الكاملة في نظام بثواني

## نظرة عامة على دورة حياة الطلب

دورة حياة الطلب في نظام بثواني تمر بعدة مراحل رئيسية مع مشاركة جميع الأطراف المعنية في النظام:

1. **إنشاء الطلب** (Order Creation) - العميل
2. **تأكيد الطلب** (Order Confirmation) - النظام/الإدارة
3. **مراجعة الطلب** (Order Review) - النظام/الإدارة
4. **التحضير** (Order Preparation) - التاجر/المتجر
5. **تعيين السائق** (Driver Assignment) - النظام/الإدارة
6. **التوصيل** (Order Delivery) - السائق
7. **التسليم** (Order Completion) - السائق والعميل
8. **التقييم** (Order Rating) - العميل والسائق

كل مرحلة لها مسؤوليات محددة وأدوار مشاركة مختلفة.

---

## 1. مرحلة إنشاء الطلب (Order Creation)

### الأدوار المشاركة:
- **العميل**: يقوم بإنشاء الطلب من السلة
- **النظام**: يتحقق من صحة البيانات ويحسب التكاليف
- **المحفظة**: يتحقق من رصيد العميل ويحجز المبلغ

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[العميل يختار إتمام الطلب] --> B[التحقق من محتويات السلة]
    B -->|سلة فارغة| C[خطأ - لا يوجد منتجات في السلة]

    B -->|تحتوي على منتجات| D[التحقق من صحة البيانات]
    D -->|بيانات غير صالحة| E[خطأ - بيانات الطلب غير صالحة]

    D -->|بيانات صالحة| F[حساب إجمالي الطلب]
    F --> G[تطبيق العروض والخصومات]

    G --> H[حساب رسوم التوصيل]
    H --> I[التحقق من رصيد المحفظة]

    I -->|رصيد كافي| J[حجز المبلغ في المحفظة]
    I -->|رصيد غير كافي| K[خطأ - رصيد المحفظة غير كافي]

    J --> L[إنشاء سجل الطلب في قاعدة البيانات]
    L --> M[مسح السلة]

    M --> N[إرسال إشعار للعميل بإنشاء الطلب]
    N --> O[إرسال إشعار للإدارة بالطلب الجديد]

    C --> P[نهاية]
    E --> Q[تصحيح البيانات]
    K --> R[شحن المحفظة أو اختيار طريقة دفع أخرى]

    Q --> D
    R --> I

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as العميل
    participant CA as تطبيق العميل
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant WC as خدمة المحفظة
    participant PS as خدمة التسعير
    participant NS as خدمة الإشعارات

    U->>CA: اختيار "إتمام الطلب"
    CA->>B: إرسال طلب إنشاء طلب من السلة

    B->>DB: البحث عن سلة المستخدم
    DB-->>B: بيانات السلة أو عدم وجود

    alt السلة موجودة وتحتوي على منتجات
        B->>B: التحقق من صحة بيانات الطلب
        Note over B: التحقق من العنوان والدفع والمنتجات

        alt البيانات صالحة
            B->>PS: حساب إجمالي الطلب مع العروض
            PS->>DB: جلب العروض النشطة
            DB-->>PS: قائمة العروض النشطة

            PS-->>B: الإجمالي بعد تطبيق العروض

            B->>PS: حساب رسوم التوصيل
            PS->>DB: جلب استراتيجية التسعير
            DB-->>PS: بيانات استراتيجية التسعير

            PS-->>B: رسوم التوصيل محسوبة

            B->>WC: التحقق من رصيد المحفظة
            WC->>DB: جلب رصيد المستخدم
            DB-->>WC: رصيد المستخدم الحالي

            alt الرصيد كافي للدفع
                WC->>DB: حجز المبلغ في المحفظة
                DB-->>WC: تأكيد حجز المبلغ

                B->>DB: إنشاء سجل الطلب الجديد
                DB-->>B: معرف الطلب الجديد

                B->>DB: مسح السلة بعد إنشاء الطلب
                DB-->>B: تأكيد مسح السلة

                B->>NS: إرسال إشعار للعميل بإنشاء الطلب
                B->>NS: إرسال إشعار للإدارة بالطلب الجديد

                B-->>CA: إرجاع تأكيد إنشاء الطلب
                CA-->>U: عرض رسالة نجاح إنشاء الطلب

            else الرصيد غير كافي
                B-->>CA: رسالة خطأ - رصيد المحفظة غير كافي
                CA-->>U: عرض رسالة الخطأ مع خيارات الدفع البديلة
            end
        else البيانات غير صالحة
            B-->>CA: رسالة خطأ - بيانات الطلب غير صالحة
            CA-->>U: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else السلة فارغة أو غير موجودة
        B-->>CA: رسالة خطأ - لا يوجد منتجات في السلة
        CA-->>U: عرض رسالة الخطأ وعرض السلة الفارغة
    end
```

---

## 2. مرحلة تأكيد الطلب (Order Confirmation)

### الأدوار المشاركة:
- **النظام**: يتحقق من صحة الطلب ويؤكده تلقائياً
- **الإدارة**: مراجعة الطلبات المشبوهة أو الكبيرة
- **التاجر**: يتلقى إشعار بالطلب الجديد

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي إشعار بالطلب الجديد] --> B[التحقق من صحة بيانات الطلب]
    B -->|صالح| C[التحقق من قيمة الطلب]

    C -->|طلب عادي| D[تأكيد الطلب تلقائياً]
    C -->|طلب كبير/مشبوه| E[وضع الطلب قيد المراجعة]

    D --> F[تحديث حالة الطلب إلى "قيد المراجعة"]
    E --> G[إرسال إشعار للإدارة بالمراجعة]

    F --> H[إرسال إشعار للتاجر بالطلب الجديد]
    G --> I[انتظار مراجعة الإدارة]

    I --> J{نتيجة المراجعة}
    J -->|موافق عليه| K[تأكيد الطلب وإرسال للتاجر]

    J -->|مرفوض| L[إلغاء الطلب وإعادة المبلغ]

    K --> H
    L --> M[إرسال إشعار للعميل برفض الطلب]

    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style E fill:#ffcdd2
    style L fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant NS as خدمة الإشعارات
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant WC as خدمة المحفظة
    participant VS as خدمة التاجر
    participant AS as خدمة الإدارة

    NS->>B: إشعار بالطلب الجديد (order.created)
    B->>DB: جلب تفاصيل الطلب الكاملة
    DB-->>B: بيانات الطلب مع المستخدم والمنتجات

    B->>B: التحقق من صحة بيانات الطلب
    Note over B: التحقق من وجود المستخدم والمتاجر والمنتجات

    alt البيانات صالحة
        B->>B: تقييم قيمة الطلب وحجم الطلب
        Note over B: فحص ما إذا كان الطلب يحتاج مراجعة إدارية

        alt الطلب عادي (قيمة طبيعية)
            B->>DB: تحديث حالة الطلب إلى "قيد المراجعة"
            DB-->>B: تأكيد التحديث

            B->>VS: إرسال إشعار للتاجر بالطلب الجديد
            VS->>DB: جلب بيانات التاجر المرتبط بالمتجر
            DB-->>VS: بيانات التاجر

            VS-->>B: تأكيد إرسال الإشعار للتاجر
            B-->>CA: إشعار للعميل بتأكيد الطلب

        else الطلب كبير أو مشبوه
            B->>DB: تحديث حالة الطلب إلى "في انتظار التأكيد"
            DB-->>B: تأكيد التحديث

            B->>AS: إرسال إشعار للإدارة بطلب يحتاج مراجعة
            AS-->>B: تأكيد إرسال الإشعار للإدارة

            Note over B: انتظار قرار الإدارة بالموافقة أو الرفض

            alt الإدارة توافق على الطلب
                B->>DB: تحديث حالة الطلب إلى "قيد المراجعة"
                DB-->>B: تأكيد التحديث

                B->>VS: إرسال إشعار للتاجر بالطلب المؤكد
                B-->>CA: إشعار للعميل بتأكيد الطلب بعد المراجعة

            else الإدارة ترفض الطلب
                B->>DB: تحديث حالة الطلب إلى "ملغي"
                DB-->>B: تأكيد التحديث

                B->>WC: إعادة المبلغ لحساب العميل
                WC->>DB: إعادة حجز المبلغ من المحفظة
                DB-->>WC: تأكيد إعادة المبلغ

                B->>NS: إرسال إشعار للعميل برفض الطلب
                B-->>CA: إشعار للعميل برفض الطلب مع السبب
            end
        end
    else البيانات غير صالحة
        B->>DB: تحديث حالة الطلب إلى "ملغي"
        B->>WC: إعادة المبلغ لحساب العميل
        B->>NS: إرسال إشعار للعميل بخطأ في الطلب
    end
```

---

## 3. مرحلة تحضير الطلب (Order Preparation)

### الأدوار المشاركة:
- **التاجر**: يقوم بتحضير المنتجات وتعبئتها
- **النظام**: يتتبع حالة التحضير ويحدث الأوقات المتوقعة
- **السائق**: يتلقى إشعاراً بالطلب الجاهز للاستلام

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي إشعار بالطلب الجديد] --> B[التحقق من توفر المنتجات]
    B -->|غير متوفر| C[إشعار العميل بعدم التوفر]

    B -->|متوفر| D[بدء تحضير المنتجات]
    D --> E[تعبئة وتغليف المنتجات]

    E --> F[تحديث حالة الطلب إلى "قيد التحضير"]
    F --> G[تقدير وقت التحضير]

    G --> H[إرسال إشعار للسائق بالطلب الجاهز]
    H --> I[انتظار وصول السائق]

    I --> J{هل وصل السائق؟}
    J -->|نعم| K[تسليم الطلب للسائق]

    J -->|لا| L[متابعة الانتظار]

    K --> M[تحديث حالة الطلب إلى "جاهز للتوصيل"]

    C --> N[نهاية]
    L --> I

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style C fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant V as التاجر
    participant VA as تطبيق التاجر
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant NS as خدمة الإشعارات
    participant DS as خدمة السائقين

    V->>VA: تلقي إشعار بالطلب الجديد
    VA->>B: طلب تفاصيل الطلب الكاملة

    B->>DB: جلب تفاصيل الطلب مع المنتجات والمستخدم
    DB-->>B: بيانات الطلب الكاملة

    B-->>VA: عرض تفاصيل الطلب للتاجر
    V->>VA: تأكيد استلام الطلب وبدء التحضير

    V->>VA: فحص توفر المنتجات في المخزون
    VA->>B: طلب فحص مخزون المنتجات

    B->>DB: فحص كميات المنتجات في المخزون
    DB-->>B: حالة توفر كل منتج

    alt جميع المنتجات متوفرة
        V->>VA: بدء عملية التحضير والتعبئة
        VA->>B: إرسال طلب تحديث حالة الطلب

        B->>DB: تحديث حالة الطلب إلى "قيد التحضير"
        DB-->>B: تأكيد التحديث

        B->>B: حساب وقت التحضير المتوقع
        Note over B: حساب الوقت بناءً على نوع المنتجات وكميتها

        B->>DB: حفظ وقت التحضير المتوقع في الطلب
        DB-->>B: تأكيد الحفظ

        V->>VA: إكمال عملية التعبئة والتغليف
        VA->>B: إرسال طلب إكمال التحضير

        B->>DB: تحديث حالة الطلب إلى "جاهز للتوصيل"
        DB-->>B: تأكيد التحديث

        B->>DS: إرسال إشعار للسائقين بالطلب الجاهز
        DS-->>B: تأكيد إرسال الإشعار

        B->>NS: إرسال إشعار للعميل ببدء التحضير
        B-->>VA: تأكيد إكمال التحضير

        VA-->>V: عرض رسالة نجاح إكمال التحضير

    else بعض المنتجات غير متوفرة
        V->>VA: تحديد المنتجات غير المتوفرة
        VA->>B: إرسال طلب تحديث حالة الطلب

        B->>DB: تحديث حالة الطلب إلى "في انتظار التوفر"
        DB-->>B: تأكيد التحديث

        B->>NS: إرسال إشعار للعميل بعدم توفر بعض المنتجات
        B-->>VA: تأكيد تحديث حالة الطلب

        VA-->>V: عرض رسالة عدم التوفر مع الخيارات المتاحة
    end
```

---

## 4. مرحلة تعيين السائق (Driver Assignment)

### الأدوار المشاركة:
- **النظام**: يبحث عن سائق متاح وقريب من المتجر
- **الإدارة**: مراجعة طلبات التوصيل الكبيرة أو المعقدة
- **السائق**: يتلقى عرض التوصيل ويقبل أو يرفض

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي إشعار بالطلب الجاهز] --> B[البحث عن سائقين متاحين]
    B --> C[فلترة السائقين حسب الموقع]

    C --> D[إرسال عرض التوصيل للسائقين]
    D --> E[انتظار استجابة السائقين]

    E --> F{هل قبل أحد السائقين؟}
    F -->|نعم| G[تعيين السائق للطلب]

    F -->|لا| H[زيادة نطاق البحث أو انتظار]

    G --> I[تحديث حالة الطلب إلى "معين للسائق"]
    I --> J[إرسال إشعار للسائق بالتأكيد]

    J --> K[إرسال إشعار للتاجر بالسائق المعين]
    K --> L[إرسال إشعار للعميل بالسائق المعين]

    H --> M{هل تم العثور على سائق؟}
    M -->|نعم| D
    M -->|لا| N[إشعار الإدارة بعدم وجود سائقين]

    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style H fill:#ffcdd2
    style N fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant DS as خدمة السائقين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant NS as خدمة الإشعارات
    participant DA as تطبيق السائق
    participant AS as خدمة الإدارة

    DS->>B: طلب تعيين سائق للطلب الجاهز
    B->>DB: جلب تفاصيل الطلب والمتجر
    DB-->>B: بيانات الطلب والموقع

    B->>DS: البحث عن سائقين متاحين قريبين من المتجر
    DS->>DB: جلب السائقين المتاحين في نفس المدينة
    DB-->>DS: قائمة السائقين المتاحين

    DS->>DB: فلترة السائقين حسب الموقع والمسافة
    DB-->>DS: قائمة السائقين المرشحين

    B->>DS: إرسال عرض التوصيل للسائقين المرشحين
    DS->>DA: إرسال إشعار للسائقين بعرض توصيل جديد

    Note over DA: عرض تفاصيل الطلب والمسافة والسعر للسائقين

    alt أحد السائقين يقبل العرض
        DA->>DS: قبول عرض التوصيل
        DS->>B: تأكيد قبول السائق للطلب

        B->>DB: تحديث حالة الطلب إلى "معين للسائق"
        DB-->>B: تأكيد التحديث

        B->>DB: ربط السائق بالطلب
        DB-->>B: تأكيد ربط السائق

        B->>NS: إرسال إشعار للسائق بالتأكيد والتفاصيل
        B->>NS: إرسال إشعار للتاجر بالسائق المعين
        B->>NS: إرسال إشعار للعميل بالسائق المعين

        B-->>DA: تأكيد تعيين السائق للطلب

    else لم يقبل أحد السائقين
        DS->>B: عدم وجود سائقين مقبلين

        B->>B: تقييم حالة البحث عن السائقين
        Note over B: فحص ما إذا كان يمكن توسيع نطاق البحث

        alt يمكن توسيع نطاق البحث
            B->>DS: توسيع نطاق البحث عن السائقين
            DS->>DB: جلب سائقين من مسافات أبعد
            DB-->>DS: قائمة سائقين إضافية

            B->>DS: إرسال عرض التوصيل للسائقين الجدد
            DS->>DA: إرسال إشعار للسائقين الجدد

            Note over DA: انتظار استجابة السائقين الجدد

        else لا يمكن العثور على سائقين
            B->>AS: إرسال إشعار للإدارة بعدم وجود سائقين
            AS-->>B: تأكيد إرسال الإشعار

            B->>NS: إرسال إشعار للتاجر بعدم وجود سائقين
            B-->>VA: إشعار للتاجر بحالة الطلب
        end
    end
```

---

## 5. مرحلة التوصيل (Order Delivery)

### الأدوار المشاركة:
- **السائق**: يقوم بالتوصيل وتتبع الموقع
- **النظام**: يتتبع موقع السائق ويحدث حالة الطلب
- **العميل**: يتلقى تحديثات عن حالة التوصيل

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي تأكيد تعيين الطلب] --> B[التوجه إلى المتجر للاستلام]
    B --> C[الوصول إلى المتجر]

    C --> D[التحقق من الطلب مع التاجر]
    D --> E[استلام الطلب من التاجر]

    E --> F[تحديث حالة الطلب إلى "في الطريق"]
    F --> G[بدء التنقل نحو العميل]

    G --> H[تتبع الموقع في الوقت الفعلي]
    H --> I[الوصول إلى موقع العميل]

    I --> J[الاتصال بالعميل للتأكيد]
    J --> K[تسليم الطلب للعميل]

    K --> L[تحديث حالة الطلب إلى "تم التسليم"]

    style A fill:#e1f5fe
    style L fill:#c8e6c9
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant D as السائق
    participant DA as تطبيق السائق
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant LS as خدمة تتبع الموقع
    participant NS as خدمة الإشعارات
    participant CU as العميل

    D->>DA: تلقي إشعار بتعيين طلب جديد
    DA->>B: طلب تفاصيل الطلب والمسار

    B->>DB: جلب تفاصيل الطلب مع عنوان المتجر والعميل
    DB-->>B: بيانات الطلب الكاملة

    B->>LS: حساب المسار الأمثل من موقع السائق إلى المتجر
    LS-->>B: المسار المحسوب والوقت المتوقع

    B-->>DA: إرسال تفاصيل الطلب والمسار للسائق
    DA-->>D: عرض تفاصيل الطلب والمسار

    D->>DA: بدء التنقل نحو المتجر
    DA->>LS: تتبع موقع السائق في الوقت الفعلي

    D->>DA: الوصول إلى المتجر
    DA->>B: إرسال طلب تأكيد الوصول للمتجر

    B->>DB: تحديث موقع السائق في الطلب
    DB-->>B: تأكيد التحديث

    D->>DA: التحقق من الطلب مع التاجر
    DA->>B: طلب تأكيد استلام الطلب من التاجر

    B->>DB: تحديث حالة الطلب إلى "في الطريق إليك"
    DB-->>B: تأكيد التحديث

    B->>NS: إرسال إشعار للعميل ببدء التوصيل
    B-->>DA: تأكيد استلام الطلب من التاجر

    D->>DA: بدء التنقل نحو العميل
    DA->>LS: متابعة تتبع موقع السائق نحو العميل

    D->>DA: الوصول إلى موقع العميل
    DA->>B: إرسال طلب تأكيد الوصول للعميل

    B->>DB: تحديث موقع السائق في الطلب
    DB-->>B: تأكيد التحديث

    D->>DA: الاتصال بالعميل للتأكيد
    DA->>CU: إشعار العميل بوصول السائق

    D->>DA: تسليم الطلب للعميل والحصول على التوقيع
    DA->>B: إرسال طلب تأكيد التسليم

    B->>DB: تحديث حالة الطلب إلى "تم التسليم"
    DB-->>B: تأكيد التحديث

    B->>DB: حفظ وقت التسليم الفعلي
    DB-->>B: تأكيد الحفظ

    B->>NS: إرسال إشعار للعميل بتسليم الطلب
    B->>NS: إرسال إشعار للتاجر بتسليم الطلب

    B-->>DA: تأكيد تسليم الطلب بنجاح
    DA-->>D: عرض رسالة نجاح التسليم
```

---

## 6. مرحلة إتمام الطلب والتقييم (Order Completion & Rating)

### الأدوار المشاركة:
- **العميل**: يقيم الطلب والسائق والمنتجات
- **السائق**: يقيم العميل والطلب
- **النظام**: يحسب العمولات ويحدث السجلات المالية
- **المحاسبة**: تحديث السجلات المالية والمحاسبية

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تسليم الطلب بنجاح] --> B[تحديث حالة الطلب إلى "تم التسليم"]
    B --> C[إطلاق المبلغ المحجوز في المحفظة]

    C --> D[حساب العمولات والأرباح]
    D --> E[تحديث السجلات المالية]

    E --> F[إرسال طلب تقييم للعميل]
    F --> G[انتظار تقييم العميل]

    G --> H{هل قام العميل بالتقييم؟}
    H -->|نعم| I[حفظ تقييم العميل]

    H -->|لا| J[إرسال تذكير بالتقييم]

    I --> K[إرسال طلب تقييم للسائق]
    K --> L[انتظار تقييم السائق]

    L --> M{هل قام السائق بالتقييم؟}
    M -->|نعم| N[حفظ تقييم السائق]

    M -->|لا| O[إنهاء بدون تقييم السائق]

    N --> P[تحديث تقييمات النظام]
    P --> Q[إرسال إشعار للتاجر بإتمام الطلب]

    style A fill:#e1f5fe
    style Q fill:#c8e6c9
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant WC as خدمة المحفظة
    participant FS as خدمة المحاسبة
    participant NS as خدمة الإشعارات
    participant CU as العميل
    participant D as السائق
    participant V as التاجر

    B->>DB: تحديث حالة الطلب إلى "تم التسليم"
    DB-->>B: تأكيد التحديث

    B->>DB: حفظ وقت التسليم الفعلي في الطلب
    DB-->>B: تأكيد الحفظ

    B->>WC: إطلاق المبلغ المحجوز في المحفظة
    WC->>DB: نقل المبلغ من الحجز إلى المتاح
    DB-->>WC: تأكيد إطلاق المبلغ

    B->>FS: حساب العمولات والأرباح للطلب
    FS->>DB: جلب تفاصيل الطلب والعمولات
    DB-->>FS: بيانات الطلب الكاملة

    FS->>DB: حساب عمولة الشركة والمنصة
    FS->>DB: تحديث السجلات المالية
    DB-->>FS: تأكيد تحديث السجلات

    B->>NS: إرسال إشعار للعميل بتسليم الطلب
    B->>NS: إرسال إشعار للسائق بإتمام الطلب
    B->>NS: إرسال إشعار للتاجر بإتمام الطلب

    B->>CU: إرسال طلب تقييم الطلب والسائق
    Note over CU: عرض نموذج التقييم للعميل

    alt العميل يقوم بالتقييم
        CU->>B: إرسال تقييم الطلب والسائق والمنتجات
        B->>DB: حفظ تقييم العميل في الطلب
        DB-->>B: تأكيد حفظ التقييم

        B->>DB: تحديث تقييم السائق الإجمالي
        DB-->>B: تأكيد تحديث تقييم السائق

        B->>NS: إرسال إشعار للسائق بالتقييم الجديد

    else العميل لا يقوم بالتقييم
        Note over B: انتظار فترة زمنية للتقييم
        B->>CU: إرسال تذكير بالتقييم بعد 24 ساعة
    end

    B->>D: إرسال طلب تقييم العميل والطلب
    Note over D: عرض نموذج تقييم العميل للسائق

    alt السائق يقوم بالتقييم
        D->>B: إرسال تقييم العميل والطلب
        B->>DB: حفظ تقييم السائق في الطلب
        DB-->>B: تأكيد حفظ التقييم

        B->>DB: تحديث تقييم العميل الإجمالي
        DB-->>B: تأكيد تحديث تقييم العميل

    else السائق لا يقوم بالتقييم
        Note over B: انتهاء دورة الطلب بدون تقييم السائق
    end

    B->>V: إرسال إشعار بإتمام الطلب والتقييمات
    B->>DB: تحديث حالة الطلب إلى "مكتمل"

    DB-->>B: تأكيد إتمام الطلب بالكامل
    B-->>CA: إشعار للعميل بإتمام الطلب بالكامل
```

---

## ملخص دورة حياة الطلب الكاملة

### المراحل الرئيسية:
1. **إنشاء الطلب** - العميل ينشئ الطلب من السلة
2. **تأكيد الطلب** - النظام يؤكد الطلب تلقائياً أو يرسله للمراجعة
3. **تحضير الطلب** - التاجر يحضر المنتجات ويغلفها
4. **تعيين السائق** - النظام يبحث عن سائق متاح ويعينه للطلب
5. **التوصيل** - السائق يستلم الطلب ويوصله للعميل
6. **التسليم** - السائق يسلم الطلب ويحصل على التوقيع
7. **التقييم** - العميل والسائق يقيمان بعضهما البعض
8. **إتمام الطلب** - النظام يحسب العمولات ويحدث السجلات المالية

### الأدوار المشاركة في كل مرحلة:

| المرحلة | العميل | التاجر | السائق | الإدارة | النظام |
|---------|---------|---------|---------|----------|---------|
| **إنشاء الطلب** | ✅ ينشئ الطلب | ❌ | ❌ | ❌ | ✅ يتحقق ويحسب |
| **تأكيد الطلب** | ✅ يتلقى التأكيد | ✅ يتلقى الطلب | ❌ | ✅ يراجع إن لزم | ✅ يؤكد تلقائياً |
| **تحضير الطلب** | ✅ يتلقى التحديثات | ✅ يحضر الطلب | ❌ | ❌ | ✅ يتتبع التقدم |
| **تعيين السائق** | ✅ يتلقى إشعار السائق | ✅ يتلقى إشعار السائق | ✅ يقبل العرض | ✅ يراجع إن لزم | ✅ يبحث عن السائق |
| **التوصيل** | ✅ يتلقى التحديثات | ❌ | ✅ يقوم بالتوصيل | ❌ | ✅ يتتبع الموقع |
| **التسليم** | ✅ يستلم الطلب | ✅ يتلقى التأكيد | ✅ يسلم الطلب | ❌ | ✅ يؤكد التسليم |
| **التقييم** | ✅ يقيم الطلب | ✅ يتلقى التقييم | ✅ يقيم العميل | ❌ | ✅ يحسب التقييمات |
| **إتمام الطلب** | ✅ يتلقى التأكيد | ✅ يتلقى التأكيد | ✅ يتلقى التأكيد | ✅ يراجع المالية | ✅ يحسب العمولات |

### آليات الحماية والتحقق:

1. **التحقق من الهوية**: التأكد من هوية جميع الأطراف
2. **التحقق من الصلاحيات**: التأكد من صلاحية كل دور للعملية
3. **التحقق من البيانات**: صحة البيانات في كل مرحلة
4. **التحقق من التكرار**: منع تكرار العمليات غير المقصودة
5. **التحقق من الحالات**: التأكد من الانتقال الصحيح بين الحالات
6. **التحقق من الموقع**: تتبع مواقع السائقين والتأكد من القرب
7. **التحقق من الدفع**: التأكد من صحة عمليات الدفع والحجز

هذه الدورة تغطي جميع جوانب عمليات الطلب في نظام بثواني بالتفصيل الكامل مع جميع الأدوار والمسؤوليات.
