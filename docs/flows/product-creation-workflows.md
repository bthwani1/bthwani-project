# مخططات تدفقات إنشاء المنتجات في نظام بثواني

## نظرة عامة على عمليات إنشاء المنتجات في النظام

نظام بثواني يدعم ثلاثة أنواع رئيسية من المنتجات:

1. **منتجات الكاتالوج (ProductCatalog)** - منتجات عامة في النظام تستخدم كقالب
2. **منتجات التاجر (MerchantProduct)** - منتجات محددة للتاجر في متجره مع أسعار مخصصة
3. **منتجات التوصيل (DeliveryProduct)** - منتجات للمتاجر في نظام التوصيل

كل نظام له آليات مختلفة لإنشاء وإدارة المنتجات مع التركيز على التنظيم والتسعير والتوفر.

---

## 1. تدفق إنشاء منتج كاتالوج (ProductCatalog Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء منتج كاتالوج] --> B[التحقق من صلاحيات المشرف]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]

    B -->|لديه صلاحية| D[إدخال بيانات المنتج الأساسية]
    D --> E[إدخال اسم المنتج والوصف]

    E --> F[اختيار الفئة والتصنيف]
    F --> G[تحديد خصائص المنتج]

    G --> H[تحميل صورة المنتج]
    H --> I[اختيار نوع الاستخدام]

    I --> J[التحقق من صحة البيانات]
    J -->|صالحة| K[التحقق من عدم تكرار المنتج]

    K -->|متاح| L[إنشاء سجل المنتج في قاعدة البيانات]
    K -->|مكرر| M[خطأ - المنتج موجود]

    L --> N[ربط المنتج بالفئة والخصائص]
    N --> O[تعيين حالة المنتج كـ "نشط"]

    O --> P[إرسال إشعار للنظام بالمنتج الجديد]

    C --> Q[نهاية]
    M --> R[تغيير بيانات المنتج]
    R --> K

    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style C fill:#ffcdd2
    style M fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant PS as خدمة المنتجات
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء منتج كاتالوج جديد"
    AD->>A: طلب البيانات الأساسية للمنتج

    A->>AD: إدخال اسم المنتج والوصف
    AD->>A: طلب اختيار الفئة والتصنيف

    A->>AD: اختيار الفئة من قائمة الفئات المتاحة
    AD->>A: طلب تحديد خصائص المنتج (الألوان، الأحجام، إلخ)

    A->>AD: تحديد خصائص المنتج وإضافة قيمها
    AD->>A: طلب تحميل صورة المنتج

    A->>AD: تحميل صورة المنتج
    AD->>A: طلب اختيار نوع الاستخدام (grocery/retail/restaurant)

    A->>AD: اختيار نوع الاستخدام
    AD->>B: إرسال طلب إنشاء المنتج

    B->>B: التحقق من صلاحيات المشرف
    Note over B: التأكد من أن المشرف لديه صلاحية إنشاء منتجات

    alt لديه صلاحية الإنشاء
        B->>B: التحقق من صحة البيانات المدخلة
        Note over B: التحقق من الحقول المطلوبة ونوع البيانات

        B->>DB: البحث عن منتج مكرر بنفس البيانات
        DB-->>B: نتيجة البحث

        alt جميع البيانات صالحة وغير مكررة
            B->>DB: إنشاء سجل المنتج الجديد
            DB-->>B: معرف المنتج الجديد

            B->>PS: ربط المنتج بالفئة والخصائص المحددة
            B->>DB: حفظ العلاقات في قاعدة البيانات

            B->>DB: تعيين حالة المنتج كـ "نشط"
            B->>NS: إرسال إشعار للنظام بالمنتج الجديد

            B-->>AD: تأكيد إنشاء المنتج مع البيانات الكاملة
            AD-->>A: عرض رسالة نجاح مع بيانات المنتج الجديد

        else خطأ في البيانات أو تكرار
            B-->>AD: رسالة خطأ مع التفاصيل
            AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else ليس لديه صلاحية الإنشاء
        B-->>AD: رسالة خطأ - غير مصرح لإنشاء منتجات
        AD-->>A: عرض رسالة عدم الصلاحية
    end
```

---

## 2. تدفق إنشاء منتج تاجر (MerchantProduct Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء منتج تاجر] --> B[التحقق من صلاحيات التاجر]
    B -->|ليس تاجر| C[خطأ - يجب أن تكون تاجر]

    B -->|تاجر مصدق| D[اختيار منتج من الكاتالوج]
    D --> E[التحقق من وجود المنتج في الكاتالوج]

    E -->|موجود| F[إدخال سعر المنتج]
    E -->|غير موجود| G[خطأ - المنتج غير موجود]

    F --> H[تحديد كمية المخزون]
    H --> I[اختيار حالة التوفر]

    I --> J[تحديد القسم الداخلي]
    J --> K[إضافة صورة مخصصة (اختياري)]

    K --> L[إضافة وصف مخصص (اختياري)]
    L --> M[التحقق من صحة البيانات]

    M -->|صالحة| N[التحقق من عدم تكرار المنتج للتاجر]
    M -->|غير صالحة| O[خطأ في البيانات]

    N -->|متاح| P[إنشاء سجل منتج التاجر]
    N -->|مكرر| Q[خطأ - المنتج موجود للتاجر]

    P --> R[ربط المنتج بالقسم والمتجر]
    R --> S[تطبيق التسعير والعروض]

    S --> T[تعيين حالة المنتج كـ "نشط"]

    C --> U[نهاية]
    G --> V[اختيار منتج آخر]
    O --> W[تصحيح البيانات]
    Q --> X[اختيار منتج آخر أو تعديل موجود]

    V --> D
    W --> M
    X --> D

    style A fill:#e1f5fe
    style T fill:#c8e6c9
    style C fill:#ffcdd2
    style G fill:#ffcdd2
    style O fill:#ffcdd2
    style Q fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant V as التاجر
    participant VA as تطبيق التاجر
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant PC as خدمة منتجات الكاتالوج
    participant MP as خدمة منتجات التاجر
    participant PS as خدمة الأقسام
    participant PP as خدمة التسعير والعروض

    V->>VA: فتح تطبيق التاجر واختيار "إضافة منتج"
    VA->>B: طلب قائمة منتجات الكاتالوج المتاحة

    B->>PC: جلب منتجات الكاتالوج حسب نوع الاستخدام والفئة
    PC-->>B: قائمة منتجات الكاتالوج

    B-->>VA: عرض قائمة منتجات الكاتالوج للاختيار
    V->>VA: اختيار منتج من الكاتالوج

    VA->>V: طلب إدخال سعر المنتج
    V->>VA: إدخال سعر المنتج

    VA->>V: طلب تحديد كمية المخزون
    V->>VA: تحديد كمية المخزون

    VA->>V: طلب اختيار حالة التوفر (متاح/غير متاح)
    V->>VA: اختيار حالة التوفر

    VA->>V: طلب اختيار القسم الداخلي للمتجر
    V->>VA: اختيار القسم الداخلي أو إنشاء قسم جديد

    VA->>V: طلب إضافة صورة مخصصة (اختياري)
    V->>VA: إضافة صورة مخصصة أو تخطي

    VA->>V: طلب إضافة وصف مخصص (اختياري)
    V->>VA: إضافة وصف مخصص أو تخطي

    VA->>B: إرسال طلب إنشاء منتج التاجر

    B->>B: التحقق من صلاحيات التاجر وامتلاكه للمتجر
    Note over B: التأكد من أن التاجر مصدق ولديه صلاحية على المتجر

    alt لديه صلاحية الإنشاء
        B->>PC: التحقق من وجود المنتج في الكاتالوج
        PC-->>B: تأكيد وجود المنتج

        B->>DB: البحث عن منتج مكرر لنفس التاجر
        DB-->>B: نتيجة البحث

        alt المنتج متاح وغير مكرر للتاجر
            B->>DB: إنشاء سجل منتج التاجر الجديد
            DB-->>B: معرف منتج التاجر الجديد

            B->>PS: ربط المنتج بالقسم الداخلي المحدد
            PS-->>B: تأكيد ربط القسم

            B->>PP: تطبيق التسعير والعروض النشطة
            PP-->>B: السعر النهائي بعد التطبيق

            B->>DB: تعيين حالة المنتج كـ "نشط"
            B-->>VA: تأكيد إنشاء منتج التاجر مع البيانات الكاملة

            VA-->>V: عرض رسالة نجاح مع بيانات المنتج الجديد
        else خطأ في البيانات أو تكرار
            B-->>VA: رسالة خطأ مع التفاصيل
            VA-->>V: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else ليس لديه صلاحية الإنشاء
        B-->>VA: رسالة خطأ - غير مصرح لإنشاء منتجات
        VA-->>V: عرض رسالة عدم الصلاحية
    end
```

---

## 3. تدفق إنشاء منتج توصيل (DeliveryProduct Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء منتج توصيل] --> B[التحقق من صلاحيات التاجر]
    B -->|ليس تاجر| C[خطأ - يجب أن تكون تاجر]

    B -->|تاجر مصدق| D[إدخال بيانات المنتج الأساسية]
    D --> E[إدخال اسم المنتج والوصف]

    E --> F[تحديد الفئة الفرعية]
    F --> G[اختيار المتجر المرتبط]

    G --> H[تحميل صورة المنتج]
    H --> I[إدخال سعر المنتج]

    I --> J[تحديد كمية المخزون]
    J --> K[اختيار حالة التوفر]

    K --> L[التحقق من صحة البيانات]
    L -->|صالحة| M[التحقق من صحة الفئة والمتجر]

    M -->|صالح| N[إنشاء سجل منتج التوصيل]
    M -->|غير صالح| O[خطأ في الفئة أو المتجر]

    N --> P[ربط المنتج بالفئة والمتجر]
    P --> Q[تعيين حالة المنتج كـ "نشط"]

    Q --> R[إرسال إشعار للنظام بالمنتج الجديد]

    C --> S[نهاية]
    O --> T[تصحيح الفئة أو المتجر]
    T --> M

    style A fill:#e1f5fe
    style R fill:#c8e6c9
    style C fill:#ffcdd2
    style O fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant V as التاجر
    participant VA as تطبيق التاجر
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant SC as خدمة الفئات الفرعية
    participant ST as خدمة المتاجر
    participant DP as خدمة منتجات التوصيل
    participant NS as خدمة الإشعارات

    V->>VA: فتح تطبيق التاجر واختيار "إضافة منتج توصيل"
    VA->>V: طلب البيانات الأساسية للمنتج

    V->>VA: إدخال اسم المنتج والوصف
    VA->>V: طلب اختيار الفئة الفرعية

    V->>VA: اختيار الفئة الفرعية من قائمة الفئات المتاحة
    VA->>V: طلب اختيار المتجر المرتبط

    V->>VA: اختيار المتجر من قائمة المتاجر الخاصة بالتاجر
    VA->>V: طلب تحميل صورة المنتج

    V->>VA: تحميل صورة المنتج
    VA->>V: طلب إدخال سعر المنتج

    V->>VA: إدخال سعر المنتج
    VA->>V: طلب تحديد كمية المخزون

    V->>VA: تحديد كمية المخزون
    VA->>V: طلب اختيار حالة التوفر

    V->>VA: اختيار حالة التوفر (متاح/غير متاح)
    VA->>B: إرسال طلب إنشاء منتج التوصيل

    B->>B: التحقق من صلاحيات التاجر وامتلاكه للمتجر
    Note over B: التأكد من أن التاجر مصدق ولديه صلاحية على المتجر

    alt لديه صلاحية الإنشاء
        B->>B: التحقق من صحة البيانات المدخلة
        Note over B: التحقق من الحقول المطلوبة ونوع البيانات

        B->>SC: التحقق من صحة الفئة الفرعية
        SC-->>B: تأكيد صحة الفئة

        B->>ST: التحقق من صحة المتجر وامتلاكه للتاجر
        ST-->>B: تأكيد صحة المتجر

        alt جميع البيانات صالحة والعلاقات صحيحة
            B->>DB: إنشاء سجل منتج التوصيل الجديد
            DB-->>B: معرف منتج التوصيل الجديد

            B->>DP: ربط المنتج بالفئة الفرعية والمتجر
            B->>DB: حفظ العلاقات في قاعدة البيانات

            B->>DB: تعيين حالة المنتج كـ "نشط"
            B->>NS: إرسال إشعار للنظام بالمنتج الجديد

            B-->>VA: تأكيد إنشاء منتج التوصيل مع البيانات الكاملة
            VA-->>V: عرض رسالة نجاح مع بيانات المنتج الجديد

        else خطأ في البيانات أو العلاقات
            B-->>VA: رسالة خطأ مع التفاصيل
            VA-->>V: عرض رسالة الخطأ وطلب تصحيح البيانات
        end
    else ليس لديه صلاحية الإنشاء
        B-->>VA: رسالة خطأ - غير مصرح لإنشاء منتجات
        VA-->>V: عرض رسالة عدم الصلاحية
    end
```

---

## 4. تدفق إنشاء قسم داخلي تلقائياً (Auto Section Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[إنشاء منتج تاجر بدون قسم محدد] --> B[البحث عن فئة المنتج في الكاتالوج]
    B --> C[استخراج اسم الفئة]

    C --> D[البحث عن قسم بنفس الاسم في المتجر]
    D -->|موجود| E[استخدام القسم الموجود]

    D -->|غير موجود| F[إنشاء قسم جديد تلقائياً]
    F --> G[تعيين اسم القسم من اسم الفئة]

    G --> H[ربط القسم بالمتجر]
    H --> I[تعيين نوع الاستخدام الافتراضي]

    I --> J[حفظ القسم الجديد في قاعدة البيانات]
    J --> K[ربط المنتج بالقسم الجديد]

    E --> K

    style A fill:#e1f5fe
    style K fill:#c8e6c9
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant MP as خدمة منتجات التاجر
    participant PC as خدمة منتجات الكاتالوج
    participant SS as خدمة الأقسام الداخلية
    participant DB as قاعدة البيانات

    MP->>PC: جلب تفاصيل المنتج من الكاتالوج مع الفئة
    PC-->>MP: بيانات المنتج والفئة المرتبطة

    MP->>MP: استخراج اسم الفئة من بيانات المنتج
    Note over MP: الحصول على اسم الفئة لاستخدامه كاسم للقسم

    MP->>SS: البحث عن قسم داخلي بنفس الاسم في المتجر
    SS->>DB: البحث عن قسم بالاسم والمتجر المحددين

    alt القسم موجود
        DB-->>SS: معرف القسم الموجود
        SS-->>MP: إرجاع معرف القسم الموجود
    else القسم غير موجود
        DB-->>SS: عدم وجود قسم بهذا الاسم

        SS->>DB: إنشاء قسم داخلي جديد
        Note over DB: إنشاء قسم بالاسم المستخرج من الفئة

        DB-->>SS: معرف القسم الجديد
        SS-->>MP: إرجاع معرف القسم الجديد
    end

    MP->>DB: ربط منتج التاجر بالقسم المحدد
    DB-->>MP: تأكيد ربط المنتج بالقسم

    MP-->>VA: إكمال عملية إنشاء منتج التاجر
```

---

## مقارنة بين أنواع المنتجات في النظام

| نوع المنتج | الاستخدام | نظام التسعير | نظام المخزون | آلية الربط |
|-------------|-----------|----------------|----------------|-------------|
| **منتجات الكاتالوج** | قوالب عامة | سعر أساسي | لا يوجد مخزون | مرتبط بالفئات والخصائص |
| **منتجات التاجر** | منتجات محددة للتاجر | سعر مخصص + عروض | مخزون محدد | مرتبط بمنتج الكاتالوج والقسم |
| **منتجات التوصيل** | منتجات المتاجر | سعر محدد + عروض | مخزون محدد | مرتبط بالفئة الفرعية والمتجر |

---

## البيانات المطلوبة لإنشاء منتج

### البيانات الأساسية (مشتركة)
- **اسم المنتج** (مطلوب)
- **الوصف** (اختياري)
- **صورة المنتج** (مطلوب للتوصيل، اختياري للتاجر)
- **نوع الاستخدام** (مطلوب: grocery/retail/restaurant)

### البيانات الإضافية لمنتجات الكاتالوج
- **الفئة** (مطلوب)
- **الخصائص** (اختياري - الألوان، الأحجام، إلخ)
- **حالة التفعيل** (افتراضي نشط)

### البيانات الإضافية لمنتجات التاجر
- **المنتج من الكاتالوج** (مطلوب)
- **السعر** (مطلوب)
- **كمية المخزون** (اختياري)
- **حالة التوفر** (افتراضي متاح)
- **القسم الداخلي** (تلقائي أو محدد)
- **صورة مخصصة** (اختياري)
- **وصف مخصص** (اختياري)

### البيانات الإضافية لمنتجات التوصيل
- **الفئة الفرعية** (مطلوب)
- **المتجر** (مطلوب)
- **السعر** (مطلوب)
- **كمية المخزون** (اختياري)
- **حالة التوفر** (افتراضي متاح)
- **حالة التفعيل** (افتراضي نشط)

---

## آليات الحماية والتحقق

### 1. التحقق من الصلاحيات
- **التاجر**: يجب أن يكون مصدقاً ولديه صلاحية على المتجر
- **المشرف**: يجب أن يكون لديه صلاحية إنشاء منتجات في النظام

### 2. التحقق من صحة البيانات
- التحقق من وجود الحقول المطلوبة
- التحقق من صحة المعرفات (ObjectId)
- التحقق من صحة الأسعار والكميات
- التحقق من صحة الصور والروابط

### 3. التحقق من العلاقات
- **منتجات التاجر**: التحقق من وجود المنتج في الكاتالوج
- **منتجات التوصيل**: التحقق من صحة الفئة الفرعية والمتجر
- **الأقسام**: التحقق من تبعية القسم للمتجر الصحيح

### 4. منع التكرار
- **منتجات الكاتالوج**: منع تكرار المنتجات بنفس البيانات
- **منتجات التاجر**: منع تكرار نفس المنتج لنفس التاجر
- **منتجات التوصيل**: منع تكرار نفس المنتج في نفس المتجر

### 5. إدارة المعاملات
- استخدام معاملات قاعدة البيانات لضمان الاتساق
- إلغاء العملية إذا فشل أي جزء منها
- ضمان عدم ترك بيانات غير مكتملة

---

## قواعد البيانات المستخدمة

- **منتجات الكاتالوج**: جدول `productcatalogs` في MongoDB
- **منتجات التاجر**: جدول `merchantproducts` في MongoDB
- **منتجات التوصيل**: جدول `deliveryproducts` في MongoDB
- **الفئات**: جدول `categories` في MongoDB
- **الأقسام الداخلية**: جدول `storesections` في MongoDB

---

## حالات المنتج الممكنة

| الحالة | الوصف | متاح للطلب | يظهر في القوائم |
|---------|--------|-------------|------------------|
| **نشط** | منتج مفعل ومتاح للطلب | ✅ متاح | ✅ يظهر |
| **غير نشط** | منتج معطل مؤقتاً | ❌ غير متاح | ❌ لا يظهر |
| **غير متوفر** | منتج مفعل لكن نفد من المخزون | ❌ غير متاح | ✅ يظهر مع علامة "غير متوفر" |

---

## مميزات نظام المنتجات

### 1. الهيكل الهرمي
- منتجات الكاتالوج كقوالب عامة
- منتجات التاجر مرتبطة بمنتجات الكاتالوج
- منتجات التوصيل مرتبطة بالفئات الفرعية

### 2. نظام التسعير المتقدم
- تسعير أساسي في الكاتالوج
- تسعير مخصص للتاجر مع العروض والخصومات
- تطبيق العروض والحملات الترويجية

### 3. إدارة المخزون
- تتبع كميات المخزون لكل منتج
- تحديد الحد الأدنى والأقصى للطلب
- إشعارات نفاد المخزون

### 4. نظام الفئات والأقسام
- تصنيف هرمي متعدد المستويات
- إنشاء أقسام داخلية تلقائياً حسب الفئات
- ربط المنتجات بالأقسام المناسبة

### 5. البحث والتصفية
- بحث بالاسم والوصف
- تصفية حسب الفئة والقسم
- ترتيب حسب السعر أو التقييم أو الجديد

هذه المخططات تغطي جميع جوانب عمليات إنشاء المنتجات في نظام بثواني بالتفصيل الكامل.
