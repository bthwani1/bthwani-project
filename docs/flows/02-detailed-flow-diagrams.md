# مخططات التدفقات التفصيلية لمنصة بثواني

## نظرة عامة على التدفقات

توثق هذه الوثيقة التدفقات الأساسية والفرعية للمنصة، مع التركيز على تفاعل المستخدمين مع النظام والعمليات الداخلية.

## تدفق التسجيل والمصادقة

### تدفق تسجيل عميل جديد

```mermaid
graph TD
    A[بدء التسجيل] --> B[إدخال رقم الهاتف]
    B --> C[إرسال رمز OTP]
    C --> D[التحقق من الرمز]
    D --> E{رمز صحيح؟}
    E -->|نعم| F[إدخال البيانات الشخصية]
    E -->|لا| G[إعادة إرسال الرمز]
    G --> D
    F --> H[رفع صورة الملف الشخصي]
    H --> I[اختيار الموقع الجغرافي]
    I --> J[إنشاء حساب جديد]
    J --> K[إرسال إشعار ترحيب]
    K --> L[توجيه للصفحة الرئيسية]
```

### تدفق مصادقة السائق

```mermaid
graph TD
    A[طلب الانضمام كسائق] --> B[إدخال البيانات الأساسية]
    B --> C[رفع الوثائق المطلوبة]
    C --> D[التحقق من رقم الهاتف]
    D --> E[مراجعة الوثائق من قبل الإدارة]
    E --> F{الموافقة؟}
    F -->|نعم| G[تفعيل الحساب]
    F -->|لا| H[طلب وثائق إضافية]
    H --> C
    G --> I[إشعار السائق بالتفعيل]
    I --> J[بدء استقبال طلبات التوصيل]
```

## تدفق معالجة الطلبات

### التدفق الكامل لطلب جديد

```mermaid
sequenceDiagram
    participant C as العميل
    participant API as خدمة API
    participant V as التاجر
    participant DS as نظام التوزيع
    participant D as السائق
    participant WS as خدمة الإشعارات

    C->>API: إنشاء طلب جديد
    API->>V: إشعار التاجر بالطلب الجديد
    API->>DS: البحث عن سائق متاح

    alt سائق متاح متوفر
        DS->>D: إرسال عرض توصيل
        D-->>DS: قبول العرض
        DS-->>API: تأكيد تعيين السائق
        API->>V: إشعار التاجر بتعيين السائق
        API->>C: إشعار العميل ببدء التجهيز

        D->>V: التوجه لاستلام الطلب
        V-->>D: تسليم الطلب للسائق
        D->>API: تحديث حالة الطلب (في الطريق)

        D->>C: توصيل الطلب
        C-->>API: تأكيد استلام الطلب
        API->>D: إشعار إتمام التوصيل
        API->>V: إشعار إتمام الطلب
        API->>WS: إرسال تقييم للعميل

    else لا يوجد سائق متاح
        API->>C: إشعار عدم توفر سائق حالياً
        API->>C: إضافة الطلب لقائمة الانتظار
    end
```

### تدفق معالجة الدفع

```mermaid
graph TD
    A[اختيار المنتجات] --> B[مراجعة السلة]
    B --> C[اختيار طريقة الدفع]
    C --> D{نوع الدفع}
    D -->|دفع إلكتروني| E[إعادة توجيه لبوابة الدفع]
    D -->|دفع عند التسليم| F[تأكيد الطلب]
    D -->|محفظة إلكترونية| G[خصم من المحفظة]

    E --> H[إتمام عملية الدفع]
    H --> I{نتيجة الدفع}
    I -->|ناجح| J[تأكيد الطلب وإنشاؤه]
    I -->|فاشل| K[إعادة المحاولة أو اختيار طريقة أخرى]
    K --> C

    J --> L[إشعار التاجر بالطلب الجديد]
    F --> L
    G --> L
```

## تدفق إدارة التجار

### تدفق إضافة منتج جديد

```mermaid
graph TD
    A[تسجيل دخول التاجر] --> B[الدخول للوحة التحكم]
    B --> C[اختيار إضافة منتج جديد]
    C --> D[إدخال تفاصيل المنتج]
    D --> E[رفع صور المنتج]
    E --> F[تحديد الفئة والفئة الفرعية]
    F --> G[إدخال السعر والتخفيضات]
    G --> H[تحديد حالة التوفر]
    H --> I[معاينة المنتج]
    I --> J{تأكيد النشر؟}
    J -->|نعم| K[نشر المنتج]
    J -->|لا| L[تعديل التفاصيل]
    L --> D
    K --> M[إشعار التاجر بالنشر الناجح]
```

### تدفق مراجعة طلبات السحب للتاجر

```mermaid
sequenceDiagram
    participant V as التاجر
    participant API as خدمة API
    participant A as المشرف المالي
    participant Bank as نظام البنك

    V->>API: طلب سحب أموال
    API->>A: إشعار المشرف بطلب السحب
    A->>API: مراجعة الطلب والمبلغ
    alt الموافقة على السحب
        A-->>API: تأكيد السحب
        API->>Bank: تحويل الأموال
        Bank-->>API: تأكيد التحويل
        API->>V: إشعار بنجاح السحب
    else رفض السحب
        A-->>API: رفض السحب مع السبب
        API->>V: إشعار برفض السحب
    end
```

## تدفق إدارة السائقين

### تدفق تعيين طلب توصيل

```mermaid
graph TD
    A[وصول طلب جديد] --> B[تحديد منطقة التوصيل]
    B --> C[البحث عن سائقين متاحين]
    C --> D[ترتيب السائقين حسب القرب]
    D --> E[إرسال إشعار للسائق الأقرب]
    E --> F{رد السائق}
    F -->|قبول| G[تعيين السائق للطلب]
    F -->|رفض| H[الانتقال للسائق التالي]
    H --> E
    G --> I[إشعار العميل والتاجر]
    I --> J[بدء التتبع في الوقت الفعلي]
```

### تدفق تتبع حالة السائق

```mermaid
stateDiagram-v2
    [*] --> متوفر: تسجيل دخول
    متوفر --> مشغول: قبول طلب توصيل
    مشغول --> متوجه_للاستلام: التوجه للتاجر
    متوجه_للاستلام --> في_الطريق: استلام الطلب
    في_الطريق --> مكتمل: توصيل الطلب
    مكتمل --> متوفر: إتمام التوصيل
    متوفر --> غير_متوفر: تسجيل خروج أو إجازة
    غير_متوفر --> متوفر: العودة للعمل
```

## تدفق خدمات التسويق

### تدفق حملة تسويقية جديدة

```mermaid
graph TD
    A[إنشاء حملة جديدة] --> B[تحديد نوع الحملة]
    B --> C[اختيار الجمهور المستهدف]
    C --> D[تحديد الميزانية والمدة]
    D --> E[تصميم محتوى الحملة]
    E --> F[إعداد رسائل الإشعارات]
    F --> G[جدولة مواعيد الإرسال]
    G --> H[معاينة الحملة]
    H --> I{تأكيد الإطلاق؟}
    I -->|نعم| J[تشغيل الحملة]
    I -->|لا| K[تعديل الحملة]
    K --> E
    J --> L[مراقبة أداء الحملة]
    L --> M[تحليل النتائج وإعداد التقارير]
```

### تدفق تجزئة العملاء

```mermaid
graph TD
    A[جمع بيانات العملاء] --> B[تحليل سلوكيات الشراء]
    B --> C[تحديد معايير التجزئة]
    C --> D[إنشاء مجموعات العملاء]
    D --> E[تخصيص العروض حسب المجموعة]
    E --> F[إرسال العروض المخصصة]
    F --> G[قياس استجابة العملاء]
    G --> H[تحسين استراتيجية التجزئة]
    H --> A
```

## تدفق خدمات الدعم الفني

### تدفق معالجة شكوى عميل

```mermaid
sequenceDiagram
    participant C as العميل
    participant S as نظام الدعم
    participant A as موظف الدعم
    participant SM as مدير الدعم

    C->>S: إرسال شكوى أو استفسار
    S->>A: توجيه الشكوى لموظف الدعم
    A->>C: إرسال رد أولي خلال 5 دقائق
    A->>S: تحديث حالة الشكوى

    alt الحل خلال الرد الأول
        A->>C: حل المشكلة
        C-->>S: تقييم الخدمة
    else تحتاج إلى تصعيد
        A->>SM: تصعيد المشكلة
        SM->>A: تعليمات لحل المشكلة
        A->>C: حل المشكلة
        C-->>S: تقييم الخدمة
    end
```

## تدفق النظام المالي (ERP)

### تدفق معالجة الفواتير والمدفوعات

```mermaid
graph TD
    A[إتمام طلب جديد] --> B[إنشاء فاتورة تلقائياً]
    B --> C[إرسال الفاتورة للعميل]
    C --> D[تسجيل الدفع في النظام]
    D --> E{طريقة الدفع}
    E -->|دفع إلكتروني| F[تأكيد الدفع الفوري]
    E -->|دفع عند التسليم| G[تسجيل الدفع اللاحق]
    F --> H[تحديث حالة الطلب]
    G --> H
    H --> I[إنشاء قيود المحاسبة]
    I --> J[تحديث التقارير المالية]
```

### تدفق إغلاق الشهر المالي

```mermaid
graph TD
    A[نهاية الشهر] --> B[جمع جميع المعاملات]
    B --> C[مراجعة الأرصدة والتسويات]
    C --> D[إعداد التقارير المالية]
    D --> E[مراجعة التقارير من قبل الإدارة]
    E --> F{الموافقة على التقارير؟}
    F -->|نعم| G[إغلاق الشهر وأرشفة البيانات]
    F -->|لا| H[تصحيح الأخطاء وإعادة المراجعة]
    H --> C
    G --> I[إعداد التقارير للجهات الخارجية]
```

## تدفق النسخ الاحتياطي والاسترداد

### تدفق النسخ الاحتياطي اليومي

```mermaid
graph TD
    A[موعد النسخ الاحتياطي] --> B[إيقاف الكتابة المؤقتة]
    B --> C[نسخ قاعدة البيانات]
    C --> D[نسخ الملفات والصور]
    D --> E[ضغط البيانات]
    E --> F[تشفير البيانات]
    F --> G[رفع للتخزين السحابي]
    G --> H[التحقق من سلامة النسخة]
    H --> I{النسخة سليمة؟}
    I -->|نعم| J[حذف النسخ القديمة]
    I -->|لا| K[إعادة عملية النسخ]
    K --> C
    J --> L[إشعار الفريق الفني]
```

## تدفق مراقبة الأداء والأمان

### تدفق مراقبة الخوادم

```mermaid
stateDiagram-v2
    [*] --> مراقبة_الحالة: تشغيل النظام
    مراقبة_الحالة --> تحذير_أداء: اكتشاف بطء
    مراقبة_الحالة --> تحذير_أمان: اكتشاف محاولة اختراق
    مراقبة_الحالة --> طبيعي: كل شيء بخير

    تحذير_أداء --> فحص_الموارد: فحص CPU وذاكرة
    فحص_الموارد --> تحسين_الأداء: إذا لزم الأمر
    تحسين_الأداء --> مراقبة_الحالة

    تحذير_أمان --> تحليل_الهجوم: فحص نوع الهجوم
    تحليل_الهجوم --> حجب_المصدر: حجب IP المشبوه
    حجب_المصدر --> توثيق_الحادث: تسجيل التفاصيل
    توثيق_الحادث --> مراقبة_الحالة
```

## تدفق تطوير ونشر المزايا الجديدة

### تدفق تطوير ميزة جديدة

```mermaid
graph LR
    A[تحديد المتطلبات] --> B[تصميم الحلول]
    B --> C[تطوير الميزة]
    C --> D[كتابة الاختبارات]
    D --> E[اختبار الوحدات]
    E --> F[اختبار التكامل]
    F --> G[مراجعة الكود]
    G --> H{الموافقة؟}
    H -->|نعم| I[نشر للاختبار]
    H -->|لا| J[تعديل الكود]
    J --> C
    I --> K[اختبار المستخدمين]
    K --> L{جاهز للإنتاج؟}
    L -->|نعم| M[نشر للإنتاج]
    L -->|لا| N[تطوير إضافي]
    N --> C
    M --> O[مراقبة الأداء والأخطاء]
```

## ملخص التدفقات

| التدفق | الوصف | الوقت المتوقع | المسؤول |
|--------|--------|---------------|----------|
| تسجيل عميل جديد | من الاشتراك للتفعيل | 5-10 دقائق | نظام تلقائي |
| معالجة طلب جديد | من الطلب للتسليم | 30-90 دقيقة | النظام + السائق |
| إضافة منتج جديد | من الإدخال للنشر | 10-15 دقيقة | التاجر + المراجعة |
| حملة تسويقية | من الإنشاء للتنفيذ | 1-3 أيام | فريق التسويق |
| إغلاق شهري مالي | مراجعة وإغلاق الشهر | 3-5 أيام | فريق المالية |
| نسخ احتياطي يومي | نسخ وأرشفة البيانات | 2-4 ساعات | النظام التلقائي |

هذه التدفقات توضح كيفية تفاعل جميع مكونات المنصة مع بعضها البعض لضمان تجربة سلسة وفعالة لجميع المستخدمين.
