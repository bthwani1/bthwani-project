# نظام التقييمات والمراجعات في نظام بثواني

## نظرة عامة على نظام التقييمات

نظام بثواني يحتوي على نظام تقييمات شامل ومتعدد الأبعاد يغطي:

1. **تقييم الطلبات** (Order Ratings) - تقييم العميل للطلب والتاجر والسائق
2. **تقييم السائقين** (Driver Ratings) - تقييم العملاء للسائقين والعكس
3. **تقييم المتاجر** (Store Ratings) - تقييم العملاء للمتاجر والخدمة
4. **تقييم المنتجات** (Product Ratings) - تقييم العملاء للمنتجات والخدمات

كل نظام تقييم له آليات مختلفة للجمع والحساب والعرض.

---

## 1. تدفق تقييم الطلب (Order Rating Flow)

### الأدوار المشاركة:
- **العميل**: يقوم بالتقييم بعد تسليم الطلب
- **السائق**: يتلقى التقييم ويمكنه الرد عليه
- **التاجر**: يتلقى تقييم الطلب والمنتجات
- **النظام**: يحسب التقييمات ويحدث الإحصائيات

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تسليم الطلب بنجاح] --> B[إرسال طلب تقييم للعميل]
    B --> C[انتظار تقييم العميل]

    C --> D{هل قام العميل بالتقييم؟}
    D -->|نعم| E[جمع بيانات التقييم]

    E --> F[تقييم الشركة 1-5 نجوم]
    F --> G[تقييم الطلب نفسه 1-5 نجوم]

    G --> H[تقييم السائق 1-5 نجوم]
    H --> I[إضافة تعليقات إضافية]

    I --> J[حفظ تقييم الطلب في قاعدة البيانات]
    J --> K[تحديث إحصائيات السائق]

    K --> L[تحديث إحصائيات التاجر]
    L --> M[تحديث إحصائيات المنتجات]

    M --> N[إرسال إشعار للسائق بالتقييم الجديد]
    N --> O[إرسال إشعار للتاجر بالتقييم]

    D -->|لا| P[إرسال تذكير بالتقييم بعد 24 ساعة]
    P --> Q[إرسال تذكير ثاني بعد 72 ساعة]

    Q --> R[إغلاق فرصة التقييم بعد أسبوع]

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style P fill:#ffcdd2
    style Q fill:#ffcdd2
    style R fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant O as الطلب
    participant NS as خدمة الإشعارات
    participant CU as العميل
    participant DB as قاعدة البيانات
    participant RS as خدمة التقييمات
    participant DS as خدمة السائقين
    participant VS as خدمة التجار

    O->>NS: إرسال طلب تقييم للعميل بعد التسليم
    Note over NS: عرض نموذج التقييم للعميل في التطبيق

    CU->>O: إرسال تقييم الطلب (company, order, driver, comments)
    O->>DB: حفظ تقييم الطلب في سجل الطلب

    O->>RS: تحديث إحصائيات السائق الإجمالية
    RS->>DB: جلب جميع تقييمات السائق
    DB-->>RS: قائمة تقييمات السائق

    RS->>DB: حساب متوسط تقييم السائق الجديد
    DB-->>RS: متوسط التقييم المحدث

    RS->>DB: تحديث متوسط تقييم السائق في سجله
    DB-->>RS: تأكيد التحديث

    O->>RS: تحديث إحصائيات التاجر الإجمالية
    RS->>DB: جلب جميع تقييمات التاجر من الطلبات
    DB-->>RS: قائمة تقييمات التاجر

    RS->>DB: حساب متوسط تقييم التاجر الجديد
    DB-->>RS: متوسط التقييم المحدث

    RS->>DB: تحديث متوسط تقييم التاجر في سجله
    DB-->>RS: تأكيد التحديث

    O->>RS: تحديث إحصائيات المنتجات الإجمالية
    RS->>DB: جلب تقييمات المنتجات في الطلب
    DB-->>RS: قائمة تقييمات المنتجات

    RS->>DB: تحديث متوسط تقييم كل منتج
    DB-->>RS: تأكيد تحديث التقييمات

    O->>NS: إرسال إشعار للسائق بالتقييم الجديد
    O->>NS: إرسال إشعار للتاجر بالتقييم الجديد

    NS-->>DS: إشعار السائق بالتقييم
    NS-->>VS: إشعار التاجر بالتقييم
```

---

## 2. تدفق تقييم السائق (Driver Rating Flow)

### الأدوار المشاركة:
- **العميل**: يقيم السائق بناءً على الخدمة المقدمة
- **السائق**: يتلقى التقييم ويمكنه الرد عليه
- **النظام**: يحسب متوسط التقييم ويحدث الترتيب

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي تقييم من عميل] --> B[التحقق من صحة التقييم]
    B -->|غير صالح| C[رفض التقييم وإشعار العميل]

    B -->|صالح| D[إضافة التقييم إلى سجل السائق]
    D --> E[إعادة حساب متوسط التقييم]

    E --> F[تحديث ترتيب السائق في النظام]
    F --> G[التحقق من الحد الأدنى للتقييم]

    G --> H{هل متوسط التقييم أقل من الحد؟}
    H -->|نعم| I[تعليق حساب السائق مؤقتاً]

    H -->|لا| J[الحفاظ على حالة السائق النشطة]

    I --> K[إرسال إشعار للسائق بالتعليق]
    J --> L[إرسال إشعار للسائق بالتقييم]

    C --> M[نهاية]
    K --> N[نهاية]
    L --> O[نهاية]

    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style C fill:#ffcdd2
    style I fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant CU as العميل
    participant O as الطلب
    participant DB as قاعدة البيانات
    participant DS as خدمة السائقين
    participant NS as خدمة الإشعارات
    participant RS as خدمة التقييمات

    CU->>O: إرسال تقييم السائق (1-5 نجوم)
    O->>DB: حفظ تقييم السائق في سجل الطلب

    O->>RS: إضافة التقييم إلى سجل السائق
    RS->>DB: جلب جميع تقييمات السائق السابقة
    DB-->>RS: قائمة تقييمات السائق

    RS->>RS: حساب متوسط التقييم الجديد
    Note over RS: حساب متوسط التقييم مع الأوزان إن وجدت

    RS->>DB: تحديث متوسط تقييم السائق في سجله
    DB-->>RS: تأكيد التحديث

    RS->>RS: تحديث ترتيب السائق حسب التقييم
    Note over RS: ترتيب السائقين حسب متوسط التقييم

    RS->>DB: حفظ الترتيب الجديد للسائق
    DB-->>RS: تأكيد حفظ الترتيب

    RS->>RS: التحقق من الحد الأدنى للتقييم
    Note over RS: فحص ما إذا كان متوسط التقييم أقل من 3 نجوم

    alt متوسط التقييم أقل من الحد الأدنى
        RS->>DS: تعليق حساب السائق مؤقتاً
        DS->>DB: تحديث حالة السائق إلى "معلق"
        DB-->>DS: تأكيد التعليق

        RS->>NS: إرسال إشعار للسائق بالتعليق والسبب
        RS->>NS: إرسال إشعار للإدارة بتعليق السائق

    else متوسط التقييم طبيعي
        RS->>NS: إرسال إشعار للسائق بالتقييم الجديد
        NS-->>DS: إشعار السائق بالتقييم الإيجابي
    end
```

---

## 3. تدفق تقييم المتجر (Store Rating Flow)

### الأدوار المشاركة:
- **العميل**: يقيم المتجر بناءً على الجودة والخدمة
- **التاجر**: يتلقى التقييم ويمكنه الرد عليه
- **النظام**: يحسب متوسط التقييم ويؤثر على ترتيب المتجر

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي تقييم من عميل] --> B[التحقق من شراء سابق من المتجر]
    B -->|لا يوجد شراء سابق| C[رفض التقييم]

    B -->|يوجد شراء سابق| D[إضافة التقييم إلى سجل المتجر]
    D --> E[إعادة حساب متوسط التقييم]

    E --> F[تحديث ترتيب المتجر في البحث]
    F --> G[التحقق من جودة التقييم]

    G --> H{هل متوسط التقييم ممتاز؟}
    H -->|نعم| I[إضافة شارة "ممتاز" للمتجر]

    H -->|لا| J{هل متوسط التقييم منخفض؟}
    J -->|نعم| K[إضافة تنبيه للإدارة]

    J -->|لا| L[الحفاظ على الحالة العادية]

    I --> M[إرسال إشعار للتاجر بالتقييم الممتاز]
    K --> N[إرسال إشعار للإدارة بالتقييم المنخفض]
    L --> O[إرسال إشعار للتاجر بالتقييم العادي]

    C --> P[نهاية]

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style C fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant CU as العميل
    participant O as الطلب
    participant DB as قاعدة البيانات
    participant VS as خدمة المتاجر
    participant RS as خدمة التقييمات
    participant NS as خدمة الإشعارات

    CU->>O: إرسال تقييم المتجر (1-5 نجوم)
    O->>DB: حفظ تقييم المتجر في سجل الطلب

    O->>RS: التحقق من وجود طلبات سابقة للعميل في هذا المتجر
    RS->>DB: البحث عن طلبات سابقة للعميل في نفس المتجر
    DB-->>RS: نتيجة البحث عن الطلبات السابقة

    alt يوجد طلب سابق مؤكد
        O->>RS: إضافة التقييم إلى سجل المتجر
        RS->>DB: جلب جميع تقييمات المتجر السابقة
        DB-->>RS: قائمة تقييمات المتجر

        RS->>RS: حساب متوسط التقييم الجديد
        Note over RS: حساب متوسط التقييم مع الترجيح

        RS->>DB: تحديث متوسط تقييم المتجر في سجله
        DB-->>RS: تأكيد التحديث

        RS->>RS: تحديث ترتيب المتجر في نتائج البحث
        Note over RS: ترتيب المتاجر حسب متوسط التقييم وعدد التقييمات

        RS->>DB: حفظ الترتيب الجديد للمتجر
        DB-->>RS: تأكيد حفظ الترتيب

        RS->>RS: تقييم جودة متوسط التقييم
        Note over RS: فحص ما إذا كان المتجر يستحق شارة ممتاز أو تنبيه

        alt متوسط التقييم ممتاز (أكثر من 4.5)
            RS->>DB: إضافة شارة "ممتاز" للمتجر
            DB-->>RS: تأكيد إضافة الشارة

            RS->>NS: إرسال إشعار للتاجر بالحصول على شارة ممتاز

        else متوسط التقييم منخفض (أقل من 3)
            RS->>NS: إرسال إشعار للإدارة بالتقييم المنخفض للمتجر

        else متوسط التقييم عادي
            RS->>NS: إرسال إشعار للتاجر بالتقييم الجديد
        end

        NS-->>VS: إشعار التاجر بالتقييم

    else لا يوجد طلب سابق مؤكد
        O->>CU: رسالة خطأ - يمكن التقييم فقط بعد شراء سابق
        CU-->>O: عرض رسالة عدم السماح بالتقييم
    end
```

---

## 4. تدفق تقييم المنتجات (Product Rating Flow)

### الأدوار المشاركة:
- **العميل**: يقيم المنتجات التي اشتراها
- **التاجر**: يتلقى تقييم منتجاته
- **النظام**: يحسب متوسط تقييم المنتج ويؤثر على ترتيبه

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي تقييم منتج من عميل] --> B[التحقق من شراء المنتج سابقاً]
    B -->|لا يوجد شراء سابق| C[رفض التقييم]

    B -->|يوجد شراء سابق| D[إضافة التقييم إلى سجل المنتج]
    D --> E[إعادة حساب متوسط التقييم]

    E --> F[تحديث ترتيب المنتج في الفئة]
    F --> G[التحقق من شعبية المنتج]

    G --> H{هل المنتج من أكثر المنتجات تقييماً؟}
    H -->|نعم| I[إضافة المنتج إلى قائمة "الأكثر تقييماً"]

    H -->|لا| J{هل المنتج يحتاج تحسين؟}
    J -->|نعم| K[إضافة تنبيه للتاجر]

    J -->|لا| L[الحفاظ على الحالة العادية]

    I --> M[إرسال إشعار للتاجر بالمنتج الشائع]
    K --> N[إرسال إشعار للتاجر بتحسين المنتج]
    L --> O[إرسال إشعار للتاجر بالتقييم]

    C --> P[نهاية]

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style C fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant CU as العميل
    participant P as المنتج
    participant O as الطلب
    participant DB as قاعدة البيانات
    participant RS as خدمة التقييمات
    participant VS as خدمة التجار
    participant NS as خدمة الإشعارات

    CU->>P: إرسال تقييم المنتج (1-5 نجوم + تعليق)
    P->>DB: حفظ تقييم المنتج في سجل المنتج

    P->>RS: التحقق من وجود طلب سابق للعميل يحتوي على هذا المنتج
    RS->>DB: البحث عن طلبات سابقة تحتوي على نفس المنتج
    DB-->>RS: نتيجة البحث عن الطلبات السابقة

    alt يوجد طلب سابق مؤكد
        P->>RS: إضافة التقييم إلى سجل المنتج
        RS->>DB: جلب جميع تقييمات المنتج السابقة
        DB-->>RS: قائمة تقييمات المنتج

        RS->>RS: حساب متوسط التقييم الجديد
        Note over RS: حساب متوسط التقييم مع الترجيح حسب الجودة

        RS->>DB: تحديث متوسط تقييم المنتج في سجله
        DB-->>RS: تأكيد التحديث

        RS->>RS: تحديث ترتيب المنتج في فئته
        Note over RS: ترتيب المنتجات حسب متوسط التقييم وعدد التقييمات

        RS->>DB: حفظ الترتيب الجديد للمنتج
        DB-->>RS: تأكيد حفظ الترتيب

        RS->>RS: تقييم شعبية المنتج وأدائه
        Note over RS: فحص ما إذا كان المنتج من أفضل المنتجات أو يحتاج تحسين

        alt المنتج من أفضل المنتجات تقييماً
            RS->>DB: إضافة المنتج إلى قائمة "الأكثر تقييماً"
            DB-->>RS: تأكيد إضافة القائمة

            RS->>NS: إرسال إشعار للتاجر بالمنتج الشائع والمميز

        else المنتج يحتاج تحسين (تقييم منخفض مستمر)
            RS->>NS: إرسال إشعار للتاجر بضرورة تحسين المنتج

        else المنتج عادي
            RS->>NS: إرسال إشعار للتاجر بالتقييم الجديد
        end

        NS-->>VS: إشعار التاجر بالتقييم

    else لا يوجد طلب سابق مؤكد
        P->>CU: رسالة خطأ - يمكن التقييم فقط بعد شراء المنتج
        CU-->>P: عرض رسالة عدم السماح بالتقييم
    end
```

---

## 5. تدفق استجابة السائق على التقييم (Driver Response Flow)

### الأدوار المشاركة:
- **السائق**: يرد على التقييمات السلبية أو يشكر على التقييمات الإيجابية
- **العميل**: يتلقى رد السائق على تقييمه
- **النظام**: يتوسط في التواصل ويحفظ السجل

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تلقي تقييم من عميل] --> B[إرسال إشعار للسائق بالتقييم]
    B --> C[مراجعة السائق للتقييم]

    C --> D{هل التقييم سلبي؟}
    D -->|نعم| E[كتابة رد مهذب وتوضيحي]

    D -->|لا| F{هل التقييم إيجابي؟}
    F -->|نعم| G[كتابة رد شكر وتقدير]

    F -->|محايد| H[اختيار عدم الرد أو رد مختصر]

    E --> I[إرسال الرد للعميل]
    G --> J[إرسال الرد للعميل]
    H --> K[اختيار عدم الرد]

    I --> L[حفظ الرد في سجل التقييم]
    J --> M[حفظ الرد في سجل التقييم]

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant CU as العميل
    participant O as الطلب
    participant NS as خدمة الإشعارات
    participant D as السائق
    participant DA as تطبيق السائق
    participant DB as قاعدة البيانات

    CU->>O: إرسال تقييم السائق
    O->>NS: إرسال إشعار للسائق بالتقييم الجديد

    NS-->>DA: عرض التقييم للسائق في التطبيق
    D->>DA: مراجعة تفاصيل التقييم والتعليقات

    D->>DA: اتخاذ قرار بالرد على التقييم
    DA->>D: طلب كتابة رد على التقييم

    alt السائق يختار الرد
        D->>DA: كتابة رد مهذب وتوضيحي
        DA->>O: إرسال الرد على التقييم

        O->>DB: حفظ رد السائق في سجل التقييم
        DB-->>O: تأكيد حفظ الرد

        O->>NS: إرسال إشعار للعميل برد السائق
        NS-->>CU: عرض رد السائق للعميل

        O->>DB: تحديث حالة التقييم إلى "تم الرد عليه"
        DB-->>O: تأكيد تحديث الحالة

    else السائق يختار عدم الرد
        Note over DA: عدم وجود رد من السائق
        DA-->>D: عرض خيار عدم الرد

        O->>DB: تحديث حالة التقييم إلى "تم مراجعته"
        DB-->>O: تأكيد تحديث الحالة
    end
```

---

## مقارنة بين أنواع التقييمات في النظام

| نوع التقييم | المقيم | المقيم عليه | التأثير | آلية الحساب | فترة التقييم |
|-------------|--------|-------------|---------|-------------|---------------|
| **تقييم الطلب** | العميل | الطلب + السائق + التاجر | متعدد | متوسط مرجح | بعد التسليم مباشرة |
| **تقييم السائق** | العميل | السائق فقط | ترتيب السائقين | متوسط بسيط | بعد التسليم مباشرة |
| **تقييم المتجر** | العميل | المتجر فقط | ترتيب المتاجر | متوسط مرجح | بعد الشراء فقط |
| **تقييم المنتج** | العميل | المنتج فقط | ترتيب المنتجات | متوسط بسيط | بعد الشراء فقط |

---

## البيانات المطلوبة لكل نوع تقييم

### تقييم الطلب (Order Rating)
- **تقييم الشركة** (company: 1-5 نجوم)
- **تقييم الطلب** (order: 1-5 نجوم)
- **تقييم السائق** (driver: 1-5 نجوم)
- **تعليقات إضافية** (comments: نص اختياري)
- **معرف الطلب** (orderId: مطلوب للتحقق)

### تقييم المتجر (Store Rating)
- **تقييم المتجر** (rating: 1-5 نجوم)
- **تعليقات إضافية** (comments: نص اختياري)
- **معرف الطلب** (orderId: مطلوب للتحقق من الشراء السابق)

### تقييم المنتج (Product Rating)
- **تقييم المنتج** (rating: 1-5 نجوم)
- **تعليقات إضافية** (comments: نص اختياري)
- **معرف الطلب** (orderId: مطلوب للتحقق من الشراء السابق)

---

## آليات الحماية والتحقق

### 1. التحقق من الأهلية للتقييم
- **الطلبات**: يمكن التقييم فقط بعد تسليم الطلب بنجاح
- **المتاجر**: يمكن التقييم فقط بعد شراء سابق من المتجر
- **المنتجات**: يمكن التقييم فقط بعد شراء المنتج الفعلي

### 2. منع التقييمات المكررة
- **مرة واحدة فقط**: لا يمكن تقييم نفس الطلب أكثر من مرة
- **تحديد زمني**: فترة محدودة للتقييم (أسبوع بعد التسليم)
- **تتبع المستخدمين**: منع تقييم نفس الشخص لنفس العنصر عدة مرات

### 3. جودة التقييمات
- **الحد الأدنى**: رفض التقييمات بدون نجوم أو تعليقات فارغة
- **الحد الأقصى**: تحديد طول التعليقات لمنع السبام
- **الكشف عن السبام**: فلترة التعليقات المكررة أو المشبوهة

### 4. نظام الاستجابات
- **ردود السائقين**: إمكانية رد السائقين على التقييمات السلبية
- **ردود التجار**: إمكانية رد التجار على تقييمات منتجاتهم
- **حفظ السجل**: حفظ جميع الردود والتواصل في السجل

### 5. حساب متوسط التقييمات
- **الترجيح**: إعطاء وزن أكبر للتقييمات الأحدث
- **التصفية**: استبعاد التقييمات المشبوهة أو المزيفة
- **التحديث الفوري**: تحديث متوسط التقييم فوراً بعد كل تقييم جديد

---

## قواعد البيانات المستخدمة

- **تقييمات الطلبات**: مخزنة في جدول `orders` مع حقل `rating`
- **تقييمات السائقين**: محدثة في جدول `drivers` مع حقل `rating`
- **تقييمات المتاجر**: محدثة في جدول `deliverystores` مع حقل `rating`
- **تقييمات المنتجات**: محدثة في جداول `merchantproducts` و `deliveryproducts`
- **سجل التقييمات**: جدول منفصل للحفاظ على تاريخ جميع التقييمات

---

## حالات التقييم الممكنة

| الحالة | الوصف | يمكن التعديل | يظهر للآخرين |
|---------|--------|---------------|----------------|
| **جديد** | تقييم تم إرساله حديثاً | ✅ يمكن التعديل | ❌ لا يظهر بعد |
| **مؤكد** | تقييم تم التحقق منه | ❌ لا يمكن التعديل | ✅ يظهر للآخرين |
| **مرفوض** | تقييم تم رفضه بسبب مخالفات | ❌ لا يمكن التعديل | ❌ لا يظهر |
| **تم الرد عليه** | تقييم تم الرد عليه من قبل المقيم عليه | ❌ لا يمكن التعديل | ✅ يظهر مع الرد |

---

## مميزات نظام التقييمات المتقدمة

### 1. تقييم متعدد الأبعاد
- تقييم الطلب ككل مع تقييم منفصل للسائق والتاجر
- تقييم المنتجات بشكل فردي
- تقييم المتاجر بناءً على تجارب الشراء السابقة

### 2. نظام الترجيح الذكي
- إعطاء وزن أكبر للتقييمات الأحدث
- استبعاد التقييمات المشبوهة أو المزيفة
- حساب متوسط مرجح حسب جودة التقييم

### 3. نظام الاستجابات والتواصل
- إمكانية رد السائقين والتجار على التقييمات
- حفظ سجل كامل للتواصل بين الأطراف
- تحسين الخدمة بناءً على التعليقات

### 4. تأثير على الترتيب والعرض
- ترتيب السائقين حسب متوسط التقييم
- ترتيب المتاجر حسب متوسط التقييم وعدد التقييمات
- ترتيب المنتجات حسب متوسط التقييم

### 5. نظام التنبيهات والمراقبة
- تنبيهات للسائقين عند انخفاض متوسط التقييم
- تنبيهات للتجار عند تلقي تقييمات سلبية
- مراقبة جودة الخدمة وتحسينها المستمر

هذه المخططات تغطي جميع جوانب نظام التقييمات والمراجعات في نظام بثواني بالتفصيل الكامل.
