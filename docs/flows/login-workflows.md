# مخططات تدفقات تسجيل الدخول لجميع الشخصيات في نظام بثواني

## نظرة عامة على الشخصيات في النظام

نظام بثواني يدعم خمس شخصيات رئيسية:
1. **العملاء** (Customers) - المستخدمون النهائيون الذين يطلبون المنتجات والخدمات
2. **التجار** (Vendors/Merchants) - أصحاب المتاجر الذين يبيعون منتجاتهم عبر المنصة
3. **السائقين** (Drivers) - مقدمو خدمات التوصيل
4. **مسوقي الميدان** (Field Marketers) - فريق التسويق الميداني
5. **المشرفين** (Admins) - مدراء النظام والمشرفين

---

## 1. تدفق تسجيل دخول العميل (Customer Login Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تسجيل الدخول] --> B{اختيار طريقة المصادقة}
    B -->|رقم الهاتف| C[إدخال رقم الهاتف]
    B -->|البريد الإلكتروني| D[إدخال البريد الإلكتروني]
    B -->|Google/Firebase| E[تسجيل دخول بحساب Google]

    C --> F[إرسال رمز OTP عبر SMS]
    D --> G[إرسال رمز OTP عبر البريد الإلكتروني]
    E --> H[التحقق من صحة توكن Firebase]

    F --> I[إدخال رمز OTP]
    G --> I
    H --> J{التحقق من صحة التوكن}

    I --> K{التحقق من صحة OTP}
    K -->|صالح| L[إنشاء JWT Tokens]
    K -->|غير صالح| M[خطأ في OTP]

    J -->|صالح| L
    J -->|غير صالح| N[خطأ في التوكن]

    L --> O[حفظ Refresh Token]
    O --> P[تسجيل دخول ناجح]

    M --> Q[إعادة إرسال OTP]
    N --> R[إعادة محاولة التسجيل]

    Q --> C
    R --> A

    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style M fill:#ffcdd2
    style N fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant FB as خدمة Firebase
    participant B as الخادم الخلفي (Backend)
    participant DB as قاعدة البيانات
    participant OTP as خدمة OTP

    U->>CA: إدخال رقم الهاتف/البريد الإلكتروني
    CA->>OTP: طلب إرسال رمز OTP
    OTP->>U: إرسال رمز OTP عبر SMS/البريد الإلكتروني

    U->>CA: إدخال رمز OTP
    CA->>FB: التحقق من التوكن (اختياري)
    FB-->>CA: تأكيد صحة التوكن

    CA->>B: إرسال طلب المصادقة مع OTP
    B->>DB: التحقق من وجود المستخدم
    DB-->>B: بيانات المستخدم

    B->>OTP: التحقق من صحة رمز OTP
    OTP-->>B: تأكيد صحة OTP

    B->>B: إنشاء JWT Access Token
    B->>B: إنشاء JWT Refresh Token
    B->>DB: حفظ Refresh Token

    B-->>CA: إرجاع التوكنات
    CA-->>U: تسجيل دخول ناجح

    Note over CA,DB: يتم تخزين Access Token محلياً<br/>واستخدام Refresh Token للحصول على توكن جديد
```

---

## 2. تدفق تسجيل دخول التاجر (Vendor Login Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تسجيل دخول التاجر] --> B[إدخال رقم الهاتف]
    B --> C[التحقق من وجود التاجر في النظام]

    C -->|موجود| D[إرسال رمز OTP عبر SMS]
    C -->|غير موجود| E[رسالة خطأ - التاجر غير مسجل]

    D --> F[إدخال رمز OTP]
    F --> G{التحقق من صحة OTP}

    G -->|صالح| H[التحقق من حالة التاجر]
    G -->|غير صالح| I[خطأ في OTP]

    H -->|نشط| J[إنشاء JWT Tokens خاصة بالتاجر]
    H -->|معطل| K[رسالة خطأ - الحساب معطل]
    H -->|في انتظار الموافقة| L[رسالة خطأ - الحساب في انتظار الموافقة]

    J --> M[حفظ Refresh Token]
    M --> N[تسجيل دخول ناجح]

    I --> O[إعادة إرسال OTP]
    K --> P[الاتصال بالدعم]
    L --> Q[انتظار الموافقة]

    O --> D
    P --> R[نهاية]
    Q --> S[نهاية]

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style E fill:#ffcdd2
    style K fill:#ffcdd2
    style L fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant V as التاجر
    participant VA as تطبيق التاجر
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant OTP as خدمة OTP
    participant VS as خدمة التجار

    V->>VA: إدخال رقم الهاتف
    VA->>B: طلب التحقق من وجود التاجر
    B->>DB: البحث عن التاجر برقم الهاتف
    DB-->>B: بيانات التاجر أو عدم وجود

    alt التاجر موجود
        B->>OTP: إرسال رمز OTP عبر SMS
        OTP->>V: إرسال رمز OTP

        V->>VA: إدخال رمز OTP
        VA->>B: إرسال OTP للتحقق
        B->>OTP: التحقق من صحة OTP
        OTP-->>B: تأكيد صحة OTP

        B->>VS: التحقق من حالة التاجر (نشط/معطل/في انتظار الموافقة)
        VS-->>B: حالة التاجر

        alt الحساب نشط
            B->>B: إنشاء JWT Tokens خاصة بالتاجر
            B->>DB: حفظ Refresh Token
            B-->>VA: إرجاع التوكنات
            VA-->>V: تسجيل دخول ناجح
        else الحساب معطل أو في انتظار الموافقة
            B-->>VA: رسالة خطأ مع السبب
            VA-->>V: عرض رسالة الخطأ
        end
    else التاجر غير موجود
        B-->>VA: رسالة خطأ - التاجر غير مسجل
        VA-->>V: عرض رسالة الخطأ
    end
```

---

## 3. تدفق تسجيل دخول السائق (Driver Login Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تسجيل دخول السائق] --> B[إدخال رقم الهاتف]
    B --> C[التحقق من وجود السائق في النظام]

    C -->|موجود| D[التحقق من حالة السائق]
    C -->|غير موجود| E[رسالة خطأ - السائق غير مسجل]

    D -->|نشط| F[إرسال رمز OTP عبر SMS]
    D -->|معطل| G[رسالة خطأ - الحساب معطل]
    D -->|في انتظار الموافقة| H[رسالة خطأ - الحساب في انتظار الموافقة]

    F --> I[إدخال رمز OTP]
    I --> J{التحقق من صحة OTP}

    J -->|صالح| K[إنشاء JWT Tokens خاصة بالسائق]
    J -->|غير صالح| L[خطأ في OTP]

    K --> M[حفظ Refresh Token]
    M --> N[تسجيل دخول ناجح]

    L --> O[إعادة إرسال OTP]
    O --> I

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style E fill:#ffcdd2
    style G fill:#ffcdd2
    style H fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant D as السائق
    participant DA as تطبيق السائق
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant OTP as خدمة OTP
    participant DS as خدمة السائقين

    D->>DA: إدخال رقم الهاتف
    DA->>B: طلب التحقق من وجود السائق
    B->>DB: البحث عن السائق برقم الهاتف
    DB-->>B: بيانات السائق أو عدم وجود

    alt السائق موجود
        B->>DS: التحقق من حالة السائق (نشط/معطل/في انتظار الموافقة)
        DS-->>B: حالة السائق

        alt الحساب نشط
            B->>OTP: إرسال رمز OTP عبر SMS
            OTP->>D: إرسال رمز OTP

            D->>DA: إدخال رمز OTP
            DA->>B: إرسال OTP للتحقق
            B->>OTP: التحقق من صحة OTP
            OTP-->>B: تأكيد صحة OTP

            B->>B: إنشاء JWT Tokens خاصة بالسائق
            B->>DB: حفظ Refresh Token
            B-->>DA: إرجاع التوكنات
            DA-->>D: تسجيل دخول ناجح
        else الحساب معطل أو في انتظار الموافقة
            B-->>DA: رسالة خطأ مع السبب
            DA-->>D: عرض رسالة الخطأ
        end
    else السائق غير موجود
        B-->>DA: رسالة خطأ - السائق غير مسجل
        DA-->>D: عرض رسالة الخطأ
    end
```

---

## 4. تدفق تسجيل دخول المسوق الميداني (Field Marketer Login Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تسجيل دخول المسوق] --> B[إدخال رقم الهاتف]
    B --> C[التحقق من وجود المسوق في النظام]

    C -->|موجود| D[إرسال رمز OTP عبر SMS]
    C -->|غير موجود| E[رسالة خطأ - المسوق غير مسجل]

    D --> F[إدخال رمز OTP]
    F --> G{التحقق من صحة OTP}

    G -->|صالح| H[التحقق من حالة المسوق]
    G -->|غير صالح| I[خطأ في OTP]

    H -->|نشط| J[إنشاء JWT Tokens خاصة بالمسوق]
    H -->|معطل| K[رسالة خطأ - الحساب معطل]

    J --> L[حفظ Refresh Token]
    L --> M[تسجيل دخول ناجح]

    I --> N[إعادة إرسال OTP]
    N --> F

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style E fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant M as المسوق الميداني
    participant MA as تطبيق المسوق
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant OTP as خدمة OTP
    participant MS as خدمة المسوقين

    M->>MA: إدخال رقم الهاتف
    MA->>B: طلب التحقق من وجود المسوق
    B->>DB: البحث عن المسوق برقم الهاتف
    DB-->>B: بيانات المسوق أو عدم وجود

    alt المسوق موجود
        B->>OTP: إرسال رمز OTP عبر SMS
        OTP->>M: إرسال رمز OTP

        M->>MA: إدخال رمز OTP
        MA->>B: إرسال OTP للتحقق
        B->>OTP: التحقق من صحة OTP
        OTP-->>B: تأكيد صحة OTP

        B->>MS: التحقق من حالة المسوق (نشط/معطل)
        MS-->>B: حالة المسوق

        alt الحساب نشط
            B->>B: إنشاء JWT Tokens خاصة بالمسوق
            B->>DB: حفظ Refresh Token
            B-->>MA: إرجاع التوكنات
            MA-->>M: تسجيل دخول ناجح
        else الحساب معطل
            B-->>MA: رسالة خطأ - الحساب معطل
            MA-->>M: عرض رسالة الخطأ
        end
    else المسوق غير موجود
        B-->>MA: رسالة خطأ - المسوق غير مسجل
        MA-->>M: عرض رسالة الخطأ
    end
```

---

## 5. تدفق تسجيل دخول المشرف (Admin Login Workflow)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء تسجيل دخول المشرف] --> B[إدخال اسم المستخدم]
    B --> C[إدخال كلمة المرور]

    C --> D{التحقق من صحة البيانات}

    D -->|صالح| E[التحقق من حالة الحماية من المحاولات المتكررة]
    D -->|غير صالح| F[خطأ في البيانات]

    E -->|لا يوجد حظر| G[التحقق من وجود المشرف في النظام]
    E -->|يوجد حظر| H[رسالة خطأ - تم حظر الحساب مؤقتاً]

    G -->|موجود| I[التحقق من كلمة المرور]
    G -->|غير موجود| J[خطأ - اسم المستخدم غير صحيح]

    I -->|صالحة| K[التحقق من حالة المشرف]
    I -->|غير صالحة| L[خطأ في كلمة المرور]

    K -->|نشط| M[إنشاء JWT Tokens خاصة بالمشرف]
    K -->|معطل| N[رسالة خطأ - الحساب معطل]

    M --> O[حفظ Refresh Token]
    O --> P[تسجيل دخول ناجح]

    F --> Q[إعادة المحاولة]
    H --> R[انتظار انتهاء مدة الحظر]
    J --> S[إعادة المحاولة]
    L --> T[إعادة المحاولة مع تسجيل المحاولة الفاشلة]

    Q --> A
    R --> A
    S --> A
    T --> A

    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style F fill:#ffcdd2
    style H fill:#ffcdd2
    style J fill:#ffcdd2
    style L fill:#ffcdd2
    style N fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant BF as خدمة الحماية من المحاولات المتكررة
    participant AS as خدمة المشرفين

    A->>AD: إدخال اسم المستخدم وكلمة المرور
    AD->>B: طلب المصادقة
    B->>BF: التحقق من حالة الحماية من المحاولات المتكررة
    BF-->>B: حالة الحماية (محظور/غير محظور)

    alt لا يوجد حظر
        B->>DB: البحث عن المشرف باسم المستخدم
        DB-->>B: بيانات المشرف أو عدم وجود

        alt المشرف موجود
            B->>B: التحقق من كلمة المرور
            Note over B: استخدام bcrypt للمقارنة الآمنة

            alt كلمة المرور صحيحة
                B->>AS: التحقق من حالة المشرف (نشط/معطل)
                AS-->>B: حالة المشرف

                alt الحساب نشط
                    B->>B: إنشاء JWT Tokens خاصة بالمشرف
                    B->>DB: حفظ Refresh Token وتسجيل وقت آخر دخول
                    B->>BF: إعادة تعيين عداد المحاولات الفاشلة
                    B-->>AD: إرجاع التوكنات
                    AD-->>A: تسجيل دخول ناجح
                else الحساب معطل
                    B-->>AD: رسالة خطأ - الحساب معطل
                    AD-->>A: عرض رسالة الخطأ
                end
            else كلمة المرور غير صحيحة
                B->>BF: تسجيل محاولة فاشلة
                B-->>AD: رسالة خطأ في كلمة المرور
                AD-->>A: عرض رسالة الخطأ
            end
        else المشرف غير موجود
            B->>BF: تسجيل محاولة فاشلة
            B-->>AD: رسالة خطأ - اسم المستخدم غير صحيح
            AD-->>A: عرض رسالة الخطأ
        end
    else يوجد حظر مؤقت
        B-->>AD: رسالة خطأ - تم حظر الحساب مؤقتاً
        AD-->>A: عرض رسالة الخطأ مع وقت انتهاء الحظر
    end
```

---

## مقارنة بين طرق تسجيل الدخول لكل شخصية

| الشخصية | طريقة المصادقة | آلية التحقق | الحماية الإضافية | حالات الحظر |
|---------|---------------|-------------|-------------------|-------------|
| **العميل** | رقم الهاتف/البريد الإلكتروني + OTP | Firebase Auth + JWT | حماية من الـ Rate Limiting | لا توجد حماية من المحاولات المتكررة |
| **التاجر** | رقم الهاتف + OTP | JWT خاص بالتاجر | التحقق من حالة الحساب | لا توجد حماية من المحاولات المتكررة |
| **السائق** | رقم الهاتف + OTP | JWT خاص بالسائق | التحقق من حالة الحساب والمركبة | لا توجد حماية من المحاولات المتكررة |
| **المسوق** | رقم الهاتف + OTP | JWT خاص بالمسوق | التحقق من حالة الحساب | لا توجد حماية من المحاولات المتكررة |
| **المشرف** | اسم المستخدم + كلمة مرور | JWT خاص بالمشرف | حماية من المحاولات المتكررة (Brute Force) | حظر مؤقت بعد عدة محاولات فاشلة |

---

## آليات الحماية المشتركة في جميع التدفقات

### 1. JWT Token Management
- **Access Token**: قصير الأمد (15 دقيقة) للوصول للموارد
- **Refresh Token**: طويل الأمد (7 أيام) للحصول على Access Token جديد
- **Token Blacklisting**: إمكانية إلغاء التوكنات عند تسجيل الخروج

### 2. Rate Limiting
- تحديد عدد الطلبات المسموحة لكل عنوان IP
- حماية من الهجمات الآلية والـ DDoS

### 3. Input Validation
- التحقق من صحة البيانات المدخلة
- حماية من هجمات الحقن (Injection Attacks)

### 4. Audit Logging
- تسجيل جميع عمليات تسجيل الدخول والمحاولات الفاشلة
- تتبع العمليات المشبوهة

### 5. Session Management
- انتهاء صلاحية الجلسات تلقائياً
- إمكانية تسجيل الخروج من جميع الأجهزة

---

## ملاحظات تقنية مهمة

### متغيرات البيئة المطلوبة
```bash
# JWT Configuration
JWT_ACCESS_SECRET=your-access-secret
JWT_REFRESH_SECRET=your-refresh-secret
JWT_ACCESS_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d

# Firebase Configuration
FIREBASE_PROJECT_ID=your-project-id
FB_CHECK_REVOKED=true

# SMS/Email Services
SMS_API_KEY=your-sms-api-key
SMTP_HOST=smtp.gmail.com
```

### قواعد البيانات المستخدمة
- **المستخدمون**: جدول `users` في MongoDB
- **التجار**: جدول `vendors` في MongoDB
- **السائقون**: جدول `drivers` في MongoDB
- **المسوقون**: جدول `marketers` في MongoDB
- **المشرفون**: جدول `admin_users` في MongoDB
- **رموز OTP**: جدول `otps` في MongoDB
- **المحاولات الفاشلة**: جدول `login_attempts` في MongoDB

### الاختلافات الرئيسية بين الشخصيات
1. **العملاء**: أكثر مرونة في طرق المصادقة (رقم الهاتف/البريد الإلكتروني/Google)
2. **التجار والسائقين**: يتطلبون موافقة إدارية قبل التفعيل
3. **المسوقين**: مرتبطون بنظام التسويق والعمولات
4. **المشرفين**: نظام مصادقة تقليدي مع حماية متقدمة من المحاولات المتكررة

هذه المخططات تغطي جميع جوانب عمليات تسجيل الدخول في نظام بثواني بالتفصيل الكامل.
