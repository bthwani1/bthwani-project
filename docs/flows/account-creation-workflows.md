# مخططات تدفقات إنشاء الحسابات لجميع الشخصيات في نظام بثواني

## نظرة عامة على عمليات إنشاء الحسابات في النظام

نظام بثواني يدعم خمس شخصيات رئيسية مع آليات مختلفة لإنشاء الحسابات:

1. **العملاء** (Customers) - إنشاء تلقائي عبر Firebase Authentication
2. **التجار** (Vendors/Merchants) - إنشاء يدوي من قبل الأدمن مع موافقة إدارية
3. **السائقين** (Drivers) - إنشاء يدوي من قبل الأدمن مع بيانات السيارة
4. **مسوقي الميدان** (Field Marketers) - إنشاء يدوي من قبل الأدمن مع خطط العمولة
5. **المشرفين** (Admins) - إنشاء يدوي من قبل مشرفين آخرين مع نظام الصلاحيات

---

## 1. تدفق إنشاء حساب العميل (Customer Account Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[بدء إنشاء الحساب] --> B{اختيار طريقة المصادقة}

    B -->|تطبيق الهاتف| C[فتح تطبيق العميل]
    B -->|الموقع الإلكتروني| D[زيارة موقع بثواني]
    B -->|تسجيل بحساب Google| E[تسجيل دخول بحساب Google]

    C --> F[إدخال رقم الهاتف]
    D --> G[إدخال البريد الإلكتروني]
    E --> H[الحصول على توكن Firebase]

    F --> I[إرسال رمز OTP عبر SMS]
    G --> J[إرسال رمز OTP عبر البريد الإلكتروني]
    H --> K[التحقق من صحة توكن Firebase]

    I --> L[إدخال رمز OTP]
    J --> L
    K --> M{التحقق من صحة التوكن}

    L --> N{التحقق من صحة OTP}
    N -->|صالح| O[إنشاء حساب في Firebase]
    N -->|غير صالح| P[خطأ في OTP]

    O --> Q[ربط الحساب بنظام بثواني]
    Q --> R[إنشاء سجل المستخدم في قاعدة البيانات]
    R --> S[إنشاء الحسابات المالية الأولية]

    P --> T[إعادة إرسال OTP]
    M -->|غير صالح| U[خطأ في التوكن]

    T --> I
    U --> B

    style A fill:#e1f5fe
    style S fill:#c8e6c9
    style P fill:#ffcdd2
    style U fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم (العميل)
    participant CA as تطبيق العميل
    participant FB as خدمة Firebase Auth
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant OTP as خدمة OTP
    participant WS as خدمة المحفظة

    U->>CA: فتح التطبيق واختيار "إنشاء حساب"
    CA->>U: طلب رقم الهاتف أو البريد الإلكتروني

    alt استخدام رقم الهاتف
        U->>CA: إدخال رقم الهاتف
        CA->>OTP: طلب إرسال رمز OTP عبر SMS
        OTP->>U: إرسال رمز OTP عبر SMS
    else استخدام البريد الإلكتروني
        U->>CA: إدخال البريد الإلكتروني
        CA->>OTP: طلب إرسال رمز OTP عبر البريد الإلكتروني
        OTP->>U: إرسال رمز OTP عبر البريد الإلكتروني
    else استخدام حساب Google
        U->>FB: تسجيل دخول بحساب Google
        FB-->>U: إرجاع توكن Firebase
    end

    U->>CA: إدخال رمز OTP (إذا لزم الأمر)
    CA->>FB: التحقق من التوكن أو OTP
    FB-->>CA: تأكيد صحة المصادقة

    CA->>B: طلب إنشاء الحساب في نظام بثواني
    B->>FB: التحقق من توكن Firebase
    FB-->>B: تأكيد صحة التوكن

    B->>DB: البحث عن مستخدم موجود بنفس البيانات
    DB-->>B: نتيجة البحث

    alt المستخدم غير موجود
        B->>DB: إنشاء سجل مستخدم جديد
        DB-->>B: معرف المستخدم الجديد

        B->>WS: إنشاء الحسابات المالية الأولية
        WS-->>B: تأكيد إنشاء الحسابات

        B->>DB: حفظ بيانات المستخدم الكاملة
    else المستخدم موجود
        B->>DB: ربط الحساب الموجود بـ Firebase UID
    end

    B-->>CA: تأكيد إنشاء الحساب
    CA-->>U: عرض رسالة ترحيب وتوجيه للصفحة الرئيسية
```

---

## 2. تدفق إنشاء حساب التاجر (Vendor Account Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب إنشاء حساب تاجر] --> B[تسجيل البيانات الأساسية]
    B --> C[التحقق من صحة البيانات]

    C -->|صالحة| D[التحقق من عدم تكرار رقم الهاتف]
    C -->|غير صالحة| E[خطأ في البيانات المدخلة]

    D -->|متاح| F[تجزئة كلمة المرور]
    D -->|مستخدم| G[خطأ - رقم الهاتف مستخدم]

    F --> H[إنشاء سجل التاجر في قاعدة البيانات]
    H --> I[ربط التاجر بالمتجر المحدد]

    I --> J{التحقق من صحة المتجر}
    J -->|صالح| K[تعيين حالة التاجر كـ "في انتظار الموافقة"]
    J -->|غير صالح| L[خطأ في بيانات المتجر]

    K --> M[إنشاء الحسابات المالية للتاجر]
    M --> N[إرسال إشعار للإدارة للموافقة]

    L --> O[تصحيح بيانات المتجر]
    G --> P[تغيير رقم الهاتف]
    E --> Q[تصحيح البيانات]

    O --> I
    P --> D
    Q --> C

    style A fill:#e1f5fe
    style N fill:#c8e6c9
    style E fill:#ffcdd2
    style G fill:#ffcdd2
    style L fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant VS as خدمة التجار
    participant WS as خدمة المحفظة
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء تاجر جديد"
    AD->>A: طلب بيانات التاجر (الاسم، الهاتف، البريد، كلمة المرور، المتجر)

    A->>AD: إدخال بيانات التاجر
    AD->>B: إرسال طلب إنشاء التاجر

    B->>B: التحقق من صحة البيانات المدخلة
    Note over B: التحقق من الحقول المطلوبة والتنسيق

    B->>DB: البحث عن رقم هاتف مكرر
    DB-->>B: نتيجة البحث

    alt رقم الهاتف متاح
        B->>B: تجزئة كلمة المرور باستخدام bcrypt
        B->>DB: إنشاء سجل التاجر الجديد

        B->>VS: ربط التاجر بالمتجر المحدد
        VS->>DB: التحقق من صحة المتجر
        DB-->>VS: تأكيد صحة المتجر

        B->>WS: إنشاء الحسابات المالية للتاجر
        Note over WS: إنشاء حساب القبض وحساب الإيداع

        B->>DB: تعيين حالة التاجر كـ "في انتظار الموافقة"
        B->>NS: إرسال إشعار للإدارة لمراجعة الطلب

        B-->>AD: تأكيد إنشاء التاجر مع رقم التتبع
        AD-->>A: عرض رسالة نجاح مع تعليمات للتاجر
    else رقم الهاتف مستخدم أو خطأ في البيانات
        B-->>AD: رسالة خطأ مع التفاصيل
        AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
    end
```

---

## 3. تدفق إنشاء حساب السائق (Driver Account Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب إنشاء حساب سائق] --> B[إدخال البيانات الشخصية]
    B --> C[إدخال بيانات المركبة]

    C --> D[إدخال موقع السكن]
    D --> E[التحقق من صحة جميع البيانات]

    E -->|صالحة| F[التحقق من عدم تكرار رقم الهاتف]
    E -->|غير صالحة| G[خطأ في البيانات]

    F -->|متاح| H[تجزئة كلمة المرور]
    F -->|مستخدم| I[خطأ - رقم الهاتف مستخدم]

    H --> J[إنشاء سجل السائق في قاعدة البيانات]
    J --> K[ربط السائق بحسابات GL المالية]

    K --> L{التحقق من نجاح الربط}
    L -->|ناجح| M[تعيين حالة السائق كـ "في انتظار الموافقة"]
    L -->|فاشل| N[خطأ في إنشاء الحسابات المالية]

    M --> O[إرسال إشعار للإدارة للموافقة]
    N --> P[إعادة محاولة إنشاء الحسابات]

    G --> Q[تصحيح البيانات]
    I --> R[تغيير رقم الهاتف]

    Q --> E
    R --> F
    P --> K

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style G fill:#ffcdd2
    style I fill:#ffcdd2
    style N fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant DS as خدمة السائقين
    participant AS as خدمة المحاسبة
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء سائق جديد"
    AD->>A: طلب البيانات الشخصية (الاسم، الهاتف، البريد، كلمة المرور)

    A->>AD: إدخال البيانات الشخصية
    AD->>A: طلب بيانات المركبة (النوع، رقم اللوحة، الطراز)

    A->>AD: إدخال بيانات المركبة
    AD->>A: طلب موقع السكن (العنوان، المحافظة، المدينة، الإحداثيات)

    A->>AD: إدخال موقع السكن
    AD->>B: إرسال طلب إنشاء السائق

    B->>B: التحقق من صحة جميع البيانات المدخلة
    B->>DB: البحث عن رقم هاتف مكرر

    alt جميع البيانات صالحة ورقم الهاتف متاح
        B->>B: تجزئة كلمة المرور باستخدام bcrypt
        B->>DB: إنشاء سجل السائق الجديد

        B->>AS: إنشاء حسابات GL للسائق (1211-x و 1601/2161-x)
        AS-->>B: تأكيد إنشاء الحسابات

        B->>DB: ربط حسابات GL بسجل السائق
        B->>DB: تعيين حالة السائق كـ "في انتظار الموافقة"

        B->>NS: إرسال إشعار للإدارة لمراجعة طلب السائق
        B-->>AD: تأكيد إنشاء السائق مع رقم التتبع

        AD-->>A: عرض رسالة نجاح مع تعليمات للسائق
    else خطأ في البيانات أو رقم الهاتف مستخدم
        B-->>AD: رسالة خطأ مع التفاصيل
        AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
    end
```

---

## 4. تدفق إنشاء حساب المسوق الميداني (Field Marketer Account Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب إنشاء حساب مسوق] --> B[إدخال البيانات الشخصية]
    B --> C[اختيار خطة العمولة]

    C --> D[إدخال البيانات الإقليمية]
    D --> E[التحقق من صحة جميع البيانات]

    E -->|صالحة| F[التحقق من عدم تكرار البيانات]
    E -->|غير صالحة| G[خطأ في البيانات]

    F -->|متاحة| H[تجزئة كلمة المرور (اختيارية)]
    F -->|مستخدمة| I[خطأ - البيانات مستخدمة]

    H --> J[إنشاء سجل المسوق في قاعدة البيانات]
    J --> K[ربط المسوق بخطة العمولة]

    K --> L{التحقق من صحة خطة العمولة}
    L -->|صالحة| M[تعيين حالة المسوق كـ "نشط"]
    L -->|غير صالحة| N[خطأ في خطة العمولة]

    M --> O[إنشاء الحسابات المالية للمسوق]
    O --> P[إرسال إشعار للمسوق بالتفعيل]

    N --> Q[اختيار خطة عمولة أخرى]
    I --> R[تغيير البيانات]
    G --> S[تصحيح البيانات]

    Q --> C
    R --> F
    S --> E

    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style G fill:#ffcdd2
    style I fill:#ffcdd2
    style N fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant A as المشرف
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant MS as خدمة المسوقين
    participant CS as خدمة خطط العمولة
    participant WS as خدمة المحفظة
    participant NS as خدمة الإشعارات

    A->>AD: اختيار "إنشاء مسوق ميداني جديد"
    AD->>A: طلب البيانات الشخصية (الاسم، الهاتف، البريد، كلمة المرور)

    A->>AD: إدخال البيانات الشخصية
    AD->>A: طلب اختيار خطة العمولة

    A->>AD: اختيار خطة العمولة
    AD->>A: طلب البيانات الإقليمية (المدينة، الفريق، المنطقة)

    A->>AD: إدخال البيانات الإقليمية
    AD->>B: إرسال طلب إنشاء المسوق

    B->>B: التحقق من صحة جميع البيانات المدخلة
    B->>DB: البحث عن رقم هاتف أو بريد مكرر

    alt جميع البيانات صالحة وغير مكررة
        opt إذا تم إدخال كلمة مرور
            B->>B: تجزئة كلمة المرور باستخدام bcrypt
        end

        B->>DB: إنشاء سجل المسوق الجديد
        B->>CS: ربط المسوق بخطة العمولة المحددة
        CS-->>B: تأكيد صحة خطة العمولة

        B->>WS: إنشاء الحسابات المالية للمسوق
        B->>DB: تعيين حالة المسوق كـ "نشط"

        B->>NS: إرسال إشعار للمسوق بتفعيل الحساب
        B-->>AD: تأكيد إنشاء المسوق مع بيانات الدخول

        AD-->>A: عرض رسالة نجاح مع تعليمات للمسوق
    else خطأ في البيانات أو تكرار
        B-->>AD: رسالة خطأ مع التفاصيل
        AD-->>A: عرض رسالة الخطأ وطلب تصحيح البيانات
    end
```

---

## 5. تدفق إنشاء حساب المشرف (Admin Account Creation)

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب إنشاء حساب مشرف] --> B[التحقق من صلاحيات المُنشئ]
    B -->|ليس لديه صلاحية| C[خطأ - غير مصرح]

    B -->|لديه صلاحية| D[إدخال بيانات المشرف الجديد]
    D --> E[اختيار الأدوار والصلاحيات]

    E --> F[التحقق من صحة اسم المستخدم]
    F -->|متاح| G[التحقق من قوة كلمة المرور]
    F -->|مستخدم| H[خطأ - اسم المستخدم مستخدم]

    G -->|قوية| I[إنشاء سجل المشرف في قاعدة البيانات]
    G -->|ضعيفة| J[خطأ - كلمة مرور ضعيفة]

    I --> K[تعيين الأدوار والصلاحيات]
    K --> L[تعيين حالة المشرف كـ "نشط"]

    L --> M[إرسال إشعار للمشرف الجديد]
    J --> N[تحسين كلمة المرور]
    H --> O[تغيير اسم المستخدم]

    N --> G
    O --> F

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style C fill:#ffcdd2
    style H fill:#ffcdd2
    style J fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant SA as المشرف المُنشئ (Super Admin)
    participant AD as لوحة إدارة المشرفين
    participant B as الخادم الخلفي
    participant DB as قاعدة البيانات
    participant AS as خدمة المشرفين
    participant NS as خدمة الإشعارات

    SA->>AD: اختيار "إنشاء مشرف جديد"
    AD->>SA: طلب بيانات المشرف الجديد

    SA->>AD: إدخال اسم المستخدم وكلمة المرور المؤقتة
    AD->>SA: طلب اختيار الأدوار (Admin, Manager, Super Admin)

    SA->>AD: اختيار الأدوار
    AD->>SA: عرض واجهة اختيار الصلاحيات حسب الوحدات

    SA->>AD: تعيين الصلاحيات لكل وحدة
    AD->>B: إرسال طلب إنشاء المشرف

    B->>SA: التحقق من صلاحيات المُنشئ
    Note over B: التأكد من أن المُنشئ لديه صلاحية إنشاء مشرفين

    alt لديه صلاحية الإنشاء
        B->>DB: البحث عن اسم مستخدم مكرر
        DB-->>B: نتيجة البحث

        alt اسم المستخدم متاح
            B->>B: التحقق من قوة كلمة المرور
            Note over B: التحقق من الطول والتعقيد

            alt كلمة المرور قوية
                B->>DB: إنشاء سجل المشرف الجديد
                B->>DB: تعيين الأدوار والصلاحيات
                B->>DB: تعيين حالة المشرف كـ "نشط"

                B->>NS: إرسال إشعار للمشرف الجديد بتفعيل الحساب
                B-->>AD: تأكيد إنشاء المشرف مع تعليمات تسجيل الدخول

                AD-->>SA: عرض رسالة نجاح مع بيانات الحساب الجديد
            else كلمة المرور ضعيفة
                B-->>AD: رسالة خطأ - كلمة المرور ضعيفة
                AD-->>SA: طلب تحسين كلمة المرور
            end
        else اسم المستخدم مستخدم
            B-->>AD: رسالة خطأ - اسم المستخدم مستخدم
            AD-->>SA: طلب تغيير اسم المستخدم
        end
    else ليس لديه صلاحية الإنشاء
        B-->>AD: رسالة خطأ - غير مصرح لإنشاء مشرفين
        AD-->>SA: عرض رسالة عدم الصلاحية
    end
```

---

## مقارنة بين عمليات إنشاء الحسابات لكل شخصية

| الشخصية | طريقة الإنشاء | المسؤول عن الإنشاء | الحالة الافتراضية | متطلبات خاصة |
|---------|---------------|-------------------|-------------------|---------------|
| **العميل** | تلقائي عبر Firebase | المستخدم نفسه | نشط فوري | رقم هاتف أو بريد إلكتروني صالح |
| **التاجر** | يدوي من قبل الأدمن | المشرفين | في انتظار الموافقة | متجر محدد، موافقة إدارية |
| **السائق** | يدوي من قبل الأدمن | المشرفين | في انتظار الموافقة | بيانات المركبة، حسابات GL |
| **المسوق** | يدوي من قبل الأدمن | المشرفين | نشط فوري | خطة عمولة، بيانات إقليمية |
| **المشرف** | يدوي من قبل مشرفين آخرين | مشرفين آخرين | نشط فوري | صلاحيات محددة، كلمة مرور قوية |

---

## آليات الحماية المشتركة في جميع التدفقات

### 1. تشفير كلمات المرور
- استخدام bcrypt لتجزئة كلمات المرور
- عدم حفظ كلمات المرور كنص عادي

### 2. التحقق من البيانات المكررة
- منع تكرار أرقام الهواتف والبريد الإلكتروني
- فحص قواعد البيانات قبل الإنشاء

### 3. التحقق من صحة البيانات
- التحقق من تنسيق أرقام الهواتف والبريد الإلكتروني
- التحقق من قوة كلمات المرور

### 4. نظام الصلاحيات
- التحقق من صلاحيات المُنشئ قبل السماح بالإنشاء
- تسجيل عمليات الإنشاء في سجل التدقيق

### 5. إشعارات النظام
- إرسال إشعارات للمستخدمين الجدد
- إرسال طلبات موافقة للإدارة عند الحاجة

---

## قواعد البيانات المستخدمة

- **العملاء**: جدول `users` في MongoDB مع ربط بـ Firebase UIDs
- **التجار**: جدول `vendors` في MongoDB مع حالات الموافقة
- **السائقون**: جدول `drivers` في MongoDB مع بيانات المركبات وحسابات GL
- **المسوقون**: جدول `marketers` في MongoDB مع خطط العمولة
- **المشرفون**: جدول `admin_users` في MongoDB مع نظام الصلاحيات

هذه المخططات تغطي جميع جوانب عمليات إنشاء الحسابات في نظام بثواني بالتفصيل الكامل.
