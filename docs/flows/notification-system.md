# نظام الإشعارات الشامل في نظام بثواني

## نظرة عامة على نظام الإشعارات

نظام بثواني يحتوي على نظام إشعارات شامل ومتعدد القنوات يغطي:

1. **إشعارات الطلبات** (Order Notifications) - تتبع حالة الطلبات
2. **إشعارات التاجر** (Vendor Notifications) - إشعارات خاصة بالتجار
3. **إشعارات السائقين** (Driver Notifications) - إشعارات خاصة بالسائقين
4. **إشعارات النظام** (System Notifications) - إشعارات النظام والأمان
5. **إشعارات التسويق** (Marketing Notifications) - العروض والحملات

النظام يدعم عدة قنوات للإرسال: Push Notifications، Email، SMS، In-App Notifications.

---

## 1. تدفق إشعارات الطلبات (Order Notifications Flow)

### الأدوار المشاركة:
- **العميل**: يتلقى إشعارات عن حالة طلبه
- **السائق**: يتلقى إشعارات عن الطلبات المعينة له
- **التاجر**: يتلقى إشعارات عن الطلبات الجديدة
- **النظام**: يرسل الإشعارات تلقائياً حسب التغييرات في حالة الطلب

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[تغيير حالة الطلب] --> B[تحديد نوع الإشعار المطلوب]
    B --> C{نوع التغيير}

    C -->|إنشاء طلب جديد| D[إشعار العميل بإنشاء الطلب]
    C -->|تأكيد الطلب| E[إشعار العميل بالتأكيد]
    C -->|بدء التحضير| F[إشعار العميل ببدء التحضير]
    C -->|تعيين سائق| G[إشعار العميل والتاجر والسائق]
    C -->|بدء التوصيل| H[إشعار العميل ببدء التوصيل]
    C -->|تسليم الطلب| I[إشعار العميل والتاجر بتسليم الطلب]
    C -->|إلغاء الطلب| J[إشعار العميل والتاجر والسائق]

    D --> K[إرسال عبر Push Notification]
    E --> L[إرسال عبر Push + Email]
    F --> M[إرسال عبر Push Notification]
    G --> N[إرسال عبر Push للجميع]
    H --> O[إرسال عبر Push Notification]
    I --> P[إرسال عبر Push + Email]
    J --> Q[إرسال عبر Push + SMS]

    K --> R[حفظ الإشعار في قاعدة البيانات]
    L --> S[حفظ الإشعار في قاعدة البيانات]
    M --> T[حفظ الإشعار في قاعدة البيانات]
    N --> U[حفظ الإشعار في قاعدة البيانات]
    O --> V[حفظ الإشعار في قاعدة البيانات]
    P --> W[حفظ الإشعار في قاعدة البيانات]
    Q --> X[حفظ الإشعار في قاعدة البيانات]

    style A fill:#e1f5fe
    style X fill:#c8e6c9
    style Q fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant O as الطلب
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant CU as العميل
    participant D as السائق
    participant V as التاجر
    participant WS as خدمة الويب سوكيت

    O->>NS: تغيير حالة الطلب (مثال: تم التسليم)
    NS->>DB: جلب تفاصيل الطلب الكاملة
    DB-->>NS: بيانات الطلب مع جميع الأطراف

    NS->>NS: تحديد نوع الإشعار حسب التغيير
    Note over NS: تحديد العنوان والرسالة حسب نوع التغيير

    NS->>DB: حفظ الإشعار في سجل الإشعارات
    DB-->>NS: تأكيد حفظ الإشعار

    NS->>CU: إرسال إشعار Push للعميل
    Note over CU: إشعار فوري في التطبيق

    NS->>D: إرسال إشعار Push للسائق
    Note over D: إشعار فوري في تطبيق السائق

    NS->>V: إرسال إشعار Push للتاجر
    Note over V: إشعار فوري في تطبيق التاجر

    NS->>CU: إرسال إشعار Email للعميل
    Note over CU: إشعار بالبريد الإلكتروني

    NS->>WS: إرسال إشعار عبر WebSocket للتطبيقات المفتوحة
    WS-->>CU: تحديث فوري في التطبيق
    WS-->>D: تحديث فوري في تطبيق السائق
    WS-->>V: تحديث فوري في تطبيق التاجر
```

---

## 2. تدفق إشعارات السائقين (Driver Notifications Flow)

### الأدوار المشاركة:
- **السائق**: يتلقى عروض التوصيل وتحديثات الطلبات
- **النظام**: يرسل عروض التوصيل ويتابع حالة السائقين
- **الإدارة**: تتلقى إشعارات عن مشاكل السائقين

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب جديد جاهز للتعيين] --> B[البحث عن سائقين متاحين]
    B --> C[إرسال عرض التوصيل للسائقين]

    C --> D[انتظار استجابة السائقين]
    D --> E{هل قبل أحد السائقين؟}

    E -->|نعم| F[تعيين السائق للطلب]
    E -->|لا| G[إرسال عرض لسائقين آخرين]

    F --> H[إرسال إشعار تأكيد للسائق]
    H --> I[إرسال إشعار للعميل بالسائق المعين]

    G --> J{هل تم العثور على سائق؟}
    J -->|نعم| C
    J -->|لا| K[إشعار الإدارة بعدم وجود سائقين]

    K --> L[إشعار التاجر بعدم وجود سائقين]

    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style G fill:#ffcdd2
    style K fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant DS as خدمة السائقين
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant DA as تطبيق السائق
    participant CU as العميل
    participant V as التاجر
    participant AS as خدمة الإدارة

    DS->>NS: طلب إرسال عرض توصيل للسائقين
    NS->>DB: جلب قائمة السائقين المتاحين قريبين من المتجر
    DB-->>NS: قائمة السائقين المرشحين

    NS->>DA: إرسال إشعار Push بعرض توصيل جديد
    Note over DA: عرض تفاصيل الطلب والمسافة والسعر

    DA->>DS: قبول السائق لعرض التوصيل
    DS->>DB: تعيين السائق للطلب
    DB-->>DS: تأكيد التعيين

    DS->>NS: إرسال إشعار تأكيد التعيين للسائق
    NS->>DA: إشعار تأكيد تعيين الطلب للسائق

    DS->>NS: إرسال إشعار للعميل بالسائق المعين
    NS->>CU: إشعار العميل بالسائق المعين للطلب

    DS->>NS: إرسال إشعار للتاجر بالسائق المعين
    NS->>V: إشعار التاجر بالسائق المعين للطلب
```

---

## 3. تدفق إشعارات التاجر (Vendor Notifications Flow)

### الأدوار المشاركة:
- **التاجر**: يتلقى إشعارات الطلبات الجديدة والتحديثات
- **النظام**: يرسل إشعارات تلقائية عن حالة الطلبات
- **الإدارة**: تتلقى إشعارات عن مشاكل التجار

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[طلب جديد تم تأكيده] --> B[إرسال إشعار للتاجر بالطلب الجديد]
    B --> C[انتظار استجابة التاجر]

    C --> D{هل قبل التاجر الطلب؟}
    D -->|نعم| E[تحديث حالة الطلب إلى "قيد التحضير"]

    D -->|لا| F[إشعار التاجر برفض الطلب]
    E --> G[إرسال إشعار للعميل بقبول الطلب]

    G --> H[إرسال إشعار للسائق ببدء التحضير]
    H --> I[انتظار إكمال التحضير]

    I --> J{هل تم إكمال التحضير؟}
    J -->|نعم| K[إرسال إشعار للسائق بالطلب الجاهز]

    J -->|لا| L[إرسال تذكير للتاجر]

    K --> M[إرسال إشعار للعميل بجاهزية الطلب]

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style D fill:#ffcdd2
    style L fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant O as الطلب
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant VA as تطبيق التاجر
    participant V as التاجر
    participant CU as العميل
    participant DS as خدمة السائقين

    O->>NS: إرسال إشعار للتاجر بالطلب الجديد
    NS->>VA: إشعار التاجر بطلب جديد في التطبيق

    V->>VA: مراجعة تفاصيل الطلب
    VA->>O: طلب قبول الطلب من التاجر

    O->>DB: تحديث حالة الطلب إلى "قيد التحضير"
    DB-->>O: تأكيد التحديث

    O->>NS: إرسال إشعار للعميل بقبول الطلب
    NS->>CU: إشعار العميل بقبول الطلب من التاجر

    V->>VA: بدء عملية تحضير الطلب
    VA->>O: إرسال طلب تحديث حالة التحضير

    O->>DB: تحديث حالة الطلب إلى "جاهز للتوصيل"
    DB-->>O: تأكيد التحديث

    O->>NS: إرسال إشعار للسائق بجاهزية الطلب
    NS->>DS: إشعار السائق بأن الطلب جاهز للاستلام

    O->>NS: إرسال إشعار للعميل بجاهزية الطلب
    NS->>CU: إشعار العميل بأن الطلب جاهز للتوصيل
```

---

## 4. تدفق إشعارات النظام (System Notifications Flow)

### الأدوار المشاركة:
- **الإدارة**: تتلقى إشعارات الأمان والأخطاء
- **النظام**: يرسل إشعارات تلقائية عن الأحداث المهمة
- **المطورين**: تتلقى إشعارات الأخطاء التقنية

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[حدث أمني أو تقني] --> B[تحديد نوع الحدث]
    B --> C{نوع الحدث}

    C -->|محاولات دخول متكررة| D[إرسال إشعار أمان]
    C -->|خطأ في النظام| E[إرسال إشعار خطأ]
    C -->|نسخ احتياطي مكتمل| F[إرسال إشعار نجاح]
    C -->|تحديث نظام| G[إرسال إشعار تحديث]

    D --> H[حفظ الإشعار في سجل الأمان]
    E --> I[حفظ الإشعار في سجل الأخطاء]
    F --> J[حفظ الإشعار في سجل النسخ الاحتياطي]
    G --> K[حفظ الإشعار في سجل التحديثات]

    H --> L[إرسال للإدارة عبر Email]
    I --> M[إرسال للمطورين عبر Slack/Email]
    J --> N[إرسال للإدارة عبر Email]
    K --> O[إرسال للإدارة عبر Email]

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style D fill:#ffcdd2
    style E fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant SYS as النظام
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant AS as خدمة الإدارة
    participant DEV as خدمة المطورين
    participant EM as خدمة البريد الإلكتروني

    SYS->>NS: حدث أمني أو تقني (مثال: محاولات دخول متكررة)
    NS->>DB: حفظ تفاصيل الحدث في سجل الأحداث
    DB-->>NS: تأكيد حفظ الحدث

    NS->>NS: تحديد نوع الحدث وأولويته
    Note over NS: تصنيف الحدث حسب الخطورة والنوع

    NS->>AS: إرسال إشعار للإدارة عبر Push Notification
    AS-->>NS: تأكيد استلام الإشعار

    NS->>EM: إرسال إشعار بالبريد الإلكتروني للإدارة
    EM-->>AS: إرسال البريد الإلكتروني

    NS->>DB: تحديث حالة الإشعار إلى "مرسل"
    DB-->>NS: تأكيد تحديث الحالة

    NS->>NS: جدولة متابعة الحدث إذا لزم الأمر
    Note over NS: جدولة فحص دوري للحدث إذا كان مستمراً
```

---

## 5. تدفق إشعارات التسويق (Marketing Notifications Flow)

### الأدوار المشاركة:
- **العملاء**: يتلقون عروض وخصومات مخصصة
- **التاجر**: يتلقى إشعارات عن حملاته التسويقية
- **النظام**: يرسل الإشعارات حسب التفضيلات والسلوك

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[إنشاء حملة تسويقية جديدة] --> B[تحديد الجمهور المستهدف]
    B --> C[تصفية المستخدمين حسب التفضيلات]

    C --> D[إعداد محتوى الإشعار]
    D --> E[اختيار قنوات الإرسال]

    E --> F[إرسال الإشعار للمستخدمين]
    F --> G[تتبع معدلات الفتح والتفاعل]

    G --> H{هل تفاعل المستخدمون؟}
    H -->|نعم| I[تحسين الحملات المستقبلية]

    H -->|لا| J[تحليل أسباب عدم التفاعل]

    I --> K[إرسال المزيد من العروض المخصصة]
    J --> L[تعديل استراتيجية التسويق]

    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style H fill:#ffcdd2
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant MKT as خدمة التسويق
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant CU as العميل
    participant VS as خدمة التاجر
    participant AN as خدمة التحليلات

    MKT->>DB: جلب قائمة المستخدمين المؤهلين للحملة
    DB-->>MKT: قائمة المستخدمين حسب الشروط

    MKT->>NS: إعداد محتوى الإشعار التسويقي
    NS->>DB: حفظ تفاصيل الحملة في سجل الحملات
    DB-->>NS: تأكيد حفظ الحملة

    NS->>CU: إرسال إشعار Push للعملاء
    Note over CU: عرض العرض أو الخصم الجديد

    NS->>CU: إرسال إشعار Email للعملاء
    Note over CU: تفاصيل العرض بالبريد الإلكتروني

    NS->>VS: إرسال إشعار للتاجر بحملته النشطة
    VS-->>MKT: تأكيد إرسال الإشعار للتاجر

    CU->>AN: تفاعل العميل مع الإشعار (فتح، تجاهل، استخدام)
    AN->>DB: حفظ تفاعل العميل مع الحملة
    DB-->>AN: تأكيد حفظ التفاعل

    AN->>MKT: تحليل معدلات التفاعل مع الحملة
    MKT->>MKT: تقييم نجاح الحملة وتحسين المستقبلية
```

---

## 6. تدفق إدارة تفضيلات الإشعارات (Notification Preferences Flow)

### الأدوار المشاركة:
- **المستخدم**: يتحكم في تفضيلات الإشعارات الخاصة به
- **النظام**: يحفظ ويطبق تفضيلات المستخدم
- **التطبيق**: يعرض واجهة إدارة التفضيلات

### Workflow Diagram - مخطط التدفق

```mermaid
graph TD
    A[فتح إعدادات الإشعارات] --> B[عرض التفضيلات الحالية]
    B --> C[تعديل تفضيلات الإشعارات]

    C --> D[تغيير نوع الإشعارات]
    D --> E[تغيير قنوات الإرسال]

    E --> F[تغيير جدولة الإشعارات]
    F --> G[حفظ التغييرات]

    G --> H[تطبيق التفضيلات الجديدة]
    H --> I[إرسال تأكيد للمستخدم]

    style A fill:#e1f5fe
    style I fill:#c8e6c9
```

### Sequence Diagram - مخطط التسلسل

```mermaid
sequenceDiagram
    participant U as المستخدم
    participant APP as التطبيق
    participant NS as خدمة الإشعارات
    participant DB as قاعدة البيانات
    participant PS as خدمة التفضيلات

    U->>APP: فتح إعدادات الإشعارات
    APP->>PS: طلب تفضيلات الإشعارات الحالية للمستخدم
    PS->>DB: جلب تفضيلات الإشعارات من قاعدة البيانات
    DB-->>PS: بيانات تفضيلات المستخدم

    APP-->>U: عرض تفضيلات الإشعارات الحالية

    U->>APP: تعديل تفضيلات الإشعارات
    APP->>PS: إرسال التفضيلات المحدثة

    PS->>DB: حفظ التفضيلات المحدثة في قاعدة البيانات
    DB-->>PS: تأكيد حفظ التفضيلات

    PS->>NS: تطبيق التفضيلات الجديدة على نظام الإشعارات
    NS-->>PS: تأكيد تطبيق التفضيلات

    PS->>APP: تأكيد حفظ التفضيلات
    APP-->>U: عرض رسالة نجاح حفظ التفضيلات
```

---

## مقارنة بين أنواع الإشعارات في النظام

| نوع الإشعار | المستلمون | القنوات | الأولوية | التكرار |
|-------------|-----------|----------|----------|---------|
| **إشعارات الطلبات** | العميل، السائق، التاجر | Push, Email, In-App | عالية | فوري عند التغيير |
| **إشعارات السائقين** | السائقين المتاحين | Push, In-App | عالية | فوري للعروض |
| **إشعارات التاجر** | التجار | Push, In-App | متوسطة | فوري للطلبات |
| **إشعارات النظام** | الإدارة، المطورين | Email, Slack, In-App | عالية/حرجة | حسب الحدث |
| **إشعارات التسويق** | العملاء المستهدفين | Push, Email, SMS | متوسطة | حسب الحملة |

---

## البيانات المطلوبة لكل نوع إشعار

### إشعار طلب جديد (Order Created)
- **معرف الطلب** (orderId)
- **معرف المستخدم** (userId)
- **اسم المستخدم** (userName)
- **مبلغ الطلب** (totalAmount)
- **عدد العناصر** (itemsCount)
- **عنوان التسليم** (deliveryAddress)

### إشعار تعيين سائق (Driver Assigned)
- **معرف الطلب** (orderId)
- **اسم السائق** (driverName)
- **هاتف السائق** (driverPhone)
- **وقت الوصول المتوقع** (estimatedArrival)

### إشعار حالة الطلب (Order Status Update)
- **معرف الطلب** (orderId)
- **الحالة الجديدة** (newStatus)
- **الحالة السابقة** (oldStatus)
- **رسالة إضافية** (message)

### إشعار أمني (Security Alert)
- **نوع الحدث** (eventType)
- **عنوان IP** (ipAddress)
- **اسم المستخدم** (username)
- **عدد المحاولات** (attempts)
- **حالة الحظر** (isBlocked)

---

## آليات الحماية والتحقق

### 1. التحقق من التفضيلات
- **تفضيلات المستخدم**: عدم إرسال إشعارات للمستخدمين الذين رفضوها
- **أنواع الإشعارات**: فلترة حسب نوع الإشعار المسموح به
- **قنوات الإرسال**: احترام قنوات الإرسال المفضلة للمستخدم

### 2. منع السبام
- **حدود التكرار**: منع إرسال إشعارات متكررة لنفس الحدث
- **فترات الانتظار**: تحديد فترات زمنية بين الإشعارات المتشابهة
- **الحد الأقصى**: تحديد عدد الإشعارات المسموح بها يومياً

### 3. جودة المحتوى
- **الطول المحدد**: تحديد طول العناوين والرسائل
- **التنسيق المناسب**: التأكد من صحة تنسيق الرسائل
- **اللغة المناسبة**: استخدام اللغة الصحيحة حسب المستخدم

### 4. إدارة الأخطاء
- **إعادة المحاولة**: إعادة إرسال الإشعارات الفاشلة
- **التسجيل**: حفظ سجل كامل لجميع الإشعارات المرسلة
- **المراقبة**: مراقبة حالة إرسال الإشعارات

### 5. حماية البيانات
- **التشفير**: تشفير بيانات الإشعارات الحساسة
- **الخصوصية**: عدم عرض بيانات شخصية في الإشعارات العامة
- **الامتثال**: الامتثال لقوانين حماية البيانات (GDPR, CCPA)

---

## قواعد البيانات المستخدمة

- **إشعارات المستخدمين**: جدول `notifications` في MongoDB
- **تفضيلات الإشعارات**: جدول `notification_preferences` في MongoDB
- **سجل الإشعارات**: جدول `notification_logs` في MongoDB
- **قوالب الإشعارات**: جدول `notification_templates` في MongoDB

---

## حالات الإشعار الممكنة

| الحالة | الوصف | يمكن إعادة الإرسال | يظهر للمستخدم |
|---------|--------|-------------------|----------------|
| **مرسل** | إشعار تم إرساله بنجاح | ❌ لا | ✅ يظهر |
| **فاشل** | إشعار فشل في الإرسال | ✅ يمكن إعادة الإرسال | ❌ لا يظهر |
| **مؤجل** | إشعار في قائمة الانتظار | ✅ يمكن إعادة الإرسال | ❌ لا يظهر |
| **ملغي** | إشعار تم إلغاؤه | ❌ لا | ❌ لا يظهر |

---

## مميزات نظام الإشعارات المتقدمة

### 1. تخصيص الإشعارات
- إعدادات مخصصة لكل مستخدم حسب تفضيلاته
- قنوات إرسال متعددة (Push, Email, SMS, In-App)
- جدولة الإشعارات حسب أوقات المستخدم المفضلة

### 2. ذكاء اصطناعي في الإشعارات
- تحليل سلوك المستخدم لتحسين توقيت الإشعارات
- تخصيص المحتوى حسب تفاعل المستخدم السابق
- تجنب الإشعارات المزعجة بناءً على التحليل

### 3. نظام التحليلات
- تتبع معدلات فتح الإشعارات
- تحليل التفاعل مع الإشعارات التسويقية
- قياس فعالية الحملات التسويقية

### 4. نظام الاستجابات التلقائية
- ردود تلقائية على أحداث معينة
- إشعارات ذكية حسب حالة الطلب
- تذكيرات تلقائية للمهام المهمة

### 5. نظام التنبيهات الذكي
- تنبيهات فورية للأحداث الحرجة
- تنبيهات دورية للأحداث المهمة
- تصعيد التنبيهات حسب الأولوية والأهمية

هذه المخططات تغطي جميع جوانب نظام الإشعارات في نظام بثواني بالتفصيل الكامل.
