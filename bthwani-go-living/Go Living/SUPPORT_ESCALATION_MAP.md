# خريطة تصعيد الدعم وإدارة الحوادث

## نظرة عامة
دليل شامل لإدارة الحوادث وتصعيد الدعم الفني في نظام Bthwani مع تحديد المستويات والإجراءات المطلوبة لكل مستوى من مستويات الخطورة (SEV).

## مستويات الحوادث (SEV Levels)

### SEV1 - كارثي (Critical)
**الوصف**: توقف كامل للخدمات الأساسية يؤثر على جميع المستخدمين
**الأمثلة**:
- الموقع لا يحمل نهائياً
- تطبيقات الهاتف لا تعمل
- قاعدة البيانات متوقفة
- فقدان بيانات حرجة

**أهداف الاستجابة**:
- **وقت الاستجابة**: خلال 15 دقيقة
- **وقت الحل**: خلال ساعة واحدة
- **الإجراء**: رجوع فوري إلى آخر إصدار مستقر

### SEV2 - عالي (High)
**الوصف**: خلل جزئي يؤثر على وظائف مهمة لشريحة كبيرة من المستخدمين
**الأمثلة**:
- مشاكل في عملية الدفع
- عدم تحميل صفحات مهمة
- بطء شديد في الأداء
- أخطاء في معالجة الطلبات

**أهداف الاستجابة**:
- **وقت الاستجابة**: خلال ساعة واحدة
- **وقت الحل**: خلال 4 ساعات
- **الإجراء**: إصلاح سريع أو رجوع محسوب

### SEV3 - متوسط (Medium)
**الوصف**: مشاكل طفيفة تؤثر على تجربة مستخدمين محدودين
**الأمثلة**:
- أخطاء عرض في صفحات معينة
- مشاكل في فلاتر البحث
- روابط معطلة جزئياً
- مشاكل في واجهة المستخدم

**أهداف الاستجابة**:
- **وقت الاستجابة**: خلال يوم عمل
- **وقت الحل**: خلال أسبوع
- **الإجراء**: إصلاح في الإصدار التالي أو رجوع إذا زاد الأثر

## سلسلة التصعيد (Escalation Chain)

### المستوى الأول: فريق التشغيل (On-Call)
**المسؤوليات**:
- مراقبة النظام 24/7
- الاستجابة للتنبيهات التلقائية
- تشخيص المشاكل الأولية
- اتخاذ قرار الرجوع في حالات الطوارئ

**أعضاء الفريق**:
- **DevOps Engineer**: مسؤول البنية التحتية والنشر
- **SRE (Site Reliability Engineer)**: مسؤول موثوقية النظام
- **Backend Developer (On-Call)**: مطور الخلفية للحالات الطارئة

**قنوات الاتصال**:
- **Slack**: #emergency-alerts (مع @here)
- **PagerDuty**: تطبيق التنبيهات التلقائية
- **Phone**: قائمة أرقام الطوارئ (مُحدثة أسبوعياً)

### المستوى الثاني: الإدارة التقنية
**المسؤوليات**:
- اتخاذ قرارات استراتيجية للحوادث الكبيرة
- تنسيق بين الفرق المختلفة
- إدارة الاتصال مع الإدارة العليا
- تحليل الأثر على الأعمال

**أعضاء الفريق**:
- **Backend Team Lead**: قائد فريق الخلفية
- **Frontend Team Lead**: قائد فريق الواجهة الأمامية
- **Mobile Team Lead**: قائد فريق التطبيقات
- **DevOps Lead**: قائد فريق العمليات

### المستوى الثالث: الإدارة التنفيذية
**المسؤوليات**:
- اتخاذ قرارات تجارية حرجة
- إدارة علاقات العملاء والشركاء
- التنسيق مع الجهات الخارجية (إن لزم الأمر)
- تقييم التأثير المالي والتشغيلي

**أعضاء الفريق**:
- **CTO (Chief Technology Officer)**: المدير التقني التنفيذي
- **Product Manager**: مدير المنتج
- **Support Manager**: مدير الدعم الفني
- **Business Operations Manager**: مدير العمليات التجارية

## إجراءات الاستجابة حسب المستوى

### استجابة SEV1 (الإجراءات الفورية)
```bash
# 1. التنبيه الفوري
@here SEV1 ALERT: نظام متوقف تماماً - بدء إجراءات الطوارئ

# 2. تشخيص سريع
kubectl get pods -A | grep -E "(Error|CrashLoop)"
curl -f https://api.bthwani.com/health || echo "API Down!"

# 3. رجوع فوري إلى آخر إصدار مستقر
# اتبع إجراءات الـ Rollback Handbook

# 4. إشعار جميع الفرق المعنية
@backend-team @frontend-team @mobile-team SEV1 في الإنتاج - تم البدء في الرجوع
```

### استجابة SEV2 (الإجراءات السريعة)
```bash
# 1. تقييم الأثر
echo "تأثير الحادث: X% من المستخدمين متأثرين"

# 2. تشخيص المشكلة
tail -f /var/log/application/errors.log | grep -i "payment\|order"

# 3. قرار الرجوع أو الإصلاح
if [ "$IMPACT_PERCENTAGE" -gt 50 ]; then
    echo "بدء إجراءات الرجوع - التأثير كبير جداً"
    # اتبع إجراءات الـ Rollback Handbook
else
    echo "محاولة إصلاح سريع - التأثير محدود"
fi
```

### استجابة SEV3 (الإجراءات المعتادة)
```bash
# 1. تسجيل الحادث في نظام إدارة المشاريع
echo "SEV3: مشكلة في فلتر البحث - تم تسجيل التذكرة #12345"

# 2. إشعار الفريق المعني
@frontend-team تم اكتشاف مشكلة في فلتر البحث - مطلوب مراجعة

# 3. جدولة الإصلاح في الإصدار التالي
echo "مُجدول للإصلاح في الإصدار القادم v2.1.5"
```

## قنوات الاتصال والتواصل

### قنوات الطوارئ الأساسية
1. **Slack Channels**:
   - `#emergency-alerts`: للتنبيهات التلقائية والحوادث الكبرى
   - `#backend-emergency`: لمشاكل الخلفية
   - `#frontend-emergency`: لمشاكل الواجهة الأمامية
   - `#mobile-emergency`: لمشاكل التطبيقات

2. **PagerDuty**:
   - تنبيهات تلقائية للحوادث SEV1 و SEV2
   - جدولة المناوبات الأسبوعية
   - تأكيد الاستلام والتحديثات

3. **Microsoft Teams**:
   - اجتماعات طوارئ فورية
   - مشاركة الشاشة للتشخيص
   - تسجيل الاجتماعات للتوثيق

### قنوات التواصل الاحتياطية
- **WhatsApp Groups**:
  - مجموعة الطوارئ التقنية (للحالات النادرة)
  - مجموعة الإدارة التنفيذية
- **Email**:
  - قوائم بريدية للإشعارات المهمة
  - تقارير ما بعد الحادث
- **Phone**:
  - قائمة أرقام الطوارئ (مُحدثة أسبوعياً)
  - مكالمات جماعية للحالات الحرجة جداً

## Runbook المختصر (Quick Reference)

### خطوات جمع المعلومات (Information Gathering)
```bash
# 1. فحص حالة الخدمات
curl -f https://api.bthwani.com/health
kubectl get pods -A | grep -v Running

# 2. فحص السجلات الأخيرة
journalctl -u application --since "1 hour ago" | tail -50

# 3. فحص استخدام الموارد
df -h && free -h && uptime

# 4. فحص قاعدة البيانات
mongosh "$MONGO_URI" --eval "db.stats()"

# 5. فحص سجلات التدقيق الأخيرة
curl -s "https://api.bthwani.com/admin/audit-logs?limit=10"
```

### إطفاء الميزات (Feature Flags)
```bash
# إطفاء ميزة معينة مؤقتاً
curl -X PATCH https://api.bthwani.com/admin/feature-flags \
  -d '{"feature": "new_payment_system", "enabled": false}'

# إطفاء جميع الميزات الجديدة
curl -X PATCH https://api.bthwani.com/admin/feature-flags/reset
```

### خطوات الرجوع السريع
```bash
# Backend
cd Backend && ./scripts/rollback.sh

# Web
cd Web && ./scripts/rollback.sh

# Mobile Apps
eas update --branch production --rollback
```

### التحققات بعد الرجوع
```bash
# 1. فحص الصحة العامة
curl -f https://api.bthwani.com/health

# 2. اختبار السيناريو الأساسي
# طلب → محفظة → تسوية

# 3. فحص عدم وجود أخطاء في السجلات
kubectl logs -l app=backend --tail=20 | grep -v "INFO"

# 4. فحص قاعدة البيانات
mongosh "$MONGO_URI" --eval "db.adminCommand('ismaster')"
```

## أدوات التشخيص والمراقبة

### أدوات مراقبة النظام
- **Prometheus + Grafana**: مراقبة المقاييس والتنبيهات
- **ELK Stack (Elasticsearch, Logstash, Kibana)**: تحليل السجلات
- **New Relic**: مراقبة الأداء والأخطاء
- **Sentry**: تتبع الأعطال في التطبيقات

### أدوات مراقبة الأعمال
- **Google Analytics**: مراقبة سلوك المستخدمين
- **Mixpanel**: تحليل استخدام التطبيقات
- **Firebase Crashlytics**: مراقبة أعطال التطبيقات

### أدوات التواصل مع المستخدمين
- **Status Page (Statuspage.io)**: صفحة حالة النظام العامة
- **In-App Notifications**: إشعارات داخل التطبيقات
- **Push Notifications**: إشعارات فورية للمستخدمين المتأثرين

## تقارير ما بعد الحادث (Post-Mortem)

### هيكل تقرير ما بعد الحادث
```markdown
# تقرير ما بعد الحادث - [التاريخ]

## ملخص الحادث
- **نوع الحادث**: SEV1 - توقف كامل للنظام
- **الوقت**: 2025-01-15 14:30 - 16:45 (مدة: 2 ساعات و15 دقيقة)
- **التأثير**: 100% من المستخدمين متأثرين

## تسلسل الأحداث
- 14:30: اكتشاف المشكلة الأولى
- 14:35: بدء التحقيق
- 14:45: تصنيف الحادث كـ SEV1
- 15:00: بدء إجراءات الرجوع
- 15:30: نجاح الرجوع الجزئي
- 16:45: عودة النظام للعمل الطبيعي

## السبب الجذري
- [وصف مفصل للسبب الجذري]
- [الأخطاء في الكود أو البنية التحتية]

## الإجراءات المتخذة
- [قائمة بالإجراءات التي تم اتخاذها]
- [القرارات المتخذة في كل مرحلة]

## الدروس المستفادة
- [الدروس المستفادة من الحادث]
- [التحسينات المقترحة للوقاية]

## الإجراءات الوقائية
- [قائمة بالإجراءات لمنع تكرار الحادث]
- [التحديثات على الـ Rollback Handbook]
- [التدريبات المطلوبة للفريق]
```

## جدولة المناوبات (On-Call Schedule)

### جدول المناوبات الأسبوعي
| الأسبوع | Backend On-Call | Frontend On-Call | Mobile On-Call | DevOps On-Call |
|---------|----------------|------------------|----------------|----------------|
| أسبوع 1 | محمد أحمد | فاطمة علي | أحمد حسن | سارة محمد |
| أسبوع 2 | علي محمود | نور حسن | حسن أحمد | لينا علي |
| أسبوع 3 | خالد سعد | مريم خالد | سعد مريم | هالة سعد |
| أسبوع 4 | رامي طارق | دينا رامي | طارق دينا | سناء طارق |

### إجراءات تسليم المناوبة
1. **اجتماع تسليم قصير** (15 دقيقة)
2. **مشاركة قائمة المشاكل المعروفة**
3. **تحديث قائمة أرقام الطوارئ**
4. **اختبار التنبيهات والقنوات**

## التدريب والمحاكاة

### تدريبات الطوارئ الشهرية
- **Fire Drills**: محاكاة حوادث SEV1 كل شهر
- **Tabletop Exercises**: مناقشات نظرية لحالات افتراضية
- **Post-Mortem Reviews**: مراجعة الحوادث السابقة

### برامج التدريب المطلوبة
1. **أساسيات الـ Rollback**: لجميع أعضاء الفريق التقني
2. **إدارة الحوادث**: للـ Team Leads و الـ Managers
3. **أدوات المراقبة**: تدريب عملي على أدوات المراقبة
4. **التواصل في الأزمات**: مهارات التواصل والتنسيق

## مراجعة وتحديث الدليل

### مراجعة دورية
- **شهرية**: مراجعة الإجراءات والتحديثات
- **ربع سنوية**: مراجعة شاملة للعمليات
- **سنوية**: مراجعة استراتيجية كاملة

### تحديث الدليل
- **بعد كل حادث**: تحديث الإجراءات بناءً على الدروس المستفادة
- **مع كل تغيير تقني**: تحديث الإجراءات المتأثرة
- **مع التحديثات الأمنية**: مراجعة إجراءات الأمان والحماية

---

## ملخص سريع للطوارئ

### SEV1 Actions (Do This NOW)
1. **Alert**: `@here SEV1 in #emergency-alerts`
2. **Diagnose**: Check health endpoints and logs
3. **Rollback**: Execute immediate rollback procedures
4. **Communicate**: Notify all stakeholders

### SEV2 Actions (Within 1 Hour)
1. **Assess**: Determine scope and impact
2. **Decide**: Choose between fix or rollback
3. **Execute**: Implement chosen solution
4. **Monitor**: Watch for improvement

### SEV3 Actions (Within 1 Business Day)
1. **Log**: Create ticket in project management
2. **Investigate**: Root cause analysis
3. **Plan**: Schedule fix in next release
4. **Update**: Add to sprint backlog

---

**تاريخ آخر تحديث**: 15 يناير 2025
**الإصدار**: 2.0.0
**مسؤول الصيانة**: فريق DevOps
**تاريخ المراجعة التالية**: 15 أبريل 2025
