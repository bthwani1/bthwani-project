# Mobile Apps Rollback Handbook

## نظرة عامة
دليل شامل لإجراءات الاسترجاع (Rollback) لتطبيقات الهاتف المحمول (Expo/React Native) مع ضمان استمرارية الخدمة وجودة تجربة المستخدم.

## استراتيجية الإصدارات

### تسميات الإصدارات الموحدة
```
apps-vYYYY.MM.DD-HHMM
```
**أمثلة:**
- `apps-v2025.01.15-1430`
- `apps-v2025.01.15-1500`
- `apps-v2025.01.16-0900`

### قنوات النشر (Channels)
- **staging**: للاختبار قبل الإنتاج
- **production**: الإصدار النهائي للمستخدمين

### أنواع التحديثات
1. **OTA Updates** (Over-The-Air): تحديثات فورية بدون تحميل من المتجر
2. **Build Updates**: تحديثات تتطلب تحميل من المتجر
3. **Runtime Version**: إصدار محرك التطبيق

## إجراءات النشر العادية

### 1. نشر إلى Staging أولاً
```bash
# بناء ونشر إلى قناة staging
eas update --branch staging --message "New feature release"

# فحص حالة النشر
eas update:list --branch staging
```

### 2. اختبار شامل في Staging
```bash
# فتح التطبيق على قناة staging
# اختبار جميع الوظائف الجديدة
# التأكد من عدم وجود أخطاء
# فحص الأداء والاستقرار
```

### 3. ترقية إلى Production
```bash
# ترقية من staging إلى production
eas update --branch production --message "Promote to production"

# أو إنشاء build جديد للمتجر
eas build --platform all --profile production
eas submit --platform ios --profile production
eas submit --platform android --profile production
```

## خطة الاسترجاع (Rollback Plan)

### سيناريوهات الاسترجاع

#### SEV1 (توقف حرج)
- **السبب**: تعطل التطبيق، أخطاء في الوظائف الأساسية، مشاكل أمنية
- **الوقت المستهدف**: خلال 15 دقيقة
- **الإجراء**: رجوع فوري إلى آخر إصدار مستقر

#### SEV2 (خلل جزئي)
- **السبب**: مشاكل في وظائف معينة، بطء في الأداء، استهلاك بطارية زائد
- **الوقت المستهدف**: خلال ساعة واحدة
- **الإجراء**: تقييم الأثر واتخاذ قرار الرجوع أو الإصلاح

#### SEV3 (مشاكل طفيفة)
- **السبب**: أخطاء UI طفيفة، مشاكل في التصميم
- **الوقت المستهدف**: خلال يوم عمل
- **الإجراء**: إصلاح سريع أو رجوع حسب الأثر

## إجراءات الاسترجاع التفصيلية

### 1. تقييم الوضع (الخطوات الأولى)

#### فحص حالة التطبيق:
```bash
# فحص حالة التحديثات
eas update:list --branch production

# فحص السجلات والأخطاء
eas diagnostics

# فحص تقارير الأعطال (إذا كان متاحاً)
# استخدم خدمات مثل Sentry أو Bugsnag
```

#### فحص تجربة المستخدم:
```bash
# فحص تقييمات التطبيق في المتاجر
# مراقبة وسائل التواصل الاجتماعي
# فحص تقارير الدعم الفني
```

### 2. تحديد الإصدار المستهدف للرجوع
```bash
# قائمة التحديثات المتاحة مرتبة بالتاريخ
eas update:list --branch production --limit 10

# فحص تفاصيل تحديث معين
eas update:view --id UPDATE_ID

# فحص runtime version الحالية
cat app.json | jq -r '.expo.runtimeVersion'
```

### 3. إجراء الرجوع

#### رجوع OTA Update (موصى به للتحديثات السريعة)
```bash
# 1. إنشاء تحديث رجوع إلى الإصدار السابق
eas update --branch production \
  --message "Rollback to previous version" \
  --runtime-version "exponent.sdk.50.0" \
  --input-json rollback-update.json

# 2. التحقق من نشر التحديث
eas update:list --branch production

# 3. إجبار تحديث التطبيق للمستخدمين
# يمكن استخدام remote config لإجبار التحديث
```

#### رجوع Build Update (للتحديثات الكبيرة)
```bash
# إعادة نشر آخر build مستقر
eas update --branch production \
  --message "Emergency rollback build" \
  --runtime-version "exponent.sdk.50.0" \
  --build-id "PREVIOUS_BUILD_ID"

# أو إعادة بناء الإصدار السابق
git checkout PREVIOUS_COMMIT
eas build --platform all --profile production
```

#### رجوع يدوي عبر Expo Go (للاختبار فقط)
```bash
# تغيير القناة مؤقتاً للاختبار
expo start --clear --branch staging

# فحص أن الرجوع يعمل في بيئة الاختبار
# اختبار التطبيق على عدة أجهزة حقيقية
```

### 4. اختبار ما بعد الاسترجاع

#### فحص الصحة الأساسية:
```bash
# فحص أن التحديث متاح
eas update:list --branch production | grep -A 5 -B 5 "ROLLBACK_UPDATE"

# فحص حالة الخدمات المرتبطة
curl -f https://api.bthwani.com/health

# فحص قاعدة البيانات
mongosh "$MONGO_URI" --eval "db.stats()"
```

#### اختبار 3 شاشات أساسية:
```bash
#!/bin/bash
# اختبار شامل للتطبيق بعد الرجوع

echo "Testing mobile app after rollback..."

# 1. فحص شاشة تسجيل الدخول
echo "1. Testing login screen..."
# يدوي: فتح التطبيق والتأكد من عدم وجود أخطاء في الشاشة الرئيسية

# 2. فحص شاشة الطلبات/المنتجات
echo "2. Testing orders/products screen..."
# يدوي: التنقل إلى قسم الطلبات والتأكد من تحميل البيانات

# 3. فحص شاشة الملف الشخصي/الإعدادات
echo "3. Testing profile/settings screen..."
# يدوي: فتح الإعدادات والتأكد من عمل جميع الوظائف

echo "All basic screens tested!"
```

#### رحلة "تصفح→سلة→دفع" على قناة staging:
```bash
# اختبار سيناريو كامل على قناة staging بعد الرجوع

echo "Testing complete user journey on staging..."

# 1. تصفح المنتجات
# يدوي: فتح التطبيق على staging، تصفح المنتجات، إضافة للسلة

# 2. فحص السلة
# يدوي: فتح السلة والتأكد من احتساب الأسعار بشكل صحيح

# 3. عملية الدفع
# يدوي: إتمام عملية دفع تجريبية والتأكد من نجاحها

# 4. فحص حالة الطلب
# يدوي: فحص حالة الطلب في قسم الطلبات

echo "Complete journey test completed!"
```

## مراقبة ما بعد الاسترجاع

### مؤشرات النجاح:
1. **تحديث التطبيق**: يظهر للمستخدمين بدون أخطاء
2. **الوظائف الأساسية**: تسجيل الدخول، التصفح، الطلبات تعمل
3. **الأداء**: لا يوجد بطء أو استهلاك زائد للبطارية
4. **الاستقرار**: عدم وجود أعطال متكررة
5. **تجربة المستخدم**: سلسة ومرضية

### مراقبة مستمرة:
```bash
# مراقبة تقييمات التطبيق
# فحص وسائل التواصل الاجتماعي للشكاوى

# مراقبة استخدام التطبيق
# استخدام أدوات مثل Firebase Analytics أو Mixpanel

# مراقبة الأعطال
# فحص تقارير Sentry أو Bugsnag للأخطاء الجديدة
```

### أدوات مراقبة مفيدة:
```bash
# فحص حالة تحديثات Expo
eas update:list --branch production

# فحص بناءات التطبيق
eas build:list

# فحص حالة الخدمات
curl -f https://api.expo.dev/v2/projects/PROJECT_ID/updates
```

## جدولة الاسترجاع

### متى يتم الاسترجاع؟
1. **فوراً**: إذا تعطل التطبيق أو توقفت وظائف أساسية
2. **خلال ساعة**: إذا تأثرت تجربة مستخدمين كثر
3. **خلال يوم عمل**: إذا كانت مشاكل طفيفة في واجهة المستخدم

### من يقرر الاسترجاع؟
- **SEV1**: فريق DevOps + Mobile Lead فوراً
- **SEV2**: Product Manager + Technical Lead
- **SEV3**: فريق التطوير بعد تقييم الأثر

## التوثيق والتقارير

### بعد كل استرجاع:
1. **تسجيل الحادث**: في نظام إدارة الحوادث
2. **تحليل السبب الجذري**: اجتماع Post-Mortem
3. **تحسين العملية**: تحديث هذا الدليل إن لزم الأمر
4. **إشعار الفرق المعنية**: عبر Slack/Email

### نموذج تقرير الاسترجاع:
```markdown
# تقرير استرجاع التطبيقات [التاريخ]

## تفاصيل الحادث
- **الوقت**: YYYY-MM-DD HH:MM
- **المستوى**: SEV1/SEV2/SEV3
- **السبب**: وصف مختصر للمشكلة (مثل: خطأ في الـ API، مشكلة في UI)

## إجراءات الاسترجاع
- **نوع الرجوع**: OTA Update / Build Update
- **الإصدار المسترجع إليه**: apps-vYYYY.MM.DD-HHMM
- **رقم التحديث**: UPDATE_ID أو BUILD_ID
- **وقت البدء**: HH:MM
- **وقت الانتهاء**: HH:MM
- **المدة الإجمالية**: XM

## نتائج الاختبار
- [ ] 3 شاشات أساسية تعمل بدون أخطاء
- [ ] رحلة "تصفح→سلة→دفع" تنجح على staging
- [ ] لا توجد أخطاء في Console
- [ ] الأداء طبيعي (لا بطء أو استهلاك زائد)
- [ ] لا تقارير أعطال جديدة

## الدروس المستفادة
- [وصف الدرس المستفاد والتحسينات المقترحة]
- [اقتراحات لتحسين عملية النشر والاختبار]
```

## ملحقات

### أوامر مفيدة للاسترجاع السريع:
```bash
# فحص التحديثات الحالية
eas update:list --branch production

# قائمة البناءات المتاحة
eas build:list

# فحص تفاصيل تحديث معين
eas update:view --id UPDATE_ID

# فحص إحصائيات التحديثات
eas update:analytics --branch production --days 7
```

### نقاط الاتصال للطوارئ:
- **Slack**: #mobile-emergency
- **Email**: mobile-team@bthwani.com
- **Phone**: +966-XX-XXXXXXX (Mobile Lead)

### نصائح لتسريع الاسترجاع:
1. **اختبار شامل قبل النشر**: اختبر في staging مع عدة أجهزة حقيقية
2. **مراقبة مستمرة**: استخدم أدوات مراقبة للكشف المبكر عن المشاكل
3. **نسخ احتياطية منتظمة**: احتفظ بنسخ من التحديثات السابقة
4. **توثيق الإجراءات**: سجل جميع خطوات النشر والاسترجاع

### جداول التحديثات المهمة:
| Runtime Version | Expo SDK | ملاحظات |
|----------------|----------|-----------|
| exponent.sdk.50.0 | SDK 50 | إصدار مستقر حالي |
| exponent.sdk.49.0 | SDK 49 | متوافق مع الإصدارات السابقة |
| exponent.sdk.48.0 | SDK 48 | للأجهزة القديمة |

---
**تاريخ آخر تحديث**: 15 يناير 2025
**الإصدار**: 1.0.0
**مسؤول الصيانة**: فريق DevOps
