# سياسة التدقيق والاحتفاظ بالبيانات

## نظرة عامة
سياسة شاملة لنظام التدقيق (Audit Log) وسياسات الاحتفاظ بالبيانات في نظام Bthwani، مع الالتزام بمعايير الامتثال والخصوصية.

## أهداف السياسة

### 1. ضمان الامتثال القانوني
- الامتثال لقوانين حماية البيانات (GDPR، CCPA)
- الامتثال لمعايير الأمان المالي (PCI DSS)
- الامتثال لمعايير إدارة المخاطر (ISO 27001)

### 2. تعزيز الأمان والحماية
- تتبع جميع العمليات الحساسة
- كشف الأنشطة المشبوهة
- منع الاحتيال والتلاعب

### 3. تسهيل التدقيق والمراجعة
- توفير سجلات مفصلة للعمليات
- تسهيل التحقيقات الداخلية والخارجية
- دعم عمليات الرجوع والتعافي

## نطاق التطبيق

### العمليات المشمولة بالتدقيق
تُسجل جميع العمليات التالية تلقائياً:

#### 1. عمليات الإدارة والتكوين
- إنشاء وتعديل وحذف المستخدمين الإداريين
- تغيير الأدوار والصلاحيات
- تعديل إعدادات النظام
- إدارة خطط العمولات والتسعير

#### 2. العمليات المالية
- معالجة طلبات السحب والإيداع
- إنشاء وتعديل المعاملات المالية
- تعديل أرصدة المحافظ
- معالجة عمليات الدفع والاسترداد

#### 3. إدارة المحتوى والمنتجات
- إنشاء وتعديل وحذف المنتجات
- إدارة الفئات والتصنيفات
- تعديل أسعار المنتجات
- إدارة العروض والحملات الترويجية

#### 4. إدارة المستخدمين والعملاء
- تسجيل المستخدمين الجدد
- تعديل بيانات المستخدمين
- إدارة حالات الحسابات
- معالجة الشكاوى والدعم الفني

#### 5. العمليات التقنية
- نشر التحديثات والإصدارات الجديدة
- صيانة قاعدة البيانات
- إدارة النسخ الاحتياطية
- مراقبة الأمان والأداء

## مستويات التدقيق

### المستوى 1: العمليات الحساسة (SEV1)
**الوصف**: عمليات تؤثر مباشرة على الأمان أو المال أو البيانات الحساسة
**أمثلة**:
- تغيير كلمات المرور للحسابات الإدارية
- معالجة معاملات مالية كبيرة
- حذف بيانات مستخدمين
- تغيير إعدادات الأمان الأساسية

**فترة الاحتفاظ**: 7 سنوات (امتثال قانوني)

### المستوى 2: العمليات المهمة (SEV2)
**الوصف**: عمليات تؤثر على تجربة المستخدم أو الوظائف الأساسية
**أمثلة**:
- تعديل أسعار المنتجات
- إدارة طلبات العملاء
- تعديل محتوى الموقع
- إدارة الحملات التسويقية

**فترة الاحتفاظ**: 3 سنوات

### المستوى 3: العمليات العادية (SEV3)
**الوصف**: عمليات روتينية لا تؤثر مباشرة على الأمان أو البيانات الحساسة
**أمثلة**:
- تسجيل الدخول والخروج
- عرض الصفحات والمحتوى
- البحث والتصفح
- تحديثات الواجهة

**فترة الاحتفاظ**: 1 سنة

## سياسات الاحتفاظ بالبيانات

### فترات الاحتفاظ حسب نوع البيانات

#### 1. سجلات التدقيق (Audit Logs)
- **الاحتفاظ الأساسي**: 365 يوم (1 سنة)
- **الاحتفاظ للامتثال القانوني**: 7 سنوات لبعض العمليات الحساسة
- **الاحتفاظ للتحقيقات**: حتى انتهاء التحقيق أو النزاع

#### 2. بيانات المستخدمين الشخصية
- **البيانات الأساسية**: 3 سنوات بعد آخر تفاعل
- **البيانات المالية**: 7 سنوات (متطلبات قانونية)
- **بيانات التواصل**: 2 سنوات بعد آخر تواصل

#### 3. بيانات المعاملات المالية
- **سجلات الطلبات**: 7 سنوات
- **سجلات الدفع**: 7 سنوات
- **سجلات المحافظ**: 7 سنوات

#### 4. بيانات التحليلات والإحصائيات
- **البيانات المجمعة**: بدون حد زمني (غير مرتبطة بأفراد)
- **البيانات الشخصية المؤقتة**: 90 يوماً

### آليات الاحتفاظ والحذف

#### الحذف التلقائي (TTL - Time To Live)
```javascript
// في MongoDB - يُفعل حسب المتطلبات
AdminLogSchema.index({ createdAt: 1 }, {
  expireAfterSeconds: 365 * 24 * 60 * 60 // 365 يوم
});
```

#### الحذف اليدوي حسب الطلب (GDPR)
```bash
# حذف بيانات مستخدم محدد
mongosh "$MONGO_URI" --eval "
db.users.deleteOne({email: 'user@example.com'});
db.orders.deleteMany({userId: ObjectId('...')});
db.auditlogs.deleteMany({actorId: ObjectId('...')});
"
```

#### الأرشفة قبل الحذف
```bash
# نقل السجلات القديمة إلى نظام أرشفة
mongodump --uri "$MONGO_URI" \
  --query '{"createdAt": {"$lt": "2024-01-01"}}' \
  --archive=old-audit-logs.gz

# حذف السجلات القديمة بعد الأرشفة
mongosh "$MONGO_URI" --eval "
db.auditlogs.deleteMany({'createdAt': {'$lt': '2024-01-01'}});
"
```

## سياسات الخصوصية والحماية

### مبادئ حماية البيانات (Data Protection Principles)

#### 1. الحد الأدنى من البيانات (Data Minimization)
- تسجيل البيانات الضرورية فقط
- عدم تسجيل كلمات المرور أو البيانات المالية الحساسة
- تلخيص البيانات بدلاً من التفاصيل الكاملة

#### 2. الغرض المحدد (Purpose Limitation)
- تحديد الغرض من جمع كل نوع من البيانات
- عدم استخدام البيانات لأغراض أخرى غير محددة
- إخطار المستخدمين بالغرض من جمع البيانات

#### 3. الدقة والحداثة (Accuracy)
- ضمان دقة البيانات المسجلة
- تحديث البيانات بانتظام
- تصحيح الأخطاء فور اكتشافها

### إجراءات الحماية الفنية

#### التشفير والأمان
```javascript
// تشفير البيانات في قاعدة البيانات
AdminLogSchema.plugin(encrypt, {
  encryptionKey: process.env.ENCRYPTION_KEY,
  encryptedFields: ['details', 'userAgent']
});

// تشفير البيانات أثناء النقل
// استخدام HTTPS/TLS لجميع الاتصالات
// تشفير النسخ الاحتياطية
```

#### مراقبة الوصول
```javascript
// صلاحيات محدودة للوصول إلى سجلات التدقيق
const auditPermissions = {
  'admin.audit': {
    read: ['superadmin', 'compliance-officer'],
    write: ['system'],
    delete: ['compliance-officer']
  }
};
```

## الامتثال للمعايير والقوانين

### 1. اللائحة العامة لحماية البيانات (GDPR)

#### حقوق المستخدمين تحت GDPR:
- **الحق في الوصول**: إمكانية طلب نسخة من البيانات الشخصية
- **الحق في التصحيح**: إمكانية تصحيح البيانات غير الدقيقة
- **الحق في المحو**: إمكانية طلب حذف البيانات الشخصية
- **الحق في تقييد المعالجة**: إمكانية تقييد استخدام البيانات

#### آلية الامتثال:
```bash
# استخراج بيانات مستخدم محدد للامتثال GDPR
mongosh "$MONGO_URI" --eval "
db.users.findOne({email: 'user@example.com'}, {password: 0});
db.orders.find({userId: ObjectId('...')});
db.auditlogs.find({actorId: ObjectId('...')});
"
```

### 2. معايير صناعة بطاقات الدفع (PCI DSS)

#### متطلبات PCI DSS المعمول بها:
- حماية بيانات حاملي البطاقات
- تشفير البيانات المالية الحساسة
- مراقبة الوصول إلى البيانات المالية
- تسجيل جميع عمليات الوصول إلى البيانات المالية

### 3. معايير إدارة الأمان (ISO 27001)

#### ضوابط ISO 27001 المُطبقة:
- **A.9**: ضوابط الوصول
- **A.12**: تشغيل آمن
- **A.16**: إدارة الحوادث والتحسينات
- **A.18**: الامتثال

## إجراءات التحقق والمراجعة

### المراجعة الداخلية الدورية

#### مراجعة أسبوعية:
- فحص سلامة سجلات التدقيق
- التأكد من عدم وجود فجوات في التسجيل
- مراجعة محاولات الوصول غير المصرح بها

#### مراجعة شهرية:
- تحليل اتجاهات العمليات الحساسة
- مراجعة فعالية ضوابط الأمان
- تحديث سياسات الاحتفاظ

#### مراجعة ربع سنوية:
- مراجعة شاملة للامتثال للمعايير
- اختبار إجراءات الرجوع والتعافي
- تحديث السياسات والإجراءات

### المراجعة الخارجية

#### مراجعة سنوية بواسطة مدقق خارجي:
- تقييم الامتثال للمعايير المختلفة
- اختبار ضوابط الأمان
- مراجعة سياسات الاحتفاظ والحماية

## إدارة الحوادث والتحقيقات

### إجراءات التحقيق في الحوادث الأمنية

#### خطوات التحقيق:
1. **العزل**: فصل الأنظمة المتأثرة
2. **الجمع**: جمع السجلات والأدلة
3. **التحليل**: تحليل السبب الجذري
4. **الإصلاح**: تطبيق الإصلاحات اللازمة
5. **التوثيق**: توثيق الحادث والدروس المستفادة

#### أدوات التحقيق:
```bash
# استخراج سجلات تدقيق محددة للتحقيق
curl -s "https://api.bthwani.com/admin/audit-logs?q=payment&dateFrom=2025-01-01"

# فحص أنشطة مستخدم محدد
curl -s "https://api.bthwani.com/admin/audit-logs?actorId=USER_ID"

# تحليل الأنشطة المشبوهة
curl -s "https://api.bthwani.com/admin/audit-logs?action=DELETE&status=error"
```

### الإبلاغ عن الحوادث

#### متطلبات الإبلاغ:
- **الحوادث الأمنية الكبرى**: إبلاغ خلال 24 ساعة
- **الحوادث المالية**: إبلاغ فوري للجهات المعنية
- **انتهاكات البيانات**: إبلاغ خلال 72 ساعة (GDPR)

## التدريب والتوعية

### برامج التدريب المطلوبة

#### 1. تدريب الموظفين الجدد
- **المدة**: أسبوعين
- **المحتوى**:
  - أساسيات الخصوصية والأمان
  - سياسات الاحتفاظ بالبيانات
  - إجراءات التعامل مع البيانات الحساسة

#### 2. تدريب الفريق التقني
- **المدة**: شهرياً
- **المحتوى**:
  - أحدث ممارسات الأمان
  - تحديثات على سياسات التدقيق
  - تمارين عملية للتعامل مع الحوادث

#### 3. تدريب الإدارة
- **المدة**: ربع سنوي
- **المحتوى**:
  - متطلبات الامتثال القانوني
  - إدارة المخاطر
  - اتخاذ القرارات في الحالات الحرجة

## التحديث والصيانة

### مراجعة وتحديث السياسة

#### المراجعة الدورية:
- **شهرية**: مراجعة الإجراءات والتحديثات
- **ربع سنوية**: مراجعة شاملة للامتثال
- **سنوية**: مراجعة استراتيجية كاملة

#### تحديث السياسة:
- **مع كل تغيير قانوني**: تحديث فوري للامتثال
- **مع التحديثات التقنية**: تحديث الإجراءات المتأثرة
- **بعد الحوادث**: تحديث بناءً على الدروس المستفادة

### نسخ احتياطية من السياسة
```bash
# حفظ نسخة من السياسة الحالية قبل التحديث
cp AUDIT_AND_RETENTION_POLICY.md "AUDIT_AND_RETENTION_POLICY_$(date +%Y%m%d).md"

# تحديث السياسة
# ... إجراءات التحديث ...

# حفظ نسخة من السياسة الجديدة
cp AUDIT_AND_RETENTION_POLICY.md AUDIT_AND_RETENTION_POLICY_CURRENT.md
```

## الملحقات

### قائمة مراجعة الامتثال السريع

#### أسبوعياً:
- [ ] فحص سلامة سجلات التدقيق
- [ ] مراجعة محاولات الوصول غير المصرح بها
- [ ] فحص استخدام مساحة التخزين

#### شهرياً:
- [ ] تحليل اتجاهات العمليات الحساسة
- [ ] مراجعة فعالية ضوابط الأمان
- [ ] اختبار إجراءات الرجوع

#### ربع سنوياً:
- [ ] مراجعة شاملة للامتثال للمعايير
- [ ] اختبار شامل للنسخ الاحتياطية والتعافي
- [ ] تحديث السياسات والإجراءات

### نموذج طلب حذف البيانات (GDPR)
```markdown
# طلب حذف البيانات الشخصية

**المعلومات المطلوبة:**
- اسم المستخدم الكامل
- عنوان البريد الإلكتروني
- رقم الهاتف (إن وجد)
- تاريخ آخر تفاعل

**البيانات المطلوب حذفها:**
- [ ] بيانات الحساب الأساسية
- [ ] سجل الطلبات والمعاملات
- [ ] سجلات التدقيق المتعلقة بالحساب
- [ ] البيانات التحليلية والإحصائية

**تاريخ الطلب:** YYYY-MM-DD
**تاريخ التنفيذ:** خلال 30 يوماً من تاريخ الطلب
```

### جهات الاتصال للاستفسارات

#### فريق الامتثال والخصوصية:
- **مسؤول الامتثال**: compliance@bthwani.com
- **مسؤول حماية البيانات**: dpo@bthwani.com
- **فريق الأمان**: security@bthwani.com

#### الجهات الخارجية:
- **المحامي الخارجي**: legal@bthwani.com
- **مدقق الحسابات**: audit@bthwani.com

---

## ملخص السياسات الرئيسية

### فترات الاحتفاظ:
- **سجلات التدقيق**: 1-7 سنوات حسب المستوى
- **البيانات الشخصية**: 3-7 سنوات حسب النوع
- **البيانات المالية**: 7 سنوات

### ضوابط الأمان:
- **التشفير**: مطلوب للبيانات الحساسة
- **مراقبة الوصول**: صلاحيات محدودة ومراقبة
- **النسخ الاحتياطية**: يومية مشفرة ومختبرة

### الامتثال:
- **GDPR**: احترام حقوق المستخدمين
- **PCI DSS**: حماية البيانات المالية
- **ISO 27001**: إدارة الأمان الشاملة

---

**تاريخ آخر تحديث**: 15 يناير 2025
**الإصدار**: 3.0.0
**مسؤول الصيانة**: فريق الامتثال والأمان
**تاريخ المراجعة التالية**: 15 أبريل 2025
