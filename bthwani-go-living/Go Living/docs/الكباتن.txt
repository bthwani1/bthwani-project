0) التحضير والحوكمة

 ضبط المنطقة الزمنية TZ=Asia/Aden في السيرفر والكرونات
تم عندما: تقارير يوم واحد تطابق التقويم المحلي.

 توحيد المعرّفات: driver = Driver._id كنص/‎ObjectId موحّد في كل النماذج والمسارات
تم عندما: لا تُستخدم حقول معرّف متباينة للسائق.

 تفعيل Feature Flag لتبويب “الكباتن” في لوحة التحكم
تم عندما: يمكن إظهار/إخفاء التبويب دون نشر جديد.

 تعريف RBAC: drivers:read, drivers:write, drivers:assets, drivers:shifts, drivers:finance
تم عندما: الوصول للمسارات يُحترم حسب الصلاحيات (403 عند نقصها).

1) نماذج البيانات والفهارس (Mongo/Mongoose)

 DriverAttendanceSession
الحقول: driver,startAt,endAt?,startLoc,endLoc,deviceInfo?,status('open'|'closed')
فهرس: { driver:1, startAt:-1 }
تم عندما: لا تتواجد جلستان مفتوحتان للسائق نفسه.

 DriverAttendanceDaily
الحقول: driver,day,totalOnlineMins,firstCheckInAt,lastCheckOutAt,ordersDelivered,distanceKm,breaksCount,shiftsMatched[]
فريد: { driver, day }
تم عندما: يوم واحد لكل سائق.

 DriverShift / DriverShiftAssignment
الحقول: name, dayOfWeek|specificDate, startLocal,endLocal,area?,capacity? وshiftId,driver,status,checkInAt,checkOutAt
فريد: { shiftId, driver }
تم عندما: لا يتكرر إسناد الشِفت للسائق نفسه.

 DriverAsset / DriverAssetAssignment
الحقول: code(unique),type,brand,model,serial?,status وasset,driver,assignedAt,expectedReturnAt?,returnedAt?,depositAmount?,status
قيد: أصل واحد لا يكون “مُسلّم” لشخصين في آنٍ واحد
تم عندما: المنظومة تمنع الازدواجية تلقائيًا.

 DriverDocument
الحقول: driver,type,number,issuedAt?,expiresAt?,fileUrl,status
فهرس: { expiresAt:1 }
تم عندما: جلب المستندات المنتهية/المقتربة سريع.

 DriverAdjustment (مكافأة/خصم) & DriverPayoutCycle (التسويات)
الحقول: driver,type,amount,reason,ref,createdBy وperiod,start,end,earnings,adjustments,fees,withdrawals,net,status,reference
فريد للتسوية: { driver, start, end }
تم عندما: تسوية واحدة لكل نافذة زمنيّة.

تشغيل syncIndexes() بعد اتصال قاعدة البيانات، وفرض validate() للحقول الحساسة.

2) الوسطيات والحماية

 Helmet + CORS + Rate-Limit لمسارات الكتابة
تم عندما: تجاوز الحد يُرجع 429.

 Zod validate() لكل POST/PATCH (استخدم ZodTypeAny) بصيغة أخطاء موحّدة {message,errors[]}
تم عندما: الطلبات غير الصالحة تُرفض بـ400 ورسالة واضحة.

 requireRole لكل مسارات /api/v1/admin/* وذات الصلة
تم عندما: الأدوار تُطبق بدقة.

 منع IDOR: تجاهل معرّفات حساسة قادمة من العميل عند التعارض مع الـclaims
تم عندما: أي محاولة تغيير غير مصرّح تُرفض.

3) مسارات الـAPI (Express + TS + axios-friendly)
3.1 الحضور/الغياب

 POST /api/v1/drivers/:id/attendance/check-in (lat,lng,deviceInfo?)
تم عندما: يفتح Session جديدة إذا لا توجد مفتوحة.

 POST /api/v1/drivers/:id/attendance/check-out (lat,lng)
تم عندما: تُغلق الجلسة وتُسجّل endLoc.

 GET /api/v1/drivers/:id/attendance/daily?from&to
تم عندما: يُرجع سلسلة يومية مرتبة.

 (أدمن) GET /api/v1/admin/drivers/attendance?day=YYYY-MM-DD&status (online_now/absent/attended)
تم عندما: إحصاءات اليوم صحيحة.

 (أدمن) PATCH /api/v1/admin/drivers/attendance/sessions/:sessionId/force-close
تم عندما: يغلق الجلسات المعلّقة بأمان.

3.2 الشِفتات

 (أدمن) POST /api/v1/admin/driver-shifts (إنشاء)

 (أدمن) POST /api/v1/admin/driver-shifts/:id/assign (driverId[])

 (أدمن) GET /api/v1/admin/driver-shifts?from&to&driver

 (أدمن) PATCH /api/v1/admin/driver-shifts/:id (تعديل أوقات/سعة)

 (أدمن) PATCH /api/v1/admin/driver-shifts/:id/mark (attended/absent/late لكل سائق)
تم عندما: حالات الحضور للشِفت تتحدّث بدقة.

3.3 العُهَد/الأصول

 (أدمن) POST /api/v1/admin/driver-assets (إضافة أصل)

 (أدمن) POST /api/v1/admin/driver-assets/:assetId/assign (driverId, deposit?, expectedReturnAt?)

 (أدمن) POST /api/v1/admin/driver-assets/:assetId/return (conditionOnReturn, notes)

 (أدمن) GET /api/v1/admin/driver-assets?status&type&driver
تم عندما: تدفق التسليم/الاستلام يمنع الازدواجية ويُسجّل الإيداع/الحالة.

3.4 المستندات

 POST /api/v1/drivers/:id/docs (metadata + fileUrl/Presigned)

 (أدمن) PATCH /api/v1/admin/drivers/docs/:docId (approve/reject)

 (أدمن) GET /api/v1/admin/drivers/docs/expiring?days=30
تم عندما: تظهر تحذيرات الانتهاء بدقة.

3.5 الإجازات (تكامل الموجود)

 (أدمن) GET /api/v1/admin/driver-vacations?status&from&to&driver

 عند الموافقة: تحقّق عدم تعارضها مع شِفتات/جلسات مفتوحة
تم عندما: لا تُنشأ تعارضات زمنية.

3.6 المالية والتسويات

 (أدمن) POST /api/v1/admin/drivers/:id/adjustments (type=bonus|penalty, amount, reason)
تم عندما: تُسجَّل وتنعكس على رصيد/تقرير السائق حسب السياسة.

 (أدمن) POST /api/v1/admin/driver-payouts/run?period=weekly|biweekly|monthly&from&to

 (أدمن) GET /api/v1/admin/driver-payouts?from&to&status&driver

 (أدمن) PATCH /api/v1/admin/driver-payouts/:id/approve|pay (reference)
تم عندما: Net = Earnings ± Adjustments − Fees − Withdrawals صحيح.

4) الكرونات والتجميعات (TZ=Asia/Aden)

 buildAttendanceDaily (يومي 01:15): يحسب دقائق الأونلاين + أوامر اليوم + المسافات → يكتب في DriverAttendanceDaily
تم عندما: يوم الأمس يظهر مكتملًا لكل سائق.

 markShiftAttendance (كل 15 دقيقة خلال الشِفت): يوسم attended/late/absent تلقائيًا
تم عندما: الحالات تعكس الواقع بزمن مقبول.

 expiringDocs (يومي 02:00): يجمع مستندات ستنتهي خلال N يوم ويولّد تنبيهات
تم عندما: قائمة دقيقة تُحدّث يوميًا.

 buildPayouts (أسبوعي/نصف شهري/شهري): يحسب Net لكل سائق ويُنشئ دورة تسوية
تم عندما: تنشأ دورات بدون ازدواجية (unique).

5) الواجهة (React + TS + axios + Box/Flex، RTL)
5.1 لوحة المؤشرات (Drivers Ops Home)

 بطاقات: أونلاين الآن، داخل شِفت الآن، غائبون اليوم، وثائق تنتهي خلال 30 يوم، عُهَد متأخرة
تم عندما: الأرقام تحدّث فور تغيير الحالة.

 جداول صغيرة: أفضل أداء 7/30 يوم، أحدث Check-in/out
تم عندما: الترتيب صحيح والتحميل سريع.

5.2 قائمة السائقين

 مرشّحات: بحث، الحالة (active/banned)، النوع (primary/joker)، داخل شِفت/أونلاين الآن

 أعمدة: الاسم، الهاتف، الحالة، آخر Check-in، دقائق اليوم، تسليمات اليوم، عُهَد فعّالة، مستندات (تنبيه)
تم عندما: تبديل المرشّحات يُعيد القائمة سريعًا (≤1s).

5.3 صفحة السائق (Tabbed)

 Overview: بطاقة عامة + KPIs 7/30 يوم (تسليمات/مسافة/أرباح)

 Attendance: جدول أيام + جلسات اليوم/الماضي، تصدير CSV

 Shifts: الشِفتات القادمة/الماضية + حالة الحضور

 Leaves: طلبات الإجازة والموافقة/الرفض

 Assets: العُهَد المسلّمة + أزرار تسليم/استلام

 Documents: رفع/مراجعة/تحذير صلاحية

 Finance: Adjustments، Payout Cycles، Withdrawals
تم عندما: كل تبويب يعمل ويعرض حالات Loading/Empty/Error موحّدة.

مهم: كل النداءات عبر axios (عميل مشترك + interceptor)، وBox/Flex فقط (بدون Grid).

6) التكاملات التشغيلية

 تسجيل startLoc/endLoc عند check-in/out من تطبيق السائق (إن توفر)
تم عندما: تُحفظ الإحداثيات وتظهر في تفاصيل الجلسة.

 ربط orders في التجميع اليومي لاستخراج ordersDelivered وdistanceKm
تم عندما: أرقام التسليم/المسافة متطابقة مع سجل الطلبات.

 منع تعارض الإجازات مع الشِفتات وجلسات الحضور
تم عندما: موافقة الإجازة تفشل عند وجود تعارض.

7) الرصد والجودة

 Sentry + لوغ مُهيكل (API + Cron)
تم عندما: أي خطأ يظهر مع Trace مفيد.

 Health endpoints للكرونات (آخر تشغيل/مدة/عدد مُحدّث)
تم عندما: المراقبة الخارجية ترى الحالة بسهولة.

 Seed بيانات: سائقون متنوعون + جلسات + شِفتات + عُهَد + مستندات + إجازات
تم عندما: الواجهة تُظهر بيانات واقعية للاختبار.

 اختبارات قبول

check-in/out يُنشئ/يغلق جلسات صحيحة

تجميع يومي يكتب يومًا واحدًا لكل سائق

الشِفت يُوسم الحضور/التأخير تلقائيًا

تدفق العُهَد يمنع الازدواجية

كشف المستندات المنتهية دقيق

تسوية أسبوعية Net صحيح

RBAC يمنع الوصول غير المصرّح

8) الإطلاق والتشغيل

 Runbook: إعادة فهارس، إعادة احتساب يوم محدد، تدوير مفاتيح، Kill-switch للكرونات، إجراءات طوارئ
تم عندما: الوثيقة مُجرّبة داخليًا.

 بيتا داخلية لفريق العمليات
تم عندما: ملاحظات التشغيل تُدمج في أول تحديث صيانة.

 Backfill لآخر 60–90 يومًا من الحضور/الأداء
تم عندما: السلاسل الزمنية مكتملة للعرض من اليوم الأول.

9) تحسينات لاحقة (Phase-2)

 Realtime (SSE/WebSocket) لتحديث الأعداد والحالات فورًا

 جغرافيا المناطق (Geo-fencing) للشِفتات والحضور

 نقاط/مكافآت gamification وLeaderboard

 توصيات جدولة ذكية حسب الطلب التاريخي

 تطبيق سياسات متقدمة للغرامات (Late/No-show) مرتبطة تلقائيًا بالتسويات

 تصدير CSV/PDF للتقارير المالية والحضور

خريطة ملفات مقترحة (لتسهيل التنفيذ)

Backend
models/{DriverAttendanceSession,DriverAttendanceDaily,DriverShift,DriverShiftAssignment,DriverAsset,DriverAssetAssignment,DriverDocument,DriverAdjustment,DriverPayoutCycle}.ts
routes/admin/{drivers.attendance.ts,drivers.shifts.ts,drivers.assets.ts,drivers.docs.ts,drivers.finance.ts}
routes/drivers/attendance.ts
crons/drivers/{buildAttendanceDaily.ts,markShiftAttendance.ts,expiringDocs.ts,buildPayouts.ts}
middleware/{validate.ts,rbac.ts}

Frontend
src/utils/api/axiosWeb.ts
src/pages/ops/drivers/{Dashboard.tsx,DriversList.tsx,DriverDetails.tsx}
src/pages/ops/drivers/tabs/{Overview.tsx,Attendance.tsx,Shifts.tsx,Leaves.tsx,Assets.tsx,Documents.tsx,Finance.tsx}
(كلها باستخدام Box/Flex وaxios فقط)