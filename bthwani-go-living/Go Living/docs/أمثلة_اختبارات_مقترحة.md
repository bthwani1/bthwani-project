# 🧪 أمثلة اختبارات مقترحة - bThwaniApp

## 📋 مقدمة

هذا الملف يحتوي على أمثلة عملية للاختبارات المقترحة للملفات التي تحتاج تحسين في التغطية.

---

## 🔐 اختبارات شاشات المصادقة

### 1. **LoginScreen.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import LoginScreen from '../../screens/Auth/LoginScreen';

// Mock navigation
const mockNavigate = jest.fn();
const mockGoBack = jest.fn();

jest.mock('@react-navigation/native', () => ({
  ...jest.requireActual('@react-navigation/native'),
  useNavigation: () => ({
    navigate: mockNavigate,
    goBack: mockGoBack,
  }),
}));

// Mock API calls
jest.mock('../../api/authService', () => ({
  loginUser: jest.fn(),
}));

describe('LoginScreen', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('يجب أن يعرض نموذج تسجيل الدخول', () => {
    render(
      <NavigationContainer>
        <LoginScreen />
      </NavigationContainer>
    );

    expect(screen.getByPlaceholderText('البريد الإلكتروني')).toBeTruthy();
    expect(screen.getByPlaceholderText('كلمة المرور')).toBeTruthy();
    expect(screen.getByText('تسجيل الدخول')).toBeTruthy();
  });

  test('يجب أن يتحقق من صحة البريد الإلكتروني', async () => {
    render(
      <NavigationContainer>
        <LoginScreen />
      </NavigationContainer>
    );

    const emailInput = screen.getByPlaceholderText('البريد الإلكتروني');
    fireEvent.changeText(emailInput, 'invalid-email');

    const loginButton = screen.getByText('تسجيل الدخول');
    fireEvent.press(loginButton);

    await waitFor(() => {
      expect(screen.getByText('البريد الإلكتروني غير صحيح')).toBeTruthy();
    });
  });

  test('يجب أن يتحقق من صحة كلمة المرور', async () => {
    render(
      <NavigationContainer>
        <LoginScreen />
      </NavigationContainer>
    );

    const passwordInput = screen.getByPlaceholderText('كلمة المرور');
    fireEvent.changeText(passwordInput, '123');

    const loginButton = screen.getByText('تسجيل الدخول');
    fireEvent.press(loginButton);

    await waitFor(() => {
      expect(screen.getByText('كلمة المرور يجب أن تكون 6 أحرف على الأقل')).toBeTruthy();
    });
  });

  test('يجب أن يتعامل مع أخطاء تسجيل الدخول', async () => {
    const mockLoginUser = require('../../api/authService').loginUser;
    mockLoginUser.mockRejectedValue(new Error('خطأ في تسجيل الدخول'));

    render(
      <NavigationContainer>
        <LoginScreen />
      </NavigationContainer>
    );

    const emailInput = screen.getByPlaceholderText('البريد الإلكتروني');
    const passwordInput = screen.getByPlaceholderText('كلمة المرور');

    fireEvent.changeText(emailInput, 'test@example.com');
    fireEvent.changeText(passwordInput, 'password123');

    const loginButton = screen.getByText('تسجيل الدخول');
    fireEvent.press(loginButton);

    await waitFor(() => {
      expect(screen.getByText('خطأ في تسجيل الدخول')).toBeTruthy();
    });
  });

  test('يجب أن ينتقل لشاشة إعادة تعيين كلمة المرور', () => {
    render(
      <NavigationContainer>
        <LoginScreen />
      </NavigationContainer>
    );

    const forgotPasswordLink = screen.getByText('نسيت كلمة المرور؟');
    fireEvent.press(forgotPasswordLink);

    expect(mockNavigate).toHaveBeenCalledWith('ForgotPassword');
  });
});
```

### 2. **RegisterScreen.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import RegisterScreen from '../../screens/Auth/RegisterScreen';

describe('RegisterScreen', () => {
  test('يجب أن يعرض نموذج التسجيل', () => {
    render(
      <NavigationContainer>
        <RegisterScreen />
      </NavigationContainer>
    );

    expect(screen.getByPlaceholderText('الاسم الكامل')).toBeTruthy();
    expect(screen.getByPlaceholderText('البريد الإلكتروني')).toBeTruthy();
    expect(screen.getByPlaceholderText('كلمة المرور')).toBeTruthy();
    expect(screen.getByPlaceholderText('تأكيد كلمة المرور')).toBeTruthy();
    expect(screen.getByText('إنشاء حساب')).toBeTruthy();
  });

  test('يجب أن يتحقق من تطابق كلمتي المرور', async () => {
    render(
      <NavigationContainer>
        <RegisterScreen />
      </NavigationContainer>
    );

    const passwordInput = screen.getByPlaceholderText('كلمة المرور');
    const confirmPasswordInput = screen.getByPlaceholderText('تأكيد كلمة المرور');

    fireEvent.changeText(passwordInput, 'password123');
    fireEvent.changeText(confirmPasswordInput, 'password456');

    const registerButton = screen.getByText('إنشاء حساب');
    fireEvent.press(registerButton);

    await waitFor(() => {
      expect(screen.getByText('كلمتا المرور غير متطابقتين')).toBeTruthy();
    });
  });
});
```

---

## 💰 اختبارات شاشات المحفظة

### 1. **WalletScreen.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import WalletScreen from '../../screens/wallet/WalletScreen';

// Mock wallet API
jest.mock('../../api/wallet.api', () => ({
  getWalletBalance: jest.fn(),
  getTransactionHistory: jest.fn(),
}));

describe('WalletScreen', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('يجب أن يعرض رصيد المحفظة', async () => {
    const mockGetWalletBalance = require('../../api/wallet.api').getWalletBalance;
    mockGetWalletBalance.mockResolvedValue({ balance: 1000 });

    render(
      <NavigationContainer>
        <WalletScreen />
      </NavigationContainer>
    );

    await waitFor(() => {
      expect(screen.getByText('1000 ريال')).toBeTruthy();
    });
  });

  test('يجب أن يعرض تاريخ المعاملات', async () => {
    const mockGetTransactionHistory = require('../../api/wallet.api').getTransactionHistory;
    mockGetTransactionHistory.mockResolvedValue([
      { id: 1, amount: 100, type: 'deposit', date: '2024-01-01' },
      { id: 2, amount: 50, type: 'withdrawal', date: '2024-01-02' },
    ]);

    render(
      <NavigationContainer>
        <WalletScreen />
      </NavigationContainer>
    );

    await waitFor(() => {
      expect(screen.getByText('+100 ريال')).toBeTruthy();
      expect(screen.getByText('-50 ريال')).toBeTruthy();
    });
  });

  test('يجب أن يتعامل مع أخطاء تحميل البيانات', async () => {
    const mockGetWalletBalance = require('../../api/wallet.api').getWalletBalance;
    mockGetWalletBalance.mockRejectedValue(new Error('خطأ في تحميل البيانات'));

    render(
      <NavigationContainer>
        <WalletScreen />
      </NavigationContainer>
    );

    await waitFor(() => {
      expect(screen.getByText('خطأ في تحميل البيانات')).toBeTruthy();
    });
  });

  test('يجب أن ينتقل لشاشة الشحن', () => {
    const mockNavigate = jest.fn();
    jest.spyOn(require('@react-navigation/native'), 'useNavigation').mockReturnValue({
      navigate: mockNavigate,
    });

    render(
      <NavigationContainer>
        <WalletScreen />
      </NavigationContainer>
    );

    const topupButton = screen.getByText('شحن المحفظة');
    fireEvent.press(topupButton);

    expect(mockNavigate).toHaveBeenCalledWith('Topup');
  });
});
```

---

## 🎨 اختبارات مكونات UI

### 1. **Button.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react-native';
import Button from '../../components/ui/button';

describe('Button', () => {
  test('يجب أن يعرض النص المطلوب', () => {
    render(<Button title="اضغط هنا" onPress={() => {}} />);
    expect(screen.getByText('اضغط هنا')).toBeTruthy();
  });

  test('يجب أن يستجيب للنقر', () => {
    const mockOnPress = jest.fn();
    render(<Button title="اضغط هنا" onPress={mockOnPress} />);

    const button = screen.getByText('اضغط هنا');
    fireEvent.press(button);

    expect(mockOnPress).toHaveBeenCalledTimes(1);
  });

  test('يجب أن يعرض حالة التحميل', () => {
    render(<Button title="اضغط هنا" onPress={() => {}} loading={true} />);

    expect(screen.getByTestId('loading-indicator')).toBeTruthy();
    expect(screen.queryByText('اضغط هنا')).toBeFalsy();
  });

  test('يجب أن يكون معطل عند الحاجة', () => {
    const mockOnPress = jest.fn();
    render(<Button title="اضغط هنا" onPress={mockOnPress} disabled={true} />);

    const button = screen.getByText('اضغط هنا');
    fireEvent.press(button);

    expect(mockOnPress).not.toHaveBeenCalled();
  });

  test('يجب أن يطبق الأنماط المختلفة', () => {
    const { rerender } = render(
      <Button title="أولية" onPress={() => {}} variant="primary" />
    );
    expect(screen.getByText('أولية')).toBeTruthy();

    rerender(<Button title="ثانوية" onPress={() => {}} variant="secondary" />);
    expect(screen.getByText('ثانوية')).toBeTruthy();
  });
});
```

### 2. **Input.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react-native';
import Input from '../../components/ui/input';

describe('Input', () => {
  test('يجب أن يعرض placeholder', () => {
    render(<Input placeholder="أدخل النص" onChangeText={() => {}} />);
    expect(screen.getByPlaceholderText('أدخل النص')).toBeTruthy();
  });

  test('يجب أن يستجيب للتغيير', () => {
    const mockOnChangeText = jest.fn();
    render(<Input placeholder="أدخل النص" onChangeText={mockOnChangeText} />);

    const input = screen.getByPlaceholderText('أدخل النص');
    fireEvent.changeText(input, 'نص جديد');

    expect(mockOnChangeText).toHaveBeenCalledWith('نص جديد');
  });

  test('يجب أن يعرض رسالة الخطأ', () => {
    render(
      <Input
        placeholder="أدخل النص"
        onChangeText={() => {}}
        error="هذا الحقل مطلوب"
      />
    );

    expect(screen.getByText('هذا الحقل مطلوب')).toBeTruthy();
  });

  test('يجب أن يكون آمن للنص عند الحاجة', () => {
    render(
      <Input
        placeholder="كلمة المرور"
        onChangeText={() => {}}
        secureTextEntry={true}
      />
    );

    const input = screen.getByPlaceholderText('كلمة المرور');
    expect(input.props.secureTextEntry).toBe(true);
  });
});
```

---

## 🛒 اختبارات شاشات التسوق

### 1. **CartScreen.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import { CartProvider } from '../../context/CartContext';
import CartScreen from '../../screens/delivery/CartScreen';

describe('CartScreen', () => {
  test('يجب أن يعرض السلة الفارغة', () => {
    render(
      <NavigationContainer>
        <CartProvider>
          <CartScreen />
        </CartProvider>
      </NavigationContainer>
    );

    expect(screen.getByText('السلة فارغة')).toBeTruthy();
    expect(screen.getByText('ابدأ التسوق الآن')).toBeTruthy();
  });

  test('يجب أن يعرض المنتجات في السلة', () => {
    const mockCartItems = [
      { id: 1, name: 'منتج 1', price: 100, quantity: 2 },
      { id: 2, name: 'منتج 2', price: 50, quantity: 1 },
    ];

    render(
      <NavigationContainer>
        <CartProvider initialItems={mockCartItems}>
          <CartScreen />
        </CartProvider>
      </NavigationContainer>
    );

    expect(screen.getByText('منتج 1')).toBeTruthy();
    expect(screen.getByText('منتج 2')).toBeTruthy();
    expect(screen.getByText('المجموع: 250 ريال')).toBeTruthy();
  });

  test('يجب أن يزيد كمية المنتج', () => {
    const mockCartItems = [{ id: 1, name: 'منتج 1', price: 100, quantity: 1 }];

    render(
      <NavigationContainer>
        <CartProvider initialItems={mockCartItems}>
          <CartScreen />
        </CartProvider>
      </NavigationContainer>
    );

    const increaseButton = screen.getByTestId('increase-quantity-1');
    fireEvent.press(increaseButton);

    expect(screen.getByText('الكمية: 2')).toBeTruthy();
  });

  test('يجب أن يحذف المنتج من السلة', () => {
    const mockCartItems = [{ id: 1, name: 'منتج 1', price: 100, quantity: 1 }];

    render(
      <NavigationContainer>
        <CartProvider initialItems={mockCartItems}>
          <CartScreen />
        </CartProvider>
      </NavigationContainer>
    );

    const deleteButton = screen.getByTestId('delete-item-1');
    fireEvent.press(deleteButton);

    expect(screen.queryByText('منتج 1')).toBeFalsy();
    expect(screen.getByText('السلة فارغة')).toBeTruthy();
  });
});
```

---

## 🔧 اختبارات الأدوات المساعدة

### 1. **axiosInstance.test.ts**

```typescript
import axios from "axios";
import { axiosInstance } from "../../utils/api/axiosInstance";

// Mock axios
jest.mock("axios");

describe("axiosInstance", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test("يجب أن يضيف headers المصادقة", async () => {
    const mockAxios = axios as jest.Mocked<typeof axios>;
    mockAxios.create.mockReturnValue(mockAxios);
    mockAxios.interceptors.request.use.mockImplementation((fn) => {
      const config = { headers: {} };
      fn(config);
      return config;
    });

    // Mock AsyncStorage
    const mockToken = "test-token";
    jest
      .spyOn(require("@react-native-async-storage/async-storage"), "getItem")
      .mockResolvedValue(mockToken);

    const instance = axiosInstance;
    const requestInterceptor =
      mockAxios.interceptors.request.use.mock.calls[0][0];

    const config = { headers: {} };
    const result = requestInterceptor(config);

    expect(result.headers.Authorization).toBe(`Bearer ${mockToken}`);
  });

  test("يجب أن يتعامل مع عدم وجود token", async () => {
    const mockAxios = axios as jest.Mocked<typeof axios>;
    mockAxios.create.mockReturnValue(mockAxios);
    mockAxios.interceptors.request.use.mockImplementation((fn) => {
      const config = { headers: {} };
      fn(config);
      return config;
    });

    // Mock AsyncStorage returning null
    jest
      .spyOn(require("@react-native-async-storage/async-storage"), "getItem")
      .mockResolvedValue(null);

    const instance = axiosInstance;
    const requestInterceptor =
      mockAxios.interceptors.request.use.mock.calls[0][0];

    const config = { headers: {} };
    const result = requestInterceptor(config);

    expect(result.headers.Authorization).toBeUndefined();
  });

  test("يجب أن يتعامل مع أخطاء الطلب", async () => {
    const mockAxios = axios as jest.Mocked<typeof axios>;
    mockAxios.create.mockReturnValue(mockAxios);
    mockAxios.interceptors.response.use.mockImplementation(
      (successFn, errorFn) => {
        const error = { response: { status: 401 } };
        errorFn(error);
        return error;
      }
    );

    const instance = axiosInstance;
    const errorInterceptor =
      mockAxios.interceptors.response.use.mock.calls[0][1];

    const error = { response: { status: 401 } };
    const result = errorInterceptor(error);

    expect(result).toBe(error);
  });
});
```

---

## 📱 اختبارات المكونات التفاعلية

### 1. **DynamicFAB.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react-native';
import DynamicFAB from '../../components/DynamicFAB';

describe('DynamicFAB', () => {
  test('يجب أن يعرض زر FAB أساسي', () => {
    render(<DynamicFAB onPress={() => {}} />);
    expect(screen.getByTestId('fab-button')).toBeTruthy();
  });

  test('يجب أن يستجيب للنقر', () => {
    const mockOnPress = jest.fn();
    render(<DynamicFAB onPress={mockOnPress} />);

    const fabButton = screen.getByTestId('fab-button');
    fireEvent.press(fabButton);

    expect(mockOnPress).toHaveBeenCalledTimes(1);
  });

  test('يجب أن يعرض أيقونة مخصصة', () => {
    render(<DynamicFAB onPress={() => {}} icon="plus" />);
    expect(screen.getByTestId('fab-icon-plus')).toBeTruthy();
  });

  test('يجب أن يطبق الأنماط المختلفة', () => {
    const { rerender } = render(
      <DynamicFAB onPress={() => {}} variant="primary" />
    );
    expect(screen.getByTestId('fab-button')).toBeTruthy();

    rerender(<DynamicFAB onPress={() => {}} variant="secondary" />);
    expect(screen.getByTestId('fab-button')).toBeTruthy();
  });
});
```

---

## 🎯 اختبارات التكامل

### 1. **UserFlow.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { NavigationContainer } from '@react-navigation/native';
import { CartProvider } from '../../context/CartContext';
import { ThemeProvider } from '../../context/ThemeContext';
import LoginScreen from '../../screens/Auth/LoginScreen';
import HomeScreen from '../../screens/HomeScreen';

describe('User Flow Integration', () => {
  test('يجب أن ينتقل من تسجيل الدخول للصفحة الرئيسية', async () => {
    const mockLoginUser = require('../../api/authService').loginUser;
    mockLoginUser.mockResolvedValue({ user: { id: 1, name: 'أحمد' } });

    const mockNavigate = jest.fn();
    jest.spyOn(require('@react-navigation/native'), 'useNavigation').mockReturnValue({
      navigate: mockNavigate,
    });

    render(
      <NavigationContainer>
        <ThemeProvider>
          <CartProvider>
            <LoginScreen />
          </CartProvider>
        </ThemeProvider>
      </NavigationContainer>
    );

    const emailInput = screen.getByPlaceholderText('البريد الإلكتروني');
    const passwordInput = screen.getByPlaceholderText('كلمة المرور');

    fireEvent.changeText(emailInput, 'test@example.com');
    fireEvent.changeText(passwordInput, 'password123');

    const loginButton = screen.getByText('تسجيل الدخول');
    fireEvent.press(loginButton);

    await waitFor(() => {
      expect(mockNavigate).toHaveBeenCalledWith('Home');
    });
  });

  test('يجب أن يضيف منتج للسلة من الصفحة الرئيسية', async () => {
    render(
      <NavigationContainer>
        <ThemeProvider>
          <CartProvider>
            <HomeScreen />
          </CartProvider>
        </ThemeProvider>
      </NavigationContainer>
    );

    const addToCartButton = screen.getByTestId('add-to-cart-1');
    fireEvent.press(addToCartButton);

    await waitFor(() => {
      expect(screen.getByText('تم إضافة المنتج للسلة')).toBeTruthy();
    });
  });
});
```

---

## 📊 اختبارات الأداء

### 1. **Performance.test.tsx**

```typescript
import React from 'react';
import { render } from '@testing-library/react-native';
import { performance } from 'perf_hooks';
import HomeScreen from '../../screens/HomeScreen';

describe('Performance Tests', () => {
  test('يجب أن يحمل الصفحة الرئيسية في أقل من 2 ثانية', async () => {
    const startTime = performance.now();

    render(<HomeScreen />);

    const endTime = performance.now();
    const loadTime = endTime - startTime;

    expect(loadTime).toBeLessThan(2000); // 2 seconds
  });

  test('يجب أن يعالج 1000 منتج بدون تأخير', () => {
    const largeProductList = Array.from({ length: 1000 }, (_, i) => ({
      id: i,
      name: `منتج ${i}`,
      price: Math.random() * 100,
    }));

    const startTime = performance.now();

    // Simulate processing large list
    const processedList = largeProductList.map(product => ({
      ...product,
      formattedPrice: `${product.price.toFixed(2)} ريال`,
    }));

    const endTime = performance.now();
    const processTime = endTime - startTime;

    expect(processTime).toBeLessThan(100); // 100ms
    expect(processedList).toHaveLength(1000);
  });
});
```

---

## 🔒 اختبارات الأمان

### 1. **Security.test.tsx**

```typescript
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react-native';
import LoginScreen from '../../screens/Auth/LoginScreen';

describe('Security Tests', () => {
  test('يجب أن يمنع SQL injection في حقل البريد الإلكتروني', () => {
    render(<LoginScreen />);

    const emailInput = screen.getByPlaceholderText('البريد الإلكتروني');
    const maliciousInput = "'; DROP TABLE users; --";

    fireEvent.changeText(emailInput, maliciousInput);

    expect(emailInput.props.value).toBe(maliciousInput);
    // Should not execute SQL commands
  });

  test('يجب أن يمنع XSS في حقول الإدخال', () => {
    render(<LoginScreen />);

    const emailInput = screen.getByPlaceholderText('البريد الإلكتروني');
    const xssInput = '<script>alert("XSS")</script>';

    fireEvent.changeText(emailInput, xssInput);

    expect(emailInput.props.value).toBe(xssInput);
    // Should not execute JavaScript
  });

  test('يجب أن يتحقق من قوة كلمة المرور', () => {
    render(<LoginScreen />);

    const passwordInput = screen.getByPlaceholderText('كلمة المرور');

    // Weak password
    fireEvent.changeText(passwordInput, '123');
    expect(screen.getByText('كلمة المرور ضعيفة')).toBeTruthy();

    // Strong password
    fireEvent.changeText(passwordInput, 'StrongPass123!');
    expect(screen.queryByText('كلمة المرور ضعيفة')).toBeFalsy();
  });
});
```

---

## 📝 ملاحظات مهمة

### 1. **إعداد الاختبارات**

```bash
# تثبيت المكتبات المطلوبة
npm install --save-dev @testing-library/react-native @testing-library/jest-native

# تشغيل الاختبارات
npm test

# تشغيل الاختبارات مع التغطية
npm run test:cov
```

### 2. **أفضل الممارسات**

- استخدم أسماء وصفية للاختبارات
- اختبر الحالات الإيجابية والسلبية
- اختبر الحالات الحدية
- استخدم Mock للخدمات الخارجية
- حافظ على الاختبارات سريعة ومستقلة

### 3. **أدوات مفيدة**

- **Jest**: إطار الاختبار الأساسي
- **React Native Testing Library**: لاختبار المكونات
- **Mock**: لمحاكاة الخدمات الخارجية
- **Coverage**: لقياس تغطية الاختبارات

---

_تم إنشاء هذه الأمثلة في: ${new Date().toLocaleDateString('ar-SA')}_
