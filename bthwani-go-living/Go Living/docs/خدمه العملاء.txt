تفضل — قائمة تحقق شاملة لتنفيذ لوحة خدمة العملاء (Customer Service Dashboard) داخل لوحة التحكم الرئيسية. مرتبة طبقيًا، وكل بند معه “تم عندما” كمعيار قبول. (التقنيات: React + TS + axios + Box/Flex، Node/Express + TS + MongoDB + Zod، TZ=Asia/Aden، RBAC)

0) التحضير والحوكمة

 توحيد المنطقة الزمنية TZ=Asia/Aden في السيرفر والكرونات
تم عندما: تقارير يوم واحد تطابق يوم التقويم المحلي.

 توحيد معرف المستخدم (firebaseUID أو User._id كنص) عبر النظام
تم عندما: نفس قيمة userId تُستخدم في Events/Segments/Messages/Tickets.

 تفعيل Feature Flag لتبويب “الدعم”
تم عندما: يمكن إظهار/إخفاء التبويب دون نشر.

 تعريف أدوار RBAC: support:read, support:write, support:manage, support:report
تم عندما: الوصول لمسارات الدعم يُحترم حسب الدور (403 عند نقص الصلاحية).

1) نماذج البيانات والفهارس

 SupportTicket:
number, subject, description, requester{userId/phone/email}, links{orderId,store,driver}, status, priority, assignee, group, tags[], channel, source, firstResponseAt, resolvedAt, breachFirstResponse, breachResolve, slaPolicyId, csatScore, csatComment, csatSentAt, timestamps
فهارس: {status,priority,updatedAt}, {assignee,status,updatedAt}, links.orderId|store|driver
تم عندما: إنشاء 10k تذكرة لا يبطئ الاستعلامات (>1s).

 TicketMessage:
ticketId, author{type,id}, isInternalNote, body, attachments[], createdAt
فهرس: {ticketId, createdAt}
تم عندما: استرجاع خيط 200 رسالة ≤ 300ms.

 CannedResponse / Macro / SlaPolicy (أساس الحقول كما خُطط سابقًا)
تم عندما: CRUD مبدئي يعمل لكلٍ منها.

 MessagingPrefs (تفضيلات القنوات + Quiet Hours + Caps)
تم عندما: وثيقة فريدة لكل مستخدم بـ userId نفسه.

 تشغيل syncIndexes() بعد الاتصال + تفعيل validate() لموديلات الدعم
تم عندما: لا تظهر تحذيرات فهارس عند الإقلاع.

2) الوسطيات والحماية

 Helmet + CORS + Rate-Limit لمسارات الكتابة
تم عندما: محاولات سريعة تتجاوز الحد تُرجع 429.

 Zod validate() بكل POST/PATCH (استخدم ZodTypeAny) وشكل أخطاء موحّد {message, errors[]}
تم عندما: طلب غير صالح يُعيد 400 مع تفاصيل واضحة.

 requireRole مفعّل على /support/*
تم عندما: مستخدم بلا support:read يرى 403.

 منع IDOR: تجاهل userId/assignee/store القادمة من العميل عندما تعارض الـclaims
تم عندما: طلبات تعديل حساسة تُرفض عند تمرير معرفات مزوّرة.

3) مسارات الـAPI (axios-friendly)

 GET /api/v1/support/tickets
استعلامات: q, status, priority, assignee, tag, page, limit<=200
تم عندما: يرجع قائمة + total/pages ≤ 1s عند 10k.

 POST /api/v1/support/tickets
تم عندما: ينشئ تذكرة برقم تسلسلي ويضيف رسالة أولى إن وُجدت description.

 PATCH /api/v1/support/tickets/:id (حالة/أولوية/إسناد/وسوم)
تم عندما: التعديلات تظهر فوريًا وتُسجّل updatedAt.

 POST /api/v1/support/tickets/:id/messages (رد/ملاحظة داخلية + مرفقات URL)
تم عندما: أول رد من وكيل يملأ firstResponseAt.

 GET /api/v1/support/tickets/:id/messages
تم عندما: الخيط مرتب تصاعديًا بالوقت.

 CSAT: POST /api/v1/support/tickets/:id/csat
تم عندما: يحفظ التقييم والتعليق مرة واحدة بعد الإغلاق.

 Prefs: GET/PATCH /api/v1/messaging-prefs/me
تم عندما: المستخدم يعدّل Opt-in/Quiet Hours/Caps بنجاح.

 Customer 360: GET /api/v1/customers/:id/overview
تم عندما: يعيد بيانات أساسية + آخر 5 طلبات + آخر 5 تذاكر + Prefs + Segments.

4) الكرونات والمراقبة

 SLA Monitor (كل 5–10 دقائق): تطبيق سياسات firstResponseMins/resolveMins وتحديد breach*
تم عندما: التذاكر المتجاوزة تُعلّم تلقائيًا، مع سجل في اللوغ.

 CSAT Invite: عند تغيير الحالة إلى resolved/closed، إرسال دعوة تقييم (In-App/Push)
تم عندما: معدل وصول الدعوات ≥ 95% للح-cases المغلقة.

 Health Endpoint للـSLA monitor (آخر تشغيل/مدته/عدد التذاكر المفحوصة)
تم عندما: يمكن فحص الحالة من Prometheus/uptime بسهولة.

5) الواجهة (React + TS + axios + Box/Flex، RTL)

 عميل axiosWeb موحّد + interceptor للتوكن/الأخطاء
تم عندما: جميع النداءات تمر من نفس العميل.

 Inbox /support/inbox
مرشّحات (بحث/حالة/أولوية/معيّن/وسم)، جدول خفيف (Box/Flex) برؤوس: رقم، موضوع، الحالة، الأولوية، المعيّن، آخر تحديث، مصدر
تم عندما: تغيير المرشّحات يعيد التحميل فورًا مع حالات Loading/Empty/Error واضحة.

 Ticket View /support/ticket/:id

عمود تحكم: حالة/أولوية/إسناد/وسوم + قوالب/ماكروز

المساحة الرئيسية: خيط الرسائل (تمييز الملاحظات الداخلية) + محرّر رد

عمود جانبي: Customer 360 Panel (بيانات العميل، آخر الطلبات/التذاكر، تفضيلات الرسائل)
تم عندما: إرسال رد يضيف رسالة ويُحدّث الخيط فورًا.

 Reports /support/reports (MVP)
بطاقات: FRT (متوسط وقت أول رد)، ART (متوسط وقت الحل)، Backlog حسب الحالة، CSAT متوسط
تم عندما: الفترات (7/30/مخصّص) تُحدّث البطاقات بسرعة.

6) التكاملات (إلزامية/اختيارية)

 ربط links.orderId/store/driver في التذاكر مع عرض روابط سريعة للكيانات
تم عندما: النقر يفتح صفحة الطلب/المتجر/الكابتن في لوحة التحكم.

 استخدام Presigned URL للملفات (Bunny/S3)
تم عندما: رفع المرفقات يُخزن name,url,size فقط.

 قوالب رد/ماكروز
تم عندما: تطبيق ماكرو يغيّر (حالة/وسوم/أولوية) ويضيف ردًا/ملاحظة دفعة واحدة.

7) الجودة والرصد

 Sentry + لوغ منظّم (API/كرونات)
تم عندما: كل خطأ يظهر مع Trace/Request info.

 Seed بيانات: 1000 تذكرة بتركيبات متنوعة + 200 خيط رسائل
تم عندما: الواجهة تعرض بيانات حقيقية لاختبار الأداء.

 اختبارات قبول

GET /support/tickets ≤ 1s عند 10k

أول رد يملأ firstResponseAt

SLA Monitor يوسم breach* بدقة

CSAT يحفظ مرّة واحدة فقط بعد الإغلاق

RBAC يمنع الوصول غير المصرح

Customer 360 يظهر آخر 5 طلبات/تذاكر صحيحة

8) الإطلاق والتشغيل

 Runbook: إعادة فهارس، تشغيل/إيقاف SLA monitor، تدوير مفاتيح، Kill-switch لإرسال الدعوات
تم عندما: وثيقة تشغيل مختبرة داخليًا.

 بيتا داخلية لفريق الدعم
تم عندما: ملاحظات الفريق تُدمَج في نسخة صيانة أولى خلال أسبوع.

9) تحسينات لاحقة (Phase-2)

 Realtime (SSE/WebSocket) لتحديث الخيط والعدادات مباشرة

 ذكاء توجيه (Auto Routing) حسب الوسوم/القناة/الأولوية/اللغة

 لوحة Agent Performance تفصيلية + تصدير CSV/PDF

 تكامل قنوات إضافية (Email/SMS) مع تتبع delivered/opened/clicked

 قاعدة معرفة (Knowledge Base) + اقتراحات رد تلقائية (LLM)

 Bot لحلّ الاستفسارات البسيطة قبل تحويلها لوكيل

ملفات مقترحة للتنفيذ

Backend
models/{SupportTicket,TicketMessage,MessagingPrefs,SlaPolicy}.ts
middleware/{validate.ts,rbac.ts}
routes/support.ts, routes/messaging-prefs.ts, routes/customers.ts
crons/support/slaMonitor.ts
app.ts (تسجيل الراوتر/الكرون/الوسطيات)

Frontend
src/utils/api/axiosWeb.ts
src/pages/support/{Inbox.tsx,TicketView.tsx,Reports.tsx}
src/components/support/{TicketList.tsx,MessageThread.tsx,CustomerPanel.tsx}

لو تحب، أحوّل هذه القائمة إلى Sprint أسبوعي بمهمات per-file ومعايير قبول/أوامر اختبار (curl) جاهزة لكل Endpoint.