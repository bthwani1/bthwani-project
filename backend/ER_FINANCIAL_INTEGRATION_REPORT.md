# ุชูุฑูุฑ ุชูุงูู ูุธุงู ER ูุน ุงููุธุงู ุงููุงูู - ุชุญููู ุดุงูู ูุนููู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุชูุงูู ุงููุงูู

ุชู ุงูุชุดุงู ูุฌูุฏ **ูุธุงููู ูุงูููู ูููุตููู ุชูุงูุงู** ูู ุงููุธุงู:

### ุงููุธุงู ุงููุงูู ุงูุฑุฆูุณู:
- **User.wallet** - ูุญุงูุธ ุงููุณุชุฎุฏููู
- **Driver.wallet** - ูุญุงูุธ ุงูุณุงุฆููู
- **WalletAccount** - ูุธุงู ูุญุงุณุจู ูุชูุฏู
- **Wallet_V8** - ูุธุงู ูุนุงููุงุช ูููุตู

### ูุธุงู ER (ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ/ุงููุญุงุณุจุฉ):
- **ูุธุงู ูุญุงุณุจู ูุชูุงูู** ูุน ุฌุฏุงูู ูููุตูุฉ ุชูุงูุงู
- **ุฏููู ุญุณุงุจุงุช (ChartAccount)** ูููุตู
- **ูููุฏ ููููุฉ (JournalEntry)** ูููุตูุฉ
- **ุฏูุชุฑ ุฃุณุชุงุฐ (LedgerEntry)** ูููุตู
- **ูุธุงู ุฑูุงุชุจ (Payroll)** ูููุตู

## ุชุญููู ููุตู ููุชุนุงุฑุถุงุช

### 1. ุชุนุงุฑุถ ูู ุชุฎุฒูู ุงูุจูุงูุงุช ุงููุงููุฉ ๐ด ุญุฑุฌ

| ูุธุงู | ูุงุนุฏุฉ ุงูุจูุงูุงุช | ุฌุฏุงูู ุฑุฆูุณูุฉ | ูุธุงู ุงููุนุงููุงุช |
|-------|-----------------|----------------|-------------------|
| **ุงููุงููุฉ ุงูุฑุฆูุณูุฉ** | ููุณ ุงูู MongoDB | `users`, `drivers`, `wallet_accounts` | ูุธุงู WalletAccount + Ledger |
| **ูุธุงู ER** | ููุณ ุงูู MongoDB | `chart_accounts`, `journal_entries`, `ledger_entries` | ูุธุงู ER Ledger ูููุตู |

**ุงูุชุฃุซูุฑ:**
- ุจูุงูุงุช ูุงููุฉ ููุฒุนุฉ ุนูู ุฌุฏูููู ูููุตููู ุชูุงูุงู
- ุนุฏู ูุฌูุฏ ุฑุจุท ุจูู ุงููุนุงููุงุช ุงููุงููุฉ ูุงููุญุงุณุจูุฉ
- ุตุนูุจุฉ ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุดุงููุฉ

### 2. ุชุนุงุฑุถ ูู ูุธุงู ุฏููู ุงูุญุณุงุจุงุช ๐ด ุญุฑุฌ

#### ูุธุงู ChartAccount ูู ER:
```typescript
// src/models/er/chartAccount.model.ts
export interface IChartAccount extends Document {
  name: string;
  code: string;          // ูุซุงู: "2102-ABC123"
  parent?: Types.ObjectId;
  isActive: boolean;
}
```

#### ุงุณุชุฎุฏุงู ูู ุงูุทูุจุงุช:
```typescript
// ูู postingHelpers.ts
const ACCOUNTS = {
  COMMISSION_REV: "4201",        // ุนูููุฉ ูู ุงูุชุฌุงุฑ
  DELIVERY_REV: "4101",         // ุฅูุฑุงุฏ ุงูุชูุตูู
  STORE_PAY_PARENT: "2102",     // ุฐูู ุงูุชุฌุงุฑ - ุฃุจ
  COD_CLEARING: "2103",         // ุชุญุตููุงุช COD
  GATEWAY_AR: "1131",           // ุจูุงุจุงุช ุฏูุน
  WALLET_LIAB: "2122",          // ูุญุงูุธ ุงูุนููุงุก
};
```

**ุงูุชุฃุซูุฑ:**
- ูุธุงู ChartAccount ูู ER ููุณุชุฎุฏู ููุทูุจุงุช
- ูุง ููุฌุฏ ุฑุจุท ุจูุธุงู ChartAccount ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ
- ุชุถุงุฑุจ ูู ุฑููุฒ ุงูุญุณุงุจุงุช

### 3. ุชุนุงุฑุถ ูู ูุธุงู ุงููููุฏ ุงููุญุงุณุจูุฉ ๐ด ุญุฑุฌ

#### ูุธุงู JournalEntry ูู ER:
```typescript
// src/models/er/journalEntry.model.ts
const JournalEntrySchema = new Schema({
  voucherNo: { type: String, unique: true },
  date: { type: Date, required: true },
  description: String,
  reference: String,
  isPosted: { type: Boolean, default: false },
  lines: [{
    account: { type: Types.ObjectId, ref: 'ChartAccount' },
    debit: { type: Number, default: 0 },
    credit: { type: Number, default: 0 },
  }]
});
```

#### ูุธุงู Ledger ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ:
```typescript
// src/models/finance/LedgerEntry.ts
export interface ILedgerEntry extends Document {
  event_type: string;
  event_ref: string;
  description: string;
  total_debit: number;
  total_credit: number;
  is_balanced: boolean;
}
```

**ุงูุชุฃุซูุฑ:**
- ูููุฏ ูุญุงุณุจูุฉ ููุฑุฑุฉ ูู ูุธุงููู ูุฎุชูููู
- ุนุฏู ุชูุญูุฏ ูู ูููู ุงูุจูุงูุงุช
- ุตุนูุจุฉ ูู ุงููุทุงุจูุฉ ูุงูุชุณููุฉ

### 4. ุชุนุงุฑุถ ูู ูุธุงู ุงูุฑูุงุชุจ ๐ก ูุชูุณุท

#### ูุธุงู Payroll ูู ER:
```typescript
// src/models/er/payroll.model.ts
export interface IPayroll extends Document {
  employee: Types.ObjectId;        // ูุฑุชุจุท ุจู Employee ูู ER
  periodStart: Date;
  periodEnd: Date;
  grossAmount: number;
  deductions: number;
  netAmount: number;
  status: 'pending' | 'processed';
}
```

#### ุนุฏู ุงูุฑุจุท ุจุงููุญุงูุธ ุงููุงููุฉ:
- ูุง ููุฌุฏ ุฑุจุท ุจู `Driver.wallet` ุฃู `User.wallet`
- ูุง ููุฌุฏ ุฑุจุท ุจู `WalletAccount` ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ
- ูุธุงู ูููุตู ุชูุงูุงู ุนู ูุธุงู ุงูุชุณููุงุช

### 5. ุชุนุงุฑุถ ูู ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ ๐ก ูุชูุณุท

#### ูุธุงู Settlement ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ:
```typescript
// ูุนุชูุฏ ุนูู WalletAccount ู Ledger
export async function generateSettlement(params: SettlementGenerationParams) {
  // ูุจุญุซ ูู WalletAccount ุนู ุงูุณุงุฆููู ูุงูุชุฌุงุฑ
  const walletAccounts = await WalletAccount.find({
    owner_type: type,  // 'driver' | 'vendor'
    status: 'active'
  });
}
```

#### ุนุฏู ุงูุฑุจุท ุจูุธุงู Payroll ูู ER:
- ูุง ููุฌุฏ ุฑุจุท ุจูู ุฑูุงุชุจ ุงูููุธููู ูุงูุชุณููุงุช ุงููุงููุฉ
- ูุธุงููู ูููุตููู ูููุฏููุนุงุช

## ุขููุฉ ุงูุชูุงูู ุงูุญุงููุฉ (ุงููุญุฏูุฏุฉ)

### 1. ุฑุจุท ุงูุทูุจุงุช ุจูุธุงู ER ุงููุญุงุณุจู:

```typescript
// ูู src/accounting/services/postingHelpers.ts
export async function postOrderDelivered(orderId: string) {
  // 1. ุญุณุงุจ ุงููุจุงูุบ ูู ุงูุทูุจ
  // 2. ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูู ูุธุงู ER
  // 3. ุฑุจุท ุจุญุณุงุจุงุช GL ููุชุฌุงุฑ ูุงูุณุงุฆููู

  const entry = await JournalEntry.create({
    voucherType: "delivery",
    reference: String(order._id),
    lines: lines // ูุฑุชุจุทุฉ ุจู ChartAccount ูู ER
  });
}
```

### 2. ุฑุจุท ุงูุณุงุฆููู ูุงูุชุฌุงุฑ ุจุญุณุงุจุงุช GL:

```typescript
// ูู src/accounting/services/ensureEntityGL.ts
export async function ensureGLForDriver(driverId: string) {
  // ููุดุฆ ุญุณุงุจุงุช GL ูู ูุธุงู ER ููุณุงุฆู
  // ูุฑุชุจุท ุจู ChartAccount ูู ER ููุท
}

export async function ensureGLForStore(storeId: string) {
  // ููุดุฆ ุญุณุงุจุงุช GL ูู ูุธุงู ER ููุชุงุฌุฑ
  // ูุฑุชุจุท ุจู ChartAccount ูู ER ููุท
}
```

## ุงูุชุนุงุฑุถุงุช ุงูุชุดุบูููุฉ ุงูููุชุดูุฉ

### 1. ุชุนุงุฑุถ ูู ูุธุงู ุงูุญุณุงุจุงุช ุงููุฒุฏูุฌุฉ ๐ด ุญุฑุฌ

**ุงููุดููุฉ:**
- ููุณ ุงูุนูููุฉ ุงููุงููุฉ (ุทูุจ ุชุณููู) ุชูุณุฌู ูู ูุธุงููู ูุฎุชูููู
- ููุฏ ูู `JournalEntry` (ER) + ููุฏ ูู `LedgerEntry` (ุงููุงููุฉ ุงูุฑุฆูุณูุฉ)

**ุงูุชุฃุซูุฑ:**
- ุชุถุงุนู ูู ุงูุชุณุฌูู ุงููุงูู
- ุตุนูุจุฉ ูู ุงููุทุงุจูุฉ ูุงูุชุณููุฉ
- ูุฎุงุทุฑ ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ

### 2. ุชุนุงุฑุถ ูู ูุธุงู ุงูุชูุงุฑูุฑ ุงููุงููุฉ ๐ก ูุชูุณุท

**ุงููุดููุฉ:**
- ุชูุงุฑูุฑ ุงููุงููุฉ ุงูุฑุฆูุณูุฉ ุชุนุชูุฏ ุนูู `LedgerEntry` ู `WalletAccount`
- ุชูุงุฑูุฑ ER ุชุนุชูุฏ ุนูู `JournalEntry` ู `ChartAccount`
- ุนุฏู ูุฌูุฏ ุชูุญูุฏ ูู ุงูุจูุงูุงุช

### 3. ุชุนุงุฑุถ ูู ูุธุงู ุงููุฏููุนุงุช ูุงูุชุณููุงุช ๐ก ูุชูุณุท

**ุงููุดููุฉ:**
- ูุธุงู ุงูุชุณููุงุช ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ ูุนุชูุฏ ุนูู `WalletAccount`
- ูุธุงู ุงูุฑูุงุชุจ ูู ER ูุนุชูุฏ ุนูู `Payroll` ู `Employee`
- ูุง ููุฌุฏ ุฑุจุท ุจูู ุงููุฏููุนุงุช ูุงูุฑูุงุชุจ

## ุญููู ููุชุฑุญุฉ ููุชูุงูู

### ุงูุญู ุงูุฃูุซู: ุชูุญูุฏ ุงูุฃูุธูุฉ ุงููุงููุฉ

#### 1. ุฅูุดุงุก ูุธุงู ูุญุงุณุจู ููุญุฏ

```typescript
// src/models/finance/UnifiedLedger.ts
export interface IUnifiedLedger extends Document {
  // ุฏูุฌ LedgerEntry ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ ูุน JournalEntry ูู ER
  event_type: string;
  event_ref: string;
  voucher_no?: string;        // ูู ูุธุงู ER
  description: string;
  total_debit: number;
  total_credit: number;
  is_balanced: boolean;
  is_posted: boolean;         // ูู ูุธุงู ER

  // ุฑุจุท ุจุญุณุงุจุงุช GL ุงูููุญุฏุฉ
  lines: IUnifiedLedgerLine[];

  // ุงููุตุฏุฑ
  source_system: 'main_finance' | 'er' | 'unified';
}

export interface IUnifiedLedgerLine extends Document {
  account_id: Types.ObjectId;    // ูุฑุชุจุท ุจู ChartAccount ููุญุฏ
  account_code: string;          // ุฑูุฒ ุงูุญุณุงุจ
  account_name: string;          // ุงุณู ุงูุญุณุงุจ
  debit: number;
  credit: number;
  description?: string;
}
```

#### 2. ูุธุงู ุฏููู ุญุณุงุจุงุช ููุญุฏ

```typescript
// src/models/finance/UnifiedChartAccount.ts
export interface IUnifiedChartAccount extends Document {
  code: string;                   // ุฑูุฒ ููุญุฏ
  name: string;                   // ุงุณู ููุญุฏ
  type: 'asset' | 'liability' | 'equity' | 'revenue' | 'expense';

  // ูุธุงู ุงูุชุณูุณู ุงูููุญุฏ
  parent?: Types.ObjectId;
  level: number;                  // ูุณุชูู ุงูุญุณุงุจ ูู ุงูุดุฌุฑุฉ

  // ูุนูููุงุช ุฅุถุงููุฉ
  is_active: boolean;
  currency?: string;

  // ุฑุจุท ุจุงูุฃูุธูุฉ ุงููุฏููุฉ
  legacy_er_id?: Types.ObjectId;  // ุฑุจุท ุจู ChartAccount ูู ER
  legacy_finance_id?: Types.ObjectId; // ุฑุจุท ุจุฃู ูุธุงู ูู ุงููุงููุฉ ุงูุฑุฆูุณูุฉ
}
```

#### 3. ูุธุงู ูุนุงููุงุช ูุงููุฉ ููุญุฏ

```typescript
// src/models/finance/UnifiedTransaction.ts
export interface IUnifiedTransaction extends Document {
  // ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ
  transaction_id: string;         // ูุนุฑู ููุญุฏ ูููุนุงููุฉ
  type: 'order' | 'settlement' | 'payout' | 'payroll' | 'wallet';

  // ุงูุฃุทุฑุงู ุงููุนููุฉ
  from_entity_type: 'user' | 'driver' | 'vendor' | 'company' | 'system';
  from_entity_id: Types.ObjectId;
  to_entity_type: 'user' | 'driver' | 'vendor' | 'company' | 'system';
  to_entity_id: Types.ObjectId;

  // ุงููุจุงูุบ ูุงูุนููุงุช
  amount: number;
  currency: string;
  exchange_rate?: number;

  // ุงูุญุงูุฉ ูุงูุชุชุจุน
  status: 'pending' | 'completed' | 'failed' | 'cancelled';
  reference: string;              // ุฑุจุท ุจุงููุนุงููุฉ ุงูุฃุตููุฉ

  // ุงููููุฏ ุงููุญุงุณุจูุฉ
  ledger_entries: Types.ObjectId[]; // ูููุฏ ูุญุงุณุจูุฉ ูุฑุชุจุทุฉ

  // ุงููุตุฏุฑ
  source_system: 'main_finance' | 'er' | 'wallet_v8' | 'unified';
}
```

### ุฎุทุฉ ุงูุชูููุฐ ุงูุชุฏุฑูุฌูุฉ

#### ุงููุฑุญูุฉ 1: ุงูุชุญููู ูุงูุชุฎุทูุท (ุฃุณุจูุน 1-2)
- [ ] ุฑุณู ุฎุฑุงุฆุท ุงูุชูุงุนูุงุช ุงููุงููุฉ ุงูุญุงููุฉ ุจูู ุงูุฃูุธูุฉ
- [ ] ุชุญุฏูุฏ ููุงุท ุงูุชุถุงุฑุจ ุจุฏูุฉ
- [ ] ุชุตููู ุงููุธุงู ุงูููุญุฏ

#### ุงููุฑุญูุฉ 2: ุจูุงุก ุงููุธุงู ุงูููุญุฏ (ุฃุณุจูุน 3-5)
- [ ] ุฅูุดุงุก ููุงุฐุฌ ุงูุจูุงูุงุช ุงูููุญุฏุฉ
- [ ] ุจูุงุก ุฎุฏูุงุช ุงูุชูุงูู ุงููุงูู
- [ ] ุชุทููุฑ ูุธุงู ุงููุนุงููุงุช ุงูููุญุฏ

#### ุงููุฑุญูุฉ 3: ุงููุฌุฑุฉ ุงูุชุฏุฑูุฌูุฉ (ุฃุณุจูุน 6-8)
- [ ] ููู ุงูุจูุงูุงุช ูู ุงูุฃูุธูุฉ ุงููุฏููุฉ
- [ ] ุชุญุฏูุซ ุฌููุน ุงูู controllers ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ููุชูุงูู

#### ุงููุฑุญูุฉ 4: ุงูุชุญูู ูุงูุชุญุณูู (ุฃุณุจูุน 9-10)
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ูุฌููุน ุงูุณููุงุฑูููุงุช ุงููุงููุฉ
- [ ] ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] ุชุญุณูู ุงูุฃุฏุงุก ุญุณุจ ุงูุญุงุฌุฉ

## ูุคุดุฑุงุช ุงููุฌุงุญ ุจุนุฏ ุงูุชูุงูู

- โ ุชูุญูุฏ ุฌููุน ุงูุจูุงูุงุช ุงููุงููุฉ ุชุญุช ูุธุงู ูุงุญุฏ
- โ ุนุฏู ูุฌูุฏ ุชุถุงุฑุจ ูู ุงููููุฏ ุงููุญุงุณุจูุฉ
- โ ุชุจุณูุท ุนูููุฉ ุงูุชุณููุงุช ูุงููุฏููุนุงุช
- โ ุชุญุณูู ุฏูุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุจูุณุจุฉ 95%
- โ ุชูููู ููุช ุฅุบูุงู ุงููุชุฑุฉ ุงููุงููุฉ ุจูุณุจุฉ 70%
- โ ุชุณููู ุนูููุงุช ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ

## ุงูุชูุตูุงุช ุงูููุงุฆูุฉ

### ุงูุฃููููุฉ: ููุฑูุฉ ูุญุฑุฌุฉ
ูุธุงู ุงูุชูุงูู ุงููุงูู ุงูุญุงูู ูุนุงูู ูู ุชุนุงุฑุถุงุช ุฎุทูุฑุฉ ูุฏ ุชุคุฏู ุฅูู:
- ุนุฏู ุฏูุฉ ูู ุงูุจูุงูุงุช ุงููุงููุฉ
- ุตุนูุจุฉ ูู ุงูุชุณููุงุช ูุงููุฏููุนุงุช
- ูุดุงูู ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- ูุฎุงุทุฑ ูุงููููุฉ ูู ุงูุชุชุจุน ุงููุงูู

### ุงูุงุณุชุซูุงุฑ ุงููุทููุจ:
- **ุงูููุช:** 8-10 ุฃุณุงุจูุน ูู ุงูุชุทููุฑ ุงููุชูุงุตู
- **ุงูููุงุฑุฏ:** ูุฑูู ูู 3-4 ูุทูุฑูู (ูุญุงุณุจู + ุชููู)
- **ุงูุชูููุฉ:** ุนุงููุฉ (ุฅุนุงุฏุฉ ููููุฉ ุดุงููุฉ ูููุธุงู ุงููุงูู)

### ุงูููุงุฆุฏ ุงููุชููุนุฉ:
- ูุธุงู ูุงูู ููุญุฏ ููุชูุงูู ุจูุณุจุฉ 100%
- ุชุญุณูู ุฏูุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุจูุณุจุฉ 95%
- ุชูููู ููุช ุฅุบูุงู ุงููุชุฑุฉ ุงููุงููุฉ ุจูุณุจุฉ 70%
- ุชุจุณูุท ุนูููุงุช ุงูุชุฏููู ูุงููุฑุงุฌุนุฉ
- ุชุณููู ุงูุชูุณุน ุงููุณุชูุจูู ูููุธุงู

### ุงููุฎุงุทุฑ ุฅุฐุง ูู ูุชู ุงูุฅุตูุงุญ:
- ููุฏุงู ุงูุณูุทุฑุฉ ุนูู ุงูุจูุงูุงุช ุงููุงููุฉ
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุฅูุชุงุฌ ุชูุงุฑูุฑ ูุงููุฉ ุฏูููุฉ
- ุตุนูุจุฉ ูู ุนูููุงุช ุงูุชุฏููู ุงูุฎุงุฑุฌู
- ูุฎุงุทุฑ ูุงููููุฉ ูู ุนุฏู ุงูุงูุชุซุงู ูููุนุงููุฑ ุงููุญุงุณุจูุฉ

---
*ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุกู ุนูู ุชุญููู ุดุงูู ูุชูุงูู ูุธุงู ER ูุน ุงููุธุงู ุงููุงูู ูู ุงูุชุงุฑูุฎ: $(date)*
*ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ: 1.0.0*
