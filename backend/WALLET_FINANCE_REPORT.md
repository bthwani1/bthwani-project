# ุชูุฑูุฑ ูุธุงู ุงููุญูุธุฉ ูุงููุงููุฉ - ุชุญููู ุดุงูู ูุนููู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงููุธุงู ุงููุงูู

ุชู ุฅุฌุฑุงุก ุชุญููู ุดุงูู ูุฃูุธูุฉ ุงููุญูุธุฉ ูุงููุงููุฉ ูู ุงููุธุงูุ ุญูุซ ุชู ุงูุชุดุงู **4 ุฃูุธูุฉ ูุงููุฉ ูุฎุชููุฉ** ุชุนูู ูู ููุช ูุงุญุฏ ูุน ุชุนุงุฑุถุงุช ูุชุนุฏุฏุฉ ูู ุงูุชุทุจูู ูุงูุชูููุฐ.

### ุงูุฃูุธูุฉ ุงููุงููุฉ ุงูููุชุดูุฉ:

1. **User.wallet** - ูุธุงู ูุญูุธุฉ ูุชูุงูู ูู ูููุฐุฌ ุงููุณุชุฎุฏู
2. **Driver.wallet** - ูุธุงู ูุญูุธุฉ ูุจุณุท ูู ูููุฐุฌ ุงูุณุงุฆู
3. **WalletAccount** - ูุธุงู ูุญุงุณุจู ูุชูุฏู ูููุตู
4. **Wallet_V8** - ูุธุงู ูุนุงููุงุช ูุงููุฉ ูููุตู ุขุฎุฑ

## ุชุญููู ููุตู ููู ูุธุงู

### 1. ูุธุงู User.wallet ๐ฆ

#### ุงููููู ูุงูุฎุตุงุฆุต:
```typescript
// ูู src/models/user.ts
const WalletSchema = new mongoose.Schema({
  balance: { type: Number, default: 0 },        // ุงูุฑุตูุฏ ุงูุญุงูู
  onHold: { type: Number, default: 0 },         // ุงููุจุงูุบ ุงููุญุฌูุฒุฉ
  currency: { type: String, default: "YER" },   // ุงูุนููุฉ
  totalSpent: { type: Number, default: 0 },     // ุฅุฌูุงูู ุงููุตุฑููุงุช
  totalEarned: { type: Number, default: 0 },    // ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
  loyaltyPoints: { type: Number, default: 0 },  // ููุงุท ุงูููุงุก
  savings: { type: Number, default: 0 },        // ุงููุฏุฎุฑุงุช
  lastUpdated: { type: Date, default: Date.now }
});
```

#### ุขููุฉ ุงูุนูู:
- **ุงูุฅูุฏุงุน:** ูุฒูุฏ `balance` ู `totalEarned`
- **ุงูุญุฌุฒ:** ูุฒูุฏ `onHold` ููููู ูู ุงูุฑุตูุฏ ุงููุชุงุญ
- **ุงูุฎุตู:** ูููู `balance` ููุฒูุฏ `totalSpent`
- **ุงูุฅูุฑุงุฌ:** ูููู `onHold` ููุนูุฏ ุงูุฑุตูุฏ

#### ููุงุท ุงูููุฉ:
โ ูุธุงู ูุชูุงูู ููุฑู
โ ูุฏุนู ุงูุญุฌุฒ ูุงูุฅูุฑุงุฌ
โ ูุญุชูู ุนูู ุชุชุจุน ุดุงูู ูููุนุงููุงุช

#### ููุงุท ุงูุถุนู:
โ ุบูุฑ ูุฑุชุจุท ุจูุธุงู ุงููุญุงุณุจุฉ ุงูุฑุฆูุณู
โ ูุง ูุฏุนู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ ูุนููุงู

---

### 2. ูุธุงู Driver.wallet ๐

#### ุงููููู ูุงูุฎุตุงุฆุต:
```typescript
// ูู src/models/Driver_app/driver.ts
wallet: {
  balance: number;      // ุงูุฑุตูุฏ ุงูุญุงูู
  earnings: number;     // ุงูุฃุฑุจุงุญ ุงููุชุฑุงููุฉ
  lastUpdated: Date;    // ุขุฎุฑ ุชุญุฏูุซ
}
```

#### ุขููุฉ ุงูุนูู:
- ูุธุงู ุจุณูุท ุฌุฏุงู ููุงุฑูุฉ ุจู User.wallet
- ูุนุชูุฏ ุนูู `earnings` ูุชุชุจุน ุงูุฃุฑุจุงุญ
- ูุง ูุฏุนู ุงูุญุฌุฒ ุฃู ุงูุฅูุฑุงุฌ

#### ููุงุท ุงูููุฉ:
โ ุจุณุงุทุฉ ูู ุงูุชูููุฐ
โ ูุฑุชุจุท ูุจุงุดุฑุฉ ุจุฃุฏุงุก ุงูุณุงุฆู

#### ููุงุท ุงูุถุนู:
โ ูุธุงู ูุญุฏูุฏ ุฌุฏุงู
โ ุบูุฑ ูุฑุชุจุท ุจูุธุงู ุงููุญุงุณุจุฉ
โ ูุง ูุฏุนู ุงููุนุงููุงุช ุงููุนูุฏุฉ

---

### 3. ูุธุงู WalletAccount ๐ผ

#### ุงููููู ูุงูุฎุตุงุฆุต:
```typescript
// ูู src/models/finance/WalletAccount.ts
export interface IWalletAccount extends Document {
  owner_type: 'driver' | 'vendor' | 'company' | 'user';
  owner_id: mongoose.Types.ObjectId;
  currency: string;
  status: 'active' | 'inactive' | 'suspended';
}
```

#### ุขููุฉ ุงูุนูู:
- ูุธุงู ูุญุงุณุจู ูุชูุฏู ูุนุชูุฏ ุนูู `LedgerEntry` ู `LedgerSplit`
- ูุฏุนู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
- ูุฑุชุจุท ุจูุธุงู ุงูุชุณููุงุช ูุงููุฏููุนุงุช

#### ููุงุท ุงูููุฉ:
โ ูุธุงู ูุญุงุณุจู ูุชูุฏู ููุฑู
โ ูุฏุนู ุงูุนููุงุช ุงููุชุนุฏุฏุฉ
โ ูุฑุชุจุท ุจูุธุงู ุงูุชุณููุงุช

#### ููุงุท ุงูุถุนู:
โ ุชุนููุฏ ูู ุงูุชูููุฐ ูุงูููู
โ ูุง ูุฑุชุจุท ูุจุงุดุฑุฉ ุจููุงุฐุฌ ุงููุณุชุฎุฏููู

---

### 4. ูุธุงู Wallet_V8 ๐ฐ

#### ุงููููู ูุงูุฎุตุงุฆุต:
```typescript
// ูู src/models/Wallet_V8/wallet.model.ts
const WalletTransactionSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  userModel: { type: String, enum: ["User", "Driver"] },
  amount: { type: Number },
  type: { type: String, enum: ["credit", "debit"] },
  method: { type: String, enum: ["agent", "card", "transfer", "payment", "escrow", "reward", "kuraimi", "withdrawal"] },
  status: { type: String, enum: ["pending", "completed", "failed", "reversed"] }
});
```

#### ุขููุฉ ุงูุนูู:
- ูุธุงู ูุนุงููุงุช ูููุตู ุชูุงูุงู
- ูุฏุนู ุทุฑู ุฏูุน ูุชุนุฏุฏุฉ
- ูุญุชูู ุนูู ูุธุงู ุญุงูุงุช ูุชูุฏู

#### ููุงุท ุงูููุฉ:
โ ูุฏุนู ุทุฑู ุฏูุน ูุชุนุฏุฏุฉ
โ ูุธุงู ุญุงูุงุช ุดุงูู
โ ูุฑุชุจุท ุจู Kuraimi ููุฏูุน

#### ููุงุท ุงูุถุนู:
โ ูุธุงู ูููุตู ุชูุงูุงู ุนู ุจุงูู ุงููุญุงูุธ
โ ูุฏ ูุณุจุจ ุชุถุงุฑุจ ูู ุงูุจูุงูุงุช

## ุงูุชุฏูู ุงููุงูู ูู ุงูุทูุจุงุช

### ุชุฏูู ุงูุฃููุงู ูู ุทูุจ ุนุงุฏู:

1. **ุงููุณุชุฎุฏู ูุทูุจ** โ `holdForOrder()` ูุญุฌุฒ ุงููุจูุบ ูู `User.wallet`
2. **ุงูุชุงุฌุฑ ููุจู** โ ูุง ุชุบููุฑ ูุงูู
3. **ุงูุณุงุฆู ููุจู** โ ูุง ุชุบููุฑ ูุงูู
4. **ุงูุชุณููู ูุชู** โ `captureOrder()` ูุฎุตู ุงููุจูุบ ููุงุฆูุงู ูู `User.wallet`
5. **ุงูุชุณููุฉ** โ ูุชู ุฏูุน ุงูุฃุฑุจุงุญ ููุณุงุฆู ูุงูุชุงุฌุฑ ุนุจุฑ `WalletAccount`

### ูุดุงูู ุงูุชุฏูู ุงููุงูู ุงูููุชุดูุฉ:

#### 1. ุชุถุงุฑุจ ูู ุงูุญุฌุฒ ูุงูุฅูุฑุงุฌ ๐ด ุญุฑุฌ
```typescript
// ูู User.wallet: ูุชู ุงูุญุฌุฒ ูุงูุฅูุฑุงุฌ ูู ููุณ ุงููููุฐุฌ
user.wallet.onHold += amount;  // ุญุฌุฒ
user.wallet.onHold -= amount;  // ุฅูุฑุงุฌ

// ูู Wallet_V8: ูุชู ุชุชุจุน ุงููุนุงููุงุช ุจุดูู ูููุตู
const tx = new WalletTransaction({ method: "escrow", status: "pending" });
```

#### 2. ุชุถุงุฑุจ ูู ูุธุงู ุงูุชุณููุงุช ๐ด ุญุฑุฌ
- ุงูุณุงุฆููู ูุญุตููู ุนูู ุฃุฑุจุงุญูู ูู `Driver.wallet` ู `WalletAccount`
- ุงูุชุฌุงุฑ ูุญุตููู ุนูู ุฃุฑุจุงุญูู ูู `WalletAccount` ููุท
- ุนุฏู ูุฌูุฏ ุฑุจุท ูุงุถุญ ุจูู ุงูุฃูุธูุฉ ุงููุฎุชููุฉ

#### 3. ุชุถุงุฑุจ ูู ุทุฑู ุงูุฏูุน ๐ก ูุชูุณุท
- ุจุนุถ ุงููุนุงููุงุช ุชุชู ุนุจุฑ `User.wallet`
- ุฃุฎุฑู ุชุชู ุนุจุฑ `Wallet_V8`
- ุนุฏู ูุฌูุฏ ุชูุญูุฏ ูู ุทุฑู ุงูุฏูุน

## ุงูุชุนุงุฑุถุงุช ุงููุงููุฉ ุงูููุชุดูุฉ

### 1. ุชุนุงุฑุถ ูู ุชุฎุฒูู ุงูุจูุงูุงุช ุงููุงููุฉ ๐ด ุญุฑุฌ

| ูุธุงู | ูููุน ุงูุชุฎุฒูู | ุทุฑููุฉ ุงูุชุชุจุน | ุงูุนููุฉ |
|-------|---------------|----------------|---------|
| User.wallet | `user.wallet` | ูุจุงุดุฑ ูู ุงููููุฐุฌ | YER ุซุงุจุช |
| Driver.wallet | `driver.wallet` | ูุจุงุดุฑ ูู ุงููููุฐุฌ | ูุง ุชุญุฏุฏ |
| WalletAccount | ุฌุฏุงูู ูููุตูุฉ | ูุธุงู Ledger | ูุชุนุฏุฏุฉ |
| Wallet_V8 | ุฌุฏูู ูููุตู | ูุธุงู ูุนุงููุงุช | ูุง ุชุญุฏุฏ |

### 2. ุชุนุงุฑุถ ูู ุขููุฉ ุงูุญุฌุฒ ูุงูุฅูุฑุงุฌ ๐ด ุญุฑุฌ

```typescript
// User.wallet - ูุญุฌุฒ ูู ููุณ ุงููููุฐุฌ
user.wallet.onHold += amount;

// Wallet_V8 - ููุดุฆ ูุนุงููุฉ ูููุตูุฉ
const tx = new WalletTransaction({ method: "escrow", status: "pending" });
```

### 3. ุชุนุงุฑุถ ูู ูุธุงู ุงูุชุณููุงุช ๐ก ูุชูุณุท

- ุงูุณุงุฆููู ูุฏููู ูุธุงููู: `Driver.wallet` ู `WalletAccount`
- ุงูุชุฌุงุฑ ูุฏููู ูุธุงู ูุงุญุฏ: `WalletAccount`
- ุนุฏู ูุฌูุฏ ุชูุญูุฏ ูู ุขููุฉ ุงูุฏูุน

## ุญููู ููุชุฑุญุฉ ููุชุนุงุฑุถุงุช

### ุงูุญู ุงููุซุงูู: ูุธุงู ูุญูุธุฉ ููุญุฏ

#### 1. ุฅูุดุงุก ูุธุงู ูุญูุธุฉ ููุญุฏ (Unified Wallet System)

```typescript
// src/models/wallet/UnifiedWallet.ts
export interface IUnifiedWallet extends Document {
  owner_id: mongoose.Types.ObjectId;
  owner_type: 'user' | 'driver' | 'vendor' | 'company';
  currency: string;

  // ุงูุฃุฑุตุฏุฉ
  available_balance: number;    // ูุชุงุญ ููุงุณุชุฎุฏุงู
  pending_balance: number;     // ูุญุฌูุฒ ูุคูุชุงู
  total_balance: number;       // ุงูุฅุฌูุงูู

  // ุงูุฅุญุตุงุฆูุงุช
  total_earned: number;
  total_spent: number;
  total_withdrawn: number;

  // ุงูุญุงูุฉ
  status: 'active' | 'suspended' | 'closed';

  // ุงููุนุงููุงุช
  transactions: IWalletTransaction[];
}
```

#### 2. ุชูุญูุฏ ุทุฑู ุงูุฏูุน ูุงููุนุงููุงุช

```typescript
// src/services/wallet/unified.service.ts
export class UnifiedWalletService {
  static async holdAmount(
    ownerId: string,
    ownerType: string,
    amount: number,
    reference: string,
    reason: string
  ): Promise<void> {
    // ุชูุญูุฏ ููุทู ุงูุญุฌุฒ ุนุจุฑ ุฌููุน ุงูุฃูุธูุฉ
  }

  static async releaseAmount(
    ownerId: string,
    ownerType: string,
    amount: number,
    reference: string
  ): Promise<void> {
    // ุชูุญูุฏ ููุทู ุงูุฅูุฑุงุฌ
  }

  static async transfer(
    fromOwnerId: string,
    fromOwnerType: string,
    toOwnerId: string,
    toOwnerType: string,
    amount: number,
    reason: string
  ): Promise<void> {
    // ุชูุญูุฏ ุงููุนุงููุงุช ุจูู ุงูุฃุทุฑุงู
  }
}
```

#### 3. ูุธุงู ูุญุงุณุจุฉ ููุญุฏ

```typescript
// ุฑุจุท ุงููุธุงู ุงูููุญุฏ ุจูุธุงู Ledger
export async function createUnifiedLedgerEntry(
  eventType: string,
  reference: string,
  debitAccount: string,
  creditAccount: string,
  amount: number,
  description: string
): Promise<void> {
  // ุฅูุดุงุก ููุฏ ูุญุงุณุจู ููุญุฏ
  const entry = new LedgerEntry({
    event_type: eventType,
    event_ref: reference,
    description,
    total_debit: amount,
    total_credit: amount
  });

  // ุฅูุดุงุก ุชูุตููุงุช ุงูุญุณุงุจุงุช
  await LedgerSplit.create([
    { account_id: debitAccount, side: 'debit', amount },
    { account_id: creditAccount, side: 'credit', amount }
  ]);
}
```

### ุฎุทุฉ ุงูุชูููุฐ ุงูุชุฏุฑูุฌูุฉ

#### ุงููุฑุญูุฉ 1: ุงูุชุญููู ูุงูุชุฎุทูุท (ุฃุณุจูุน 1)
- [ ] ุฑุณู ุฎุฑุงุฆุท ุงูุชูุงุนูุงุช ุงููุงููุฉ ุงูุญุงููุฉ
- [ ] ุชุญุฏูุฏ ููุงุท ุงูุชุถุงุฑุจ ุจุฏูุฉ
- [ ] ุชุตููู ุงููุธุงู ุงูููุญุฏ

#### ุงููุฑุญูุฉ 2: ุจูุงุก ุงููุธุงู ุงูุฃุณุงุณู (ุฃุณุจูุน 2-3)
- [ ] ุฅูุดุงุก ููุงุฐุฌ ุงูุจูุงูุงุช ุงูููุญุฏุฉ
- [ ] ุจูุงุก ุฎุฏูุงุช ุงููุญูุธุฉ ุงูููุญุฏุฉ
- [ ] ุชุทููุฑ ูุธุงู ุงููุนุงููุงุช ุงูููุญุฏ

#### ุงููุฑุญูุฉ 3: ุงููุฌุฑุฉ ุงูุชุฏุฑูุฌูุฉ (ุฃุณุจูุน 4-5)
- [ ] ููู ุงูุจูุงูุงุช ูู ุงูุฃูุธูุฉ ุงููุฏููุฉ
- [ ] ุชุญุฏูุซ ุงูู controllers ูุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฌุฏูุฏ
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ููุชูุงูู

#### ุงููุฑุญูุฉ 4: ุงูุชุญูู ูุงูุชุญุณูู (ุฃุณุจูุน 6)
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ูุฌููุน ุงูุณููุงุฑูููุงุช
- [ ] ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
- [ ] ุชุญุณูู ุงูุฃุฏุงุก ุญุณุจ ุงูุญุงุฌุฉ

## ูุคุดุฑุงุช ุงููุฌุงุญ

- โ ุชูุญูุฏ ุฌููุน ุฃููุงุน ุงููุญุงูุธ ุชุญุช ูุธุงู ูุงุญุฏ
- โ ุนุฏู ูุฌูุฏ ุชุถุงุฑุจ ูู ุงูุจูุงูุงุช ุงููุงููุฉ
- โ ุชุจุณูุท ุนูููุฉ ุงูุชุณููุงุช ูุงููุฏููุนุงุช
- โ ุชุญุณูู ุฏูุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- โ ุชูููู ููุช ูุนุงูุฌุฉ ุงููุนุงููุงุช ุจูุณุจุฉ 60%
- โ ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ูู ุงูุนูููุงุช ุงููุงููุฉ

## ุงูุชูุตูุงุช ุงูููุงุฆูุฉ

### ุงูุฃููููุฉ: ููุฑูุฉ ูุญุฑุฌุฉ
ูุธุงู ุงููุญูุธุฉ ุงูุญุงูู ูุญุชูู ุนูู ุชุนุงุฑุถุงุช ุฎุทูุฑุฉ ูุฏ ุชุคุฏู ุฅูู:
- ููุฏุงู ุงูุจูุงูุงุช ุงููุงููุฉ
- ุชุถุงุฑุจ ูู ุงูุญุณุงุจุงุช
- ุตุนูุจุฉ ูู ุงูุชุณููุงุช ูุงููุฏููุนุงุช
- ูุดุงูู ูุงููููุฉ ูู ุงูุชุชุจุน ุงููุงูู

### ุงูุงุณุชุซูุงุฑ ุงููุทููุจ:
- **ุงูููุช:** 6 ุฃุณุงุจูุน ูู ุงูุชุทููุฑ ุงููุชูุงุตู
- **ุงูููุงุฑุฏ:** ูุฑูู ูู 2-3 ูุทูุฑูู
- **ุงูุชูููุฉ:** ูุชูุณุทุฉ (ุฅุนุงุฏุฉ ููููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช)

### ุงูููุงุฆุฏ ุงููุชููุนุฉ:
- ูุธุงู ูุงูู ููุญุฏ ููุชุณู ุจูุณุจุฉ 100%
- ุชุญุณูู ุฏูุฉ ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุจูุณุจุฉ 90%
- ุชูููู ููุช ูุนุงูุฌุฉ ุงููุนุงููุงุช ุจูุณุจุฉ 60%
- ุชุจุณูุท ุงูุตูุงูุฉ ูุงูุชุทููุฑ ุงููุณุชูุจูู

---
*ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุกู ุนูู ุชุญููู ุดุงูู ูุฃูุธูุฉ ุงููุญูุธุฉ ูุงููุงููุฉ ูู ุงูุชุงุฑูุฎ: $(date)*
*ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ: 1.0.0*
