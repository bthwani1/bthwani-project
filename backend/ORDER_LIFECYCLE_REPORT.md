# ุชูุฑูุฑ ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ - ุชุญููู ุดุงูู ูุนููู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ูุธุงู ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ

ุชู ุงูุชุดุงู ูุธุงู ุทูุจุงุช ูุชุทูุฑ ููุนูุฏ ูุชุถูู **12 ุญุงูุฉ ุฑุฆูุณูุฉ** ูุน ุชูุงูู ูุงูู ูุชุดุบููู ูุชูุฏูุ ุจุงูุฅุถุงูุฉ ุฅูู ูุธุงู ูุฑุนู ููุทูุจุงุช ุงููุฑุนูุฉ.

### ุฃููุงุน ุงูุทูุจุงุช ุงููุฏุนููุฉ:
1. **ุทูุจุงุช ุงูุณูู (Marketplace)** - ุทูุจุงุช ุนุงุฏูุฉ ูู ูุชุงุฌุฑ ูุชุนุฏุฏุฉ
2. **ุทูุจุงุช ุงูููุงู (Errand)** - ุทูุจุงุช ุฎุฏูุงุช ูุซู ุงูุชูุตูู ุฃู ุงูุดุฑุงุก
3. **ุทูุจุงุช ุงููุฑุงูู (Utility)** - ุทูุจุงุช ุฎุฏูุงุช ูุซู ุงูุบุงุฒ ุฃู ุงููุงุก

## ุชุญููู ููุตู ููููุฐุฌ ุงูุทูุจ

### 1. ุงููููู ุงูุฃุณุงุณู ููุทูุจ ๐

```typescript
// src/models/delivery_marketplace_v1/Order.ts
export interface IDeliveryOrder extends Document {
  // ุงููููุฉ ูุงูุฃุทุฑุงู
  user: Types.ObjectId | UserType;        // ุงูุนููู
  driver?: Types.ObjectId | IDriver;      // ุงูุณุงุฆู (ุงุฎุชูุงุฑู)
  coupon?: ICoupon;                       // ุงูููุจูู ุงููุณุชุฎุฏู

  // ุนูุงุตุฑ ุงูุทูุจ
  items: IOrderItem[];                    // ููุชุฌุงุช ุงูุทูุจ ุงูุฑุฆูุณูุฉ
  subOrders: ISubOrder[];                 // ุทูุจุงุช ูุฑุนูุฉ ููู ูุชุฌุฑ

  // ุงููุนูููุงุช ุงููุงููุฉ
  price: number;                          // ุฅุฌูุงูู ุงูุณุนุฑ
  deliveryFee: number;                    // ุฑุณูู ุงูุชูุตูู
  companyShare: number;                   // ุญุตุฉ ุงูููุตุฉ
  platformShare: number;                  // ุญุตุฉ ุงูููุตุฉ (ุชูุฑุงุฑุ)
  walletUsed: number;                     // ุงููุจูุบ ุงููุฏููุน ูู ุงููุญูุธุฉ
  cashDue: number;                        // ุงููุจูุบ ุงููุชุจูู ููุฏุงู

  // ุงููููุน ูุงูุชุณููู
  address: {
    label: string;
    street: string;
    city: string;
    location: { lat: number; lng: number };
  };
  deliveryMode: "unified" | "split";      // ุชุณููู ููุญุฏ ุฃู ูููุตู

  // ุทุฑููุฉ ุงูุฏูุน ูุงูุญุงูุฉ
  paymentMethod: "wallet" | "card" | "cash" | "mixed";
  paid: boolean;                          // ูู ุชู ุงูุฏูุนุ
  status: OrderStatus;                    // ุงูุญุงูุฉ ุงูุญุงููุฉ

  // ุงูุชุชุจุน ูุงูุชุณุฌูู
  statusHistory: IStatusHistoryEntry[];   // ุชุงุฑูุฎ ุชุบููุฑ ุงูุญุงูุงุช
  scheduledFor?: Date;                    // ููุนุฏ ุงูุชุณููู ุงููุฌุฏูู
  assignedAt?: Date;                      // ููุช ุฅุณูุงุฏ ุงูุณุงุฆู
  deliveryReceiptNumber?: string;         // ุฑูู ุฅูุตุงู ุงูุชุณููู

  // ูุนูููุงุช ุฅุถุงููุฉ
  returnReason?: string;                  // ุณุจุจ ุงูุฅุฑุฌุงุน/ุงูุฅูุบุงุก
  returnBy?: "admin" | "customer" | "driver" | "store";
  orderType: OrderType;                   // ููุน ุงูุทูุจ
  errand?: IErrand;                       // ุชูุงุตูู ุทูุจ ุงููููุฉ
  utility?: IUtility;                     // ุชูุงุตูู ุทูุจ ุงููุฑุงูู
  deliveredAt?: Date;                     // ููุช ุงูุชุณููู ุงููุนูู
  notes?: INote[];                        // ุงูููุงุญุธุงุช
  rating?: IRating;                       // ุงูุชูููู ุจุนุฏ ุงูุชุณููู
}
```

### 2. ูุธุงู ุงูุญุงูุงุช ูุงูุงูุชูุงูุงุช ๐

#### ุญุงูุงุช ุงูุทูุจ ุงูู 13:

```typescript
export type OrderStatus =
  | "pending_confirmation"  // ูู ุงูุชุธุงุฑ ุชุฃููุฏ ุงูุทูุจ ูู ุงูุฅุฏุงุฑุฉ
  | "under_review"          // ููุฏ ุงููุฑุงุฌุนุฉ โ ุชูุนุทู ููุฏูููุฑู
  | "preparing"             // ููุฏ ุงูุชุญุถูุฑ (ุฏุงุฎู ุงููุทุนู/ุงููุชุฌุฑ)
  | "assigned"              // ููุฏ ุงูุชูุตูู (ูู ุงูุฏูููุฑู)
  | "out_for_delivery"      // ูู ุงูุทุฑูู ุฅููู (ูู ุงูุฏูููุฑู)
  | "delivered"             // ุชู ุงูุชูุตูู
  | "returned"              // ุชู ุงูุฅุฑุฌุงุน
  | "awaiting_procurement"  // ูู ุงูุชุธุงุฑ ุงูุชูุฑูุฏ
  | "procured"              // ุชู ุงูุชูุฑูุฏ
  | "procurement_failed"    // ูุดู ุงูุชูุฑูุฏ
  | "cancelled";            // ุชู ุงูุฅูุบุงุก
```

#### ูุตูููุฉ ุงูุงูุชูุงูุงุช ุงููุณููุญุฉ:

| ูู ุงูุญุงูุฉ | ุฅูู ุงูุญุงูุงุช ุงููุณููุญุฉ |
|-----------|---------------------|
| `pending_confirmation` | `under_review`, `cancelled` |
| `under_review` | `preparing`, `awaiting_procurement`, `cancelled` |
| `preparing` | `out_for_delivery`, `cancelled`, `returned` |
| `assigned` | `out_for_delivery`, `cancelled`, `returned` |
| `out_for_delivery` | `delivered`, `returned` |
| `awaiting_procurement` | `procured`, `procurement_failed`, `cancelled` |
| `procured` | `preparing`, `cancelled` |
| `procurement_failed` | `awaiting_procurement`, `cancelled` |
| `delivered` | *(ููุงุฆู - ูุง ุงูุชูุงูุงุช)* |
| `returned` | *(ููุงุฆู - ูุง ุงูุชูุงูุงุช)* |
| `cancelled` | *(ููุงุฆู - ูุง ุงูุชูุงูุงุช)* |

### 3. ูุธุงู ุงูุทูุจุงุช ุงููุฑุนูุฉ (Sub Orders) ๐

#### ูููู ุงูุทูุจ ุงููุฑุนู:
```typescript
interface ISubOrder {
  store: Types.ObjectId;                    // ุงููุชุฌุฑ ุงููุณุคูู
  items: {                                  // ููุชุฌุงุช ูุฐุง ุงููุชุฌุฑ
    product: Types.ObjectId;
    productType: string;
    quantity: number;
    unitPrice: number;
  }[];
  driver?: Types.ObjectId;                  // ุณุงุฆู ูุฑุนู (ุงุฎุชูุงุฑู)
  deliveryReceiptNumber?: string;           // ุฑูู ุฅูุตุงู ูููุตู
  status: OrderStatus;                      // ุญุงูุฉ ูููุตูุฉ ููู ูุชุฌุฑ
  statusHistory: IStatusHistoryEntry[];     // ุชุงุฑูุฎ ุงูุญุงูุงุช ุงููุฑุนูุฉ
}
```

#### ุขููุฉ ุนูู ุงูุทูุจุงุช ุงููุฑุนูุฉ:
1. **ุชูุณูู ุงูุทูุจ** ุญุณุจ ุงููุชุงุฌุฑ ุงููุฎุชููุฉ
2. **ุชุชุจุน ูููุตู** ููู ูุชุฌุฑ (ุญุงูุฉุ ุณุงุฆูุ ุฅูุตุงู)
3. **ุชุณููู ูุณุชูู** ููู ูุชุฌุฑ
4. **ุชูููู ูููุตู** ููู ูุชุฌุฑ

## ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุงููุงููุฉ

### ุงููุฑุญูุฉ 1: ุฅูุดุงุก ุงูุทูุจ (Order Creation) ๐

#### ุฎุทูุงุช ุงูุฅูุดุงุก:
1. **ุงูุชุญูู ูู ุงููุณุชุฎุฏู** - `verifyFirebase`
2. **ุญุณุงุจ ุงูุณุนุฑ ุงูุฅุฌูุงูู** - `calculateDeliveryPrice()`
3. **ุชุทุจูู ุงูุนุฑูุถ ูุงูููุจููุงุช** - `fetchActivePromotions()`
4. **ุญุฌุฒ ุงููุจูุบ ูู ุงููุญูุธุฉ** - `holdForOrder()`
5. **ุฅูุดุงุก ุงูุทูุจ ูุงูุทูุจุงุช ุงููุฑุนูุฉ** - `createOrder()`
6. **ุฅุฑุณุงู ุฅุดุนุงุฑ** - `notifyOrder("order.created")`

#### ุงููุนูููุงุช ุงููุทููุจุฉ ููุฅูุดุงุก:
```typescript
{
  // ุงููููุน ูุงูุชุณููู
  address: {
    label: string,
    street: string,
    city: string,
    location: { lat: number, lng: number }
  },

  // ุทุฑููุฉ ุงูุฏูุน
  paymentMethod: "wallet" | "card" | "cash" | "mixed",

  // ุนูุงุตุฑ ุงูุทูุจ
  items: [{
    productType: "merchantProduct" | "deliveryProduct",
    productId: ObjectId,
    quantity: number,
    store: ObjectId
  }],

  // ุฎูุงุฑุงุช ุฅุถุงููุฉ
  couponCode?: string,
  notes?: string,
  scheduledFor?: Date
}
```

### ุงููุฑุญูุฉ 2: ูุนุงูุฌุฉ ุงูุทูุจ (Order Processing) โ๏ธ

#### ุฎุทูุงุช ุงููุนุงูุฌุฉ:
1. **ูุฑุงุฌุนุฉ ุงูุทูุจ** - `status: "under_review"`
2. **ุงูุจุญุซ ุนู ุณุงุฆููู ูุชุงุญูู** - `broadcastOffersForOrder()`
3. **ุฅุณูุงุฏ ุงูุณุงุฆู** - `assignDriver()` ุฃู `assignDriverToSubOrder()`
4. **ุชุญุฏูุซ ุญุงูุฉ ุงูุณุงุฆู** - `status: "assigned"`

#### ุขููุฉ ุฅุณูุงุฏ ุงูุณุงุฆููู:
- **ุงูุจุญุซ ุญุณุจ ุงููููุน** - ูุณุงูุฉ ูู ูููุน ุงูุณุงุฆู
- **ุงูุจุญุซ ุญุณุจ ุงููุฑูุจุฉ** - ููุน ูุชุตููู ุงููุฑูุจุฉ
- **ุงูุจุญุซ ุญุณุจ ุงูุชููุฑ** - `isAvailable: true`
- **ุฅุฑุณุงู ุงูุนุฑูุถ** ููุณุงุฆููู ุงูููุงุณุจูู

### ุงููุฑุญูุฉ 3: ุชุฌููุฒ ุงูุทูุจ (Order Preparation) ๐ณ

#### ุฎุทูุงุช ุงูุชุฌููุฒ:
1. **ูุจูู ุงููุชุฌุฑ** - `vendorAcceptOrder()`
2. **ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ** - `status: "preparing"`
3. **ุฅุดุนุงุฑ ุงูุณุงุฆู** - `notifyOrder("order.preparing")`
4. **ุชุฌููุฒ ุงูููุชุฌุงุช** ูู ุงููุชุฌุฑ

#### ุฏูุฑ ุงููุชุงุฌุฑ ูู ุงูุชุฌููุฒ:
- **ุงูุชุญูู ูู ุงููุฎุฒูู** - ุงูุชุฃูุฏ ูู ุชููุฑ ุงูููุชุฌุงุช
- **ุญุณุงุจ ููุช ุงูุชุฌููุฒ** - ุญุณุจ ููุน ุงูููุชุฌุงุช
- **ุฅุนุฏุงุฏ ุงูุทูุจ** ููุชุณููู

### ุงููุฑุญูุฉ 4: ุงูุชุณููู (Order Delivery) ๐

#### ุฎุทูุงุช ุงูุชุณููู:
1. **ุงุณุชูุงู ุงูุณุงุฆู ููุทูุจ** - `driverPickUp()`
2. **ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ** - `status: "out_for_delivery"`
3. **ุจุฏุก ุงูุชุณููู** - `driverDeliver()`
4. **ุฅุชูุงู ุงูุชุณููู** - `status: "delivered"`

#### ุขููุฉ ุงูุชุณููู:
- **ุชุชุจุน ุงููููุน** - ุชุญุฏูุซ ูููุน ุงูุณุงุฆู ุฃุซูุงุก ุงูุชุณููู
- **ุชุฃููุฏ ุงูุงุณุชูุงู** - ูู ุงูุณุงุฆู ุนูุฏ ุงููุตูู ูููุชุฌุฑ
- **ุชุฃููุฏ ุงูุชุณููู** - ูู ุงูุณุงุฆู ุนูุฏ ุงููุตูู ููุนููู
- **ุฅุดุนุงุฑุงุช ููุฑูุฉ** - ูุฌููุน ุงูุฃุทุฑุงู

### ุงููุฑุญูุฉ 5: ุงูุชูููู ูุงูุฅุบูุงู (Order Completion) โญ

#### ุฎุทูุงุช ุงูุชูููู:
1. **ุฅููุงููุฉ ุงูุชูููู** - ุจุนุฏ `status: "delivered"`
2. **ูุธุงู ุงูุชูููู ุงูุซูุงุซู** - ุงูููุตุฉุ ุงูุทูุจุ ุงูุณุงุฆู
3. **ุญุณุงุจ ูุชูุณุท ุงูุชููููุงุช** - ูููุชุงุฌุฑ ูุงูุณุงุฆููู
4. **ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช** - `updateStoresRatingsForOrder()`

#### ุขููุฉ ุงูุชูููู:
```typescript
order.rating = {
  company: number,     // ุชูููู ุงูููุตุฉ (1-5)
  order: number,       // ุชูููู ุงูุทูุจ (1-5)
  driver: number,      // ุชูููู ุงูุณุงุฆู (1-5)
  comments?: string,   // ุชุนูููุงุช ุฅุถุงููุฉ
  ratedAt: Date        // ููุช ุงูุชูููู
};
```

## ูุธุงู ุงูุชุชุจุน ูุงูุฅุดุนุงุฑุงุช

### 1. ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงูุฐูู ๐ฑ

#### ุฃููุงุน ุงูุฅุดุนุงุฑุงุช:
- **ุฅุดุนุงุฑุงุช ุฏุงุฎู ุงูุชุทุจูู** - ุนุจุฑ Socket.IO
- **ุฅุดุนุงุฑุงุช ุงูุฏูุน** - ุนุจุฑ Expo Push Notifications
- **ุชุฎุฒูู ูู ุณุฌู ุงููุณุชุฎุฏู** - `user.notificationsFeed`

#### ุขููุฉ ุงูุฅุดุนุงุฑุงุช:
```typescript
// ูู src/services/order.notify.ts
export async function notifyOrder(
  event: OrderEvent,
  order: any,
  extra?: Record<string, any>
) {
  // 1. ุจุซ ุฏุงุฎู ุงูุชุทุจูู
  io.to(`user_${order.user.toString()}`).emit("notification", data);

  // 2. ุงุญุชุฑุงู ุชูุถููุงุช ุงููุณุชุฎุฏู
  const prefs = await NotificationPreference.findOne({ userId });

  // 3. ุฅุฑุณุงู ุฏูุน ุฎุงุฑุฌู
  await sendToUsers([order.user.toString()], notificationData);

  // 4. ุชุฎุฒูู ูู ุณุฌู ุงููุณุชุฎุฏู
  user.notificationsFeed.unshift(notificationData);
}
```

### 2. ูุธุงู ุงูุจุซ ุงููุญุธู (Socket Events) โก

#### ุบุฑู ุงูุจุซ:
- **`user_${userId}`** - ุบุฑูุฉ ุงููุณุชุฎุฏู ุงูุฎุงุตุฉ
- **`order_${orderId}`** - ุบุฑูุฉ ุงูุทูุจ ุงููุญุฏุฏ
- **`orders_admin`** - ุบุฑูุฉ ุงููุดุฑููู

#### ุฃุญุฏุงุซ ุงูุจุซ:
```typescript
// ูู src/sockets/orderEvents.ts
export function broadcastOrder(event: OrderEvent, orderId: string, payload: any) {
  emitToAdmin(event, { orderId, ...payload });      // ูููุดุฑููู
  emitToOrder(orderId, event, payload);             // ููุทูุจ ุงููุญุฏุฏ
}
```

## ูุธุงู ุงููุนุงููุงุช ุงููุงููุฉ ููุทูุจุงุช

### 1. ุงูุชุฏูู ุงููุงูู ุงูุฃุณุงุณู ๐ฐ

#### ุขููุฉ ุงูุฏูุน:
1. **ุญุฌุฒ ุงููุจูุบ** - `holdForOrder()` ุนูุฏ ุงูุฅูุดุงุก
2. **ุฎุตู ุงููุจูุบ** - `captureOrder()` ุนูุฏ ุงูุชุณููู
3. **ุฅุฑุฌุงุน ุงููุจูุบ** - `releaseOrder()` ุนูุฏ ุงูุฅูุบุงุก

#### ุทุฑู ุงูุฏูุน ุงููุฏุนููุฉ:
- **ุงููุญูุธุฉ** - `paymentMethod: "wallet"`
- **ุงูุจุทุงูุฉ** - `paymentMethod: "card"`
- **ุงูููุฏ** - `paymentMethod: "cash"`
- **ูุฎุชูุท** - `paymentMethod: "mixed"`

### 2. ูุธุงู ุงูุชุณููุงุช ุงููุงููุฉ ๐

#### ุขููุฉ ุงูุชุณููุฉ:
1. **ุญุณุงุจ ุงูุนูููุงุช** - `calculateCommission()`
2. **ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ** - `postOrderDelivered()`
3. **ุชุณููุฉ ุงูุฃุฑุจุงุญ** - `generateSettlement()`

#### ุงูุชุฏูู ุงููุงูู ููุฃุทุฑุงู:
- **ุงูุนููู** โ ูุฏูุน ุงููุจูุบ ุงููุงูู
- **ุงูููุตุฉ** โ ุชุฃุฎุฐ ุนูููุชูุง (`companyShare`)
- **ุงูุชุงุฌุฑ** โ ูุญุตู ุนูู ุตุงูู ุงููุจูุบ (`storeNet`)
- **ุงูุณุงุฆู** โ ูุญุตู ุนูู ุฑุณูู ุงูุชูุตูู (`deliveryFee`)

## ูุธุงู ุงูููุงุญุธุงุช ูุงูุชูุงุตู

### 1. ูุธุงู ุงูููุงุญุธุงุช ุงููุชุนุฏุฏุฉ ๐

#### ูููู ุงูููุงุญุธุฉ:
```typescript
export interface INote {
  body: string;                           // ูุต ุงูููุงุญุธุฉ
  visibility: "public" | "internal";      // ุงูุฑุคูุฉ
  byRole: "customer" | "admin" | "store" | "driver" | "system";
  byId?: Types.ObjectId;                  // ูุนุฑู ูุงุชุจ ุงูููุงุญุธุฉ
  createdAt: Date;                       // ููุช ุงูุฅูุดุงุก
}
```

#### ุขููุฉ ุงูููุงุญุธุงุช:
- **ููุงุญุธุงุช ุนุงูุฉ** - ุชุธูุฑ ููุนููู
- **ููุงุญุธุงุช ุฏุงุฎููุฉ** - ููุฅุฏุงุฑุฉ ููุท
- **ุฑุจุท ุจุงูุฃุทุฑุงู** - ูุนุฑู ูุงุชุจ ุงูููุงุญุธุฉ

### 2. ูุธุงู ุชุงุฑูุฎ ุงูุญุงูุงุช ๐

#### ูููู ุชุงุฑูุฎ ุงูุญุงูุฉ:
```typescript
interface IStatusHistoryEntry {
  status: string;                    // ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ
  changedAt: Date;                   // ููุช ุงูุชุบููุฑ
  changedBy: "admin" | "store" | "driver" | "customer"; // ูู ุบูุฑ ุงูุญุงูุฉ
}
```

#### ุขููุฉ ุงูุชุชุจุน:
- **ุชุณุฌูู ูู ุชุบููุฑ** ูู ุงูุญุงูุฉ
- **ุชุชุจุน ุงููุณุคูู** ุนู ุงูุชุบููุฑ
- **ุชูููุช ุฏููู** ููู ุชุบููุฑ

## ุงูุชุนุงุฑุถุงุช ูุงููุดุงูู ุงูููุชุดูุฉ

### 1. ุชุนุงุฑุถ ูู ูุธุงู ุงูุทูุจุงุช ุงููุฑุนูุฉ ๐ด ุญุฑุฌ

**ุงููุดููุฉ:**
- ูุธุงู `subOrders` ูุนูุฏ ููุญุชูู ุนูู ููุทู ููุฑุฑ
- ุชุถุงุฑุจ ูู ุญุงูุงุช ุงูุทูุจ ุงูุฑุฆูุณูุฉ ูุงููุฑุนูุฉ
- ุตุนูุจุฉ ูู ุชุชุจุน ุญุงูุฉ ุงูุทูุจ ุงูููู

**ุงูุชุฃุซูุฑ:**
- ุชุนููุฏ ูู ุฅุฏุงุฑุฉ ุงูุทูุจุงุช ูุชุนุฏุฏุฉ ุงููุชุงุฌุฑ
- ุตุนูุจุฉ ูู ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช
- ูุฎุงุทุฑ ูู ุงูุชุณููู ูุงูุชูููู

### 2. ุชุนุงุฑุถ ูู ูุธุงู ุงููุนุงููุงุช ุงููุงููุฉ ๐ด ุญุฑุฌ

**ุงููุดููุฉ:**
- ูุธุงู ุญุฌุฒ/ุฅูุฑุงุฌ ูููุตู ุนู ูุธุงู Wallet_V8
- ุชุถุงุนู ูู ุชุณุฌูู ุงููุนุงููุงุช ุงููุงููุฉ
- ุนุฏู ุชูุญูุฏ ูู ุทุฑู ุงูุฏูุน

**ุงูุชุฃุซูุฑ:**
- ุตุนูุจุฉ ูู ุงููุทุงุจูุฉ ุงููุงููุฉ
- ูุฎุงุทุฑ ูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ
- ุชุถุงุฑุจ ูู ุฃุฑุตุฏุฉ ุงููุญุงูุธ

### 3. ุชุนุงุฑุถ ูู ูุธุงู ุงูุชููููุงุช ๐ก ูุชูุณุท

**ุงููุดููุฉ:**
- ูุธุงู ุชูููู ูุงุญุฏ ููุท ููุทูุจ ุงููุงูู
- ุนุฏู ูุฌูุฏ ุชูููู ูููุตู ููู ูุชุฌุฑ ูู ุงูุทูุจุงุช ุงููุฑุนูุฉ
- ุนุฏู ูุฌูุฏ ูุธุงู ููุงูุขุช ุจูุงุกู ุนูู ุงูุชููููุงุช

## ุญููู ููุชุฑุญุฉ ูุชุญุณูู ุฏูุฑุฉ ุงูุญูุงุฉ

### 1. ูุธุงู ุทูุจุงุช ููุญุฏ ููุจุณุท

```typescript
// ูุธุงู ุทูุจ ููุญุฏ ูุฏุนู ููุง ุงูููุนูู
export interface IUnifiedOrder extends Document {
  // ุงููููุฉ ูุงูุฃุทุฑุงู
  user_id: Types.ObjectId;
  driver_id?: Types.ObjectId;
  store_ids: Types.ObjectId[];           // ูุชุงุฌุฑ ูุชุนุฏุฏุฉ

  // ููุน ุงูุทูุจ
  order_type: 'marketplace' | 'errand' | 'utility';

  // ุงูุญุงูุฉ ุงูููุญุฏุฉ
  status: 'created' | 'confirmed' | 'preparing' | 'ready' | 'picked_up' | 'delivered' | 'cancelled';

  // ูุธุงู ุงูุญุงูุงุช ุงููุฑุนูุฉ ูููุชุงุฌุฑ ุงููุชุนุฏุฏุฉ
  store_statuses: {
    store_id: Types.ObjectId;
    status: string;
    driver_id?: Types.ObjectId;
    delivered_at?: Date;
  }[];

  // ุงููุนูููุงุช ุงููุงููุฉ ุงูููุญุฏุฉ
  financial_info: {
    total_amount: number;
    delivery_fee: number;
    platform_commission: number;
    store_payments: { store_id: Types.ObjectId, amount: number }[];
    wallet_used: number;
    cash_due: number;
  };

  // ูุธุงู ุงูุชุชุจุน ุงูููุญุฏ
  tracking: {
    created_at: Date;
    confirmed_at?: Date;
    preparing_started_at?: Date;
    ready_at?: Date;
    picked_up_at?: Date;
    delivered_at?: Date;
    cancelled_at?: Date;
  };

  // ูุธุงู ุงูุชููููุงุช ุงูููุญุฏ
  ratings: {
    overall_rating?: number;
    store_ratings?: { store_id: Types.ObjectId, rating: number }[];
    driver_rating?: number;
  };
}
```

### 2. ูุธุงู ุญุงูุงุช ูุจุณุท ููุฑู

```typescript
// ูุธุงู ุญุงูุงุช ูุจุณุท ููุฑู
export type UnifiedOrderStatus =
  | 'created'      // ุชู ุฅูุดุงุก ุงูุทูุจ
  | 'confirmed'    // ุชู ุชุฃููุฏ ุงูุทูุจ
  | 'preparing'    // ููุฏ ุงูุชุฌููุฒ
  | 'ready'        // ุฌุงูุฒ ููุชุณููู
  | 'picked_up'    // ุชู ุงุณุชูุงู ุงูุณุงุฆู ููุทูุจ
  | 'delivered'    // ุชู ุงูุชุณููู
  | 'cancelled';   // ุชู ุงูุฅูุบุงุก

// ูุตูููุฉ ุงูุชูุงูุงุช ูุจุณุทุฉ
export const UNIFIED_TRANSITIONS: Record<UnifiedOrderStatus, UnifiedOrderStatus[]> = {
  created: ['confirmed', 'cancelled'],
  confirmed: ['preparing', 'cancelled'],
  preparing: ['ready', 'cancelled'],
  ready: ['picked_up', 'cancelled'],
  picked_up: ['delivered'],
  delivered: [], // ููุงุฆู
  cancelled: []  // ููุงุฆู
};
```

### 3. ูุธุงู ุฅุดุนุงุฑุงุช ููุญุฏ ูุฐูู

```typescript
// ูุธุงู ุฅุดุนุงุฑุงุช ูุชูุฏู ูุน ููุงูุจ ุฐููุฉ
export class UnifiedNotificationSystem {
  static async sendOrderNotification(
    orderId: string,
    event: OrderEvent,
    recipients: NotificationRecipient[],
    templateData: any
  ) {
    // 1. ุชุญุฏูุฏ ุงููุณุชูููู ุญุณุจ ุงูุฏูุฑ ูุงูุนูุงูุฉ ุจุงูุทูุจ
    const targetRecipients = await this.determineRecipients(orderId, recipients);

    // 2. ุฅูุดุงุก ูุญุชูู ุงูุฅุดุนุงุฑ ุญุณุจ ุงููุบุฉ ูุงูุณูุงู
    const notifications = await this.generateNotifications(event, templateData, targetRecipients);

    // 3. ุฅุฑุณุงู ุนุจุฑ ุงููููุงุช ุงูููุงุณุจุฉ
    await this.deliverNotifications(notifications);

    // 4. ุชุฎุฒูู ูู ุณุฌูุงุช ูู ูุณุชูู
    await this.storeNotifications(notifications);
  }
}
```

## ูุคุดุฑุงุช ุงููุฌุงุญ ุจุนุฏ ุงูุชุญุณูู

- โ ุชุจุณูุท ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุจูุณุจุฉ 70%
- โ ุชูููู ุนุฏุฏ ุงูุญุงูุงุช ูู 13 ุฅูู 7 ุญุงูุงุช ุฃุณุงุณูุฉ
- โ ุชูุญูุฏ ูุธุงู ุงูุชููููุงุช ูุงูุฅุดุนุงุฑุงุช ุจูุณุจุฉ 100%
- โ ุชุญุณูู ุฏูุฉ ุงูุชุชุจุน ุงููุงูู ุจูุณุจุฉ 90%
- โ ุชูููู ููุช ูุนุงูุฌุฉ ุงูุทูุจุงุช ุจูุณุจุฉ 50%
- โ ุชุญุณูู ุชุฌุฑุจุฉ ุฌููุน ุงูุฃุทุฑุงู (ุนูููุ ุชุงุฌุฑุ ุณุงุฆู)

## ุงูุชูุตูุงุช ุงูููุงุฆูุฉ

### ุงูุฃููููุฉ: ููุฑูุฉ ูุญุฑุฌุฉ
ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ุงูุญุงููุฉ ุชุนุงูู ูู ุชุนููุฏ ุดุฏูุฏ ูุชุนุงุฑุถุงุช ุฎุทูุฑุฉ ูู:
- ูุธุงู ุงูุญุงูุงุช ุงูู 13 ุงููุนูุฏ
- ูุธุงู ุงูุทูุจุงุช ุงููุฑุนูุฉ ุงูููุฑุฑ
- ูุธุงู ุงููุนุงููุงุช ุงููุงููุฉ ุงููุฒุฏูุฌ

### ุงูุงุณุชุซูุงุฑ ุงููุทููุจ:
- **ุงูููุช:** 8-10 ุฃุณุงุจูุน ูู ุงูุชุทููุฑ ุงููุชูุงุตู
- **ุงูููุงุฑุฏ:** ูุฑูู ูู 3-4 ูุทูุฑูู (ุชููู + ุชุฌุฑุจุฉ ูุณุชุฎุฏู + ูุงูู)
- **ุงูุชูููุฉ:** ุนุงููุฉ (ุฅุนุงุฏุฉ ููููุฉ ุดุงููุฉ ูููุธุงู)

### ุงูููุงุฆุฏ ุงููุชููุนุฉ:
- ุฏูุฑุฉ ุญูุงุฉ ุทูุจ ูุจุณุทุฉ ููุนุงูุฉ ุจูุณุจุฉ 100%
- ุชุญุณูู ุชุฌุฑุจุฉ ุฌููุน ุงูุฃุทุฑุงู ุจูุณุจุฉ 80%
- ุชูููู ููุช ูุนุงูุฌุฉ ุงูุทูุจุงุช ุจูุณุจุฉ 50%
- ุชุจุณูุท ุงูุตูุงูุฉ ูุงูุชุทููุฑ ุงููุณุชูุจูู

### ุงููุฎุงุทุฑ ุฅุฐุง ูู ูุชู ุงูุฅุตูุงุญ:
- ุงุณุชูุฑุงุฑ ุงูุชุนููุฏ ูู ุฅุฏุงุฑุฉ ุงูุทูุจุงุช
- ุตุนูุจุฉ ูู ุงูุชูุณุน ูุงูุชุทููุฑ
- ููุฏุงู ุงูุซูุฉ ูู ุงูุนููุงุก ูุงูุดุฑูุงุก
- ูุดุงูู ูู ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช

---
*ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุจูุงุกู ุนูู ุชุญููู ุดุงูู ูุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ ูู ุงูุชุงุฑูุฎ: $(date)*
*ุฅุตุฏุงุฑ ุงูุชูุฑูุฑ: 1.0.0*
